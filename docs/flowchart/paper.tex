\documentclass[11pt]{article} 

\tolerance=600

\usepackage{amsmath,color,longtable}

% Margins
\usepackage[lmargin=0.5in,rmargin=1.5in,tmargin=1.0in,bmargin=1.0in]{geometry}

\newcommand{\rhozero}{\rho_0}
\newcommand{\pizero}{\pi_0}
\newcommand{\pizeroone}{\pi_0^{(1)}}
\newcommand{\pizerotwo}{\pi_0^{(2)}}
\newcommand{\gammabar}{\overline{\Gamma}_1}

\newcommand{\nablab}{\mathbf{\nabla}}
\newcommand{\cdotb}{\mathbf{\cdot}}

\newcommand{\sfrac}[2]{\mathchoice
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
   \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}}
  {#1\!/#2}}

\newcommand{\half}{\sfrac{1}{2}}
\newcommand{\myhalf}{\sfrac{1}{2}}
\newcommand{\nph}{{n + \myhalf}}
\newcommand{\nmh}{{n - \myhalf}}

\newcommand{\Hext}{{H_{\rm ext}}}
\newcommand{\Hnuc}{{H_{\rm nuc}}}
\newcommand{\kth}{k_{\rm th}}

\newcommand{\Sbar}{\overline{S}}

\newcommand{\inp}{\mathrm{in}}
\newcommand{\initp}{\mathrm{init}}
\newcommand{\outp}{\mathrm{out}}

\newcommand{\uadv}{\widetilde{\mathbf{U}}^{\mathrm{ADV}}}
\newcommand{\uadvone}{\widetilde{\mathbf{U}}^{\mathrm{ADV},\star}}
\newcommand{\uadvtwo}{\widetilde{\mathbf{U}}^{\mathrm{ADV}}}
\newcommand{\V}{\mathbf{V}}
\newcommand{\dt}{\Delta t}
\newcommand{\dr}{\Delta r}

\newcommand{\etarho}{\eta_{\rho}}

\newcommand{\ubold}{\mathbf{U}}
\newcommand{\ut}{\widetilde{\ubold}}

\newcommand{\omegadot}{\dot{\omega}}
\newcommand{\er}{\mathbf{e}_r}


\setlength{\marginparwidth}{1.0in}
\newcommand{\MarginPar}[1]{\marginpar{%
\vskip-\baselineskip %raise the marginpar a bit
\raggedright\tiny\sffamily
\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\title{Flowchart of Current Algorithm}

\begin{document}

\maketitle
\tableofcontents
\cleardoublepage


\section{Current Algorithm}

Here we outline the algorithm currently implemented in the code.  Our
starting point for this description are the series of papers describing
the development of the algorithm:
\begin{itemize}
\item {\em Low Mach Number Modeling of Type Ia
  Supernovae. I. Hydrodynamics}, A.~S.~Almgren, J.~B.~Bell, 
  C.~A.~Rendleman, \& M.~Zingale 2006, ApJ, 637, 922 (henceforth
  paper~I)
\item {\em Low Mach Number Modeling of Type Ia Supernovae. II. Energy
  Evolution} A.~S.~Almgren, J.~B.~Bell, C.~A.~Rendleman, \& M.~Zingale
  2006, ApJ, 649, 927 (henceforth paper~II)
\item {\em Low Mach Number Modeling of Type Ia Supernovae. III. Reactions}
A.~S.~Almgren, J.~B.~Bell, A.~Nonaka, \& M.~Zingale
  2008, ApJ, 684, 449 (henceforth paper~III)
\item {\em Low Mach Number Modeling of Type Ia Supernovae. IV. White Dwarf Convection}
A.~S.~Almgren, J.~B.~Bell, A.~Nonaka, \& M.~Zingale,
  in perparation (henceforth paper~IV)
\end{itemize}

%-----------------------------------------------------------------------------
% Notation
%-----------------------------------------------------------------------------

\subsection{Notation}


%%%%%%%%%%%%%%%%
% symbol table
%%%%%%%%%%%%%%%%

\renewcommand{\arraystretch}{1.5}
%
\begin{center}
\begin{longtable}{|l|p{4.0in}|l|}
\caption[definition of symbols.]{definition of symbols.} \label{table:sym} \\
%
\hline \multicolumn{1}{|c|}{\textbf{symbol}} & 
       \multicolumn{1}{ c|}{\textbf{meaning}} & 
       \multicolumn{1}{ c|}{\textbf{units}} \\ \hline 
\endfirsthead

\multicolumn{3}{c}%
{{\tablename\ \thetable{}---continued}} \\
\hline \multicolumn{1}{|c|}{\textbf{symbol}} & 
       \multicolumn{1}{ c|}{\textbf{meaning}} & 
       \multicolumn{1}{ c|}{\textbf{units}} \\ \hline 
\endhead

\multicolumn{3}{|r|}{{\em continued on next page}} \\ \hline
\endfoot

\hline 
\endlastfoot

$c_p$   & specific heat at constant pressure
          ($c_p \equiv \left . \partial h / \partial T \right |_{p,X_k}$)
        & erg~g$^{-1}$~K$^{-1}$ \\
\hline
$f$     & volume discrepancy factor ($0 \le f \le 1$) & -- \\
\hline
$g$     & gravitational acceleration                 & cm~s$^{-2}$ \\
\hline
$h$     & specific enthalpy                          & erg~g$^{-1}$ \\
\hline
$\Hext$ & external heating energy generation rate    & erg~g$^{-1}$~s$^{-1}$ \\
\hline
$\Hnuc$ & nuclear energy generation rate             & erg~g$^{-1}$~s$^{-1}$ \\
\hline
$h_p$   & $h_p \equiv \left . \partial h / \partial p \right |_{T,X_k}$ & cm$^{3}$~g$^{-1}$ \\
\hline
$\kth$  & thermal conductivity                       & erg~cm$^{-1}$~s$^{-1}$~K$^{-1}$ \\
\hline
$p_0$   & base state pressure                        & erg~cm$^{-3}$ \\
\hline
$p_T$   & $p_T \equiv \left . \partial p / \partial T \right |_{\rho,X_k}$ & erg~cm$^{-3}$~K$^{-1}$ \\
\hline
$p_{X_k}$ & $p_{X_k} \equiv \left . \partial p / \partial X_k \right |_{p,T,X_{j,j\ne k}}$ & erg~cm$^{-3}$ \\
\hline
$p_\rho$ & $p_\rho \equiv \left . \partial p / \partial \rho \right |_{T,X_k}$ & erg~g$^{-1}$ \\
\hline
$q_k$   & specific nuclear binding energy            & erg~g$^{-1}$  \\
\hline
$r$     & radial coordinate (direction of gravity)   & cm \\
\hline
$s$     & specific entropy                           & erg~g$^{-1}$~K$^{-1}$ \\
\hline
$S$     & source term to the divergence constraint   & s$^{-1}$ \\
\hline
$t$     & time                                       & s \\
\hline
$T$     & temperature                                & K \\
\hline
$\ubold$     & total velocity ($\ubold = \ut + w_0 \er$) & cm~s$^{-1}$ \\
\hline
$\ut$   & local velocity                             & cm~s$^{-1}$ \\
\hline
$\uadv$ & advective velocity (edge-centered)         & cm~s$^{-1}$ \\
\hline
$w_0$   & base state expansion velocity              & cm~s$^{-1}$ \\
\hline
$X_k$   & mass fraction of the species ($\sum_k X_k = 1$) & -- \\
\hline
$\beta_0$ & coefficient to velocity
            in velocity constraint equation  & g~cm$^{-3}$ \\
\hline
$\Gamma_1$ & first adiabatic exponent ($\Gamma_1 \equiv \left . d \log p/d \log \rho \right |_s$) & -- \\
\hline
$\etarho$ & $\etarho \equiv \overline{ (\rho' \ut \cdot \er)}$ & g~cm$^{-2}$~s$^{-1}$ \\
\hline
$\xi_k$ & $\xi_k \equiv \left . \partial h / \partial X_k \right |_{p,T,X_{j,j\ne k}}$ & erg~g$^{-1}$ \\
\hline 
$\pi$   & dynamic pressure & erg~cm$^{-3}$ \\
\hline
$\pizero$ & base state dynamic pressure & erg~cm$^{-3}$ \\
\hline
$\rho$  & mass density  & g~cm$^{-3}$ \\
\hline
$\rho_0$  & base state mass density  & g~cm$^{-3}$ \\
\hline
$\rho'$  & perturbational density ($\rho' = \rho - \rho_0$) & g~cm$^{-3}$ \\
\hline
$(\rho h)_0$ & base state enthalpy density & erg~cm$^{-3}$  \\
\hline
$(\rho h)'$ & perturbational enthalpy density 
              $ \left [(\rho h)' = \rho h - (\rho h)_0 \right ]$ & erg~cm$^{-3}$  \\
\hline
$\sigma$ & $\sigma \equiv p_T/(\rho c_p p_\rho)$ & erg$^{-1}$~g \\
\hline
$\psi$  & $\psi \equiv D_0 p_0/Dt$ & erg~cm$^{-3}$~s$^{-1}$ \\
\hline
$\omegadot_k$ & creation rate for species $k$ ($\omegadot_k \equiv DX_k/Dt$) & s$^{-1}$ \\
\end{longtable}
\end{center}
%
\renewcommand{\arraystretch}{1.0}


We make use of the following shorthand notations in outlining the algorithm:
\begin{enumerate}

\item For any quantity, $\phi,$ we define $\overline{\phi} = ${\bf Avg}$(\phi),$ 
the average over $\Omega_H,$ as
\begin{equation}
\overline{\phi}(r) 
= \frac{1}{\mathrm{A}(\Omega_H)}\int_{\Omega_H} \phi(r,{\bf x}) \; dA \enskip .
\end{equation}
here $\Omega_H$ is a layer at constant radius $r$.

For spherical problems, see Paper IV for details.

\item {\bf React State}$[\rho^{\inp},(\rho h)^{\inp},X_k^{\inp},T^{\inp}, (\rho\Hext)^{\inp}]\rightarrow [\rho^{\outp}, (\rho h)^{\outp}, X_k^{\outp}, T^{\outp}, (\rho \omegadot_k)^{\outp}, (\rho\Hnuc)^{\outp}]$ \\
is the process by which we evolve the species and enthalpy from 
$X_k^{\inp} \rightarrow X_k^{\outp}$ 
and $(\rho h)^{\inp} \rightarrow (\rho h)^{\outp}$ by solving the following 
system of equations over a time interval of  $\Delta t/2$,
\begin{eqnarray}
\frac{\partial X_k}{\partial t} &=& \omegadot_k\enskip,\\
\frac{\partial (\rho h)}{\partial t} &=& \rho \Hnuc + \rho \Hext\enskip .
\end{eqnarray}
  In particular, to evolve the species, we solve the system:
\begin{eqnarray}
\frac{dX_k}{dt} &=& \omegadot_k(\rho,X_k,T)\enskip, \\
\frac{dT}{dt} &=&\frac{1}{c_p} \left ( -\sum_k \xi_k  \omegadot_k  + \Hnuc \right )
\enskip. \label{eq:reacttemp}
\end{eqnarray}
using the stiff ordinary differential equation integration methods
provided by the {\tt VODE} package (cite VODE).  The absolute error
tolerances are set to $10^{-12}$ for the species, and a relative
tolerance of $10^{-5}$ is used for the temperature.  The integration
yields the new values of the mass fractions, $X_k^{\outp}$.  Equation
(\ref{eq:reacttemp}) is derived from the full temperature evolution equation
\begin{equation}
\label{eq:tempenthalpy}
\frac{DT}{Dt} = \frac{1}{\rho c_p} \left[ \left(1 - \rho h_p\right) \frac{D p}{D t}
 - \sum_k \rho \xi_k {\omegadot}_k 
 + \rho \Hnuc + \rho \Hext \right] \enskip , 
\end{equation}
(paper III; eq.~[8])
by assuming that the pressure is constant during the burn state.  In
evolving these equations, we need to evaluate $c_p$ and $\xi_k$.  In
theory, this means evaluating the equation of state for each
right-hand side evaluation that {\tt VODE} requires.  In practice, we
freeze $c_p$ and $\xi_k$ at the start of the integration time step and
compute them using $\rho^{\inp}, X_k^{\inp},$ and $T^{\inp}$ as inputs
to the equation of state.  We note that while temperature is evolved
when solving these equations, we do not keep the final temperature,
nor do we use it to compute the final change in enthalpy.  Therefore,
$T^{\outp} = T^{\inp}$.  Also, note that the density remains unchanged
during the {\bf React State} step, i.e., $\rho^{\outp} = \rho^{\inp}$.

After the new mass fractions have been computed, the reaction rates are defined as:
\begin{equation}
(\rho\omegadot_k)^{\outp} = \frac{\rho^{\outp} ( X_k^{\outp} - X_k^{\inp})}{\Delta t /2} \enskip,
\end{equation}
and the nuclear energy generation rate is defined as
\begin{equation}
(\rho\Hnuc) = -\sum_k(\rho\omegadot_k)^{\outp} \; q_k \enskip.
\end{equation}
for the case where only strong-mediated reactions are involved.  As
$\Hnuc$ is an output of the reaction network, more general networks
(i.e.\ involving weak interactions) can easily be added.  The enthalpy
update incorporates the external heating, $(\rho\Hext)^{\inp}$, and is
updated by
\begin{equation}
(\rho h)^{\outp} = 
(\rho h)^{\inp} + \frac{\dt}{2} (\rho\Hnuc) + \frac{\dt}{2} (\rho\Hext)^{\inp}\enskip.
\end{equation}

\item {\bf React Base}$[(\rho h)_0^{\inp},(\overline{\rho\Hnuc})^{\inp},(\overline{\rho\Hext})^{\inp}] \rightarrow [(\rho h)_0^{\outp}]$\\
is the process by which we update the base state enthalpy through $\dt/2$ in time using
\begin{equation}
\frac{\partial(\rho h)_0}{\partial t} = (\overline{\rho\Hnuc})^{\inp} + (\overline{\rho\Hext})^{\inp}\enskip ,
\end{equation}
discretized as
\begin{equation}
(\rho h)_{0,j}^{\outp} = (\rho h)_{0,j}^{\inp} + \frac{\dt}{2}(\overline{\rho\Hnuc})_{j}^{\inp} + \frac{\dt}{2}(\overline{\rho\Hext})_{j}^{\inp} \enskip .
\end{equation}

\item {\bf Advect Base}$[\rho_0^{\inp}, (\rho h)_0^{\inp}, p_0^{\inp}, \beta_0^{\inp}, w_0^{\inp}, \psi^{\inp}] \rightarrow [\rho_0^{\outp}, \rho_0^{\outp,n+\myhalf}, p_0^{\outp}]$ \\
is the process by which we update the base state through $\dt$ in
time \MarginPar{we need a separate section for spherical} given the
radial velocity $w_0^{\inp}.$ The base state arrays are all
one-dimensional in the radial coordinate; we think of the base state
quantities as defined at cell centers, with $w_0$ and $\beta_0$
defined halfway in-between.

\begin{description}

\item[plane-parallel:] ~

\begin{enumerate}
\renewcommand{\labelenumii}{{\bf \alph{enumii}}.}

\item For the density update, we discretize equation the base state
  density evolution equation (paper III; eq.~[29]) without the $\etarho$ term,
\begin{eqnarray}
\frac{\partial \rhozero}{\partial t} &=& - \nablab \cdotb \left( \rhozero w_0 \er \right)
\enskip ,
\label{eq:rho0upd_new}
\end{eqnarray}
to compute the new base state density,
\begin{eqnarray}
\rho_{0,j}^{\outp} &=& \rho_{0,j}^{\inp} - \frac{\dt}{\dr} 
\left [ \left( {{\rho}_0}^{\outp,\nph} {w_0}^{\inp}\right)_{j+\myhalf} -  
         \left( {{\rho}_0}^{\outp,\nph} {w_0}^{\inp}\right)_{j-\myhalf} \right ]
         \nonumber \enskip,
\end{eqnarray}
where $j$ refers to the one-dimensional index in the radial direction.
The interface states, ${{\rho}_0}^{\outp,\nph}$, are found via the
procedure described in paper II, Appendix A, and are saved for use
later in the overall algorithm.

\item For the pressure update, we discretize the base state pressure
  evolution equation (paper III; eq.~[31]),
\begin{equation}
\frac{\partial p_0}{\partial t} = 
-w_0 \frac{\partial p_0}{\partial r} + \psi \enskip ,
\label{eq:p0upd_new}
\end{equation}
to compute the new base state pressure,
\begin{equation}
p_{0,j}^\outp = p_{0,j}^\inp - \frac{\dt}{2\dr} \left (w_{0,j+\myhalf}^\inp
+ w_{0,j-\myhalf}^\inp \right)
\left (p_{0,j+\myhalf}^{n+\myhalf} -p_{0,j-\myhalf}^{n+\myhalf} \right ) + \dt \; \psi_j^\inp 
\enskip,
\end{equation}
where the interface states are again found via the procedure described
in paper II, Appendix A.  Note that the $\psi$ term is not included in the forcing for
the interface state calculation, but is used in the update.

\item For the enthalpy update, we discretize
\begin{equation}
\frac{\partial (\rho h)_0}{\partial t} = -\nabla\cdot\left[(\rho h)_0w_0\er\right] + \psi \enskip ,
\end{equation}
to compute the new base state enthalpy,
\begin{equation}
(\rho h)_{0,j}^{\outp} = (\rho h)_{0,j}^{\inp} - \frac{\dt}{\Delta r}
\left\{ \left[ {(\rho h)_0}^{\outp,\nph} {w_0}^{\inp}\right]_{j+\myhalf} -  
         \left[ {(\rho h)_0}^{\outp,\nph} {w_0}^{\inp}\right]_{j-\myhalf} \right\}
+ \dt\psi_j^{\inp} \enskip ,
\end{equation}
where the interface states are again found via the procedure described
in paper II, Appendix A.  Note that the $\psi$ term is not included in 
the forcing for the interface state calculation, but is used in the update.

\end{enumerate}

\item[spherical:]

\MarginPar{we need to write the spherical description}

\end{description}

\item {\bf Correct Base}
$[\rho_0^{\inp}, (\nabla\cdot\etarho\er)^{\inp}] \rightarrow [\rho_0^{\outp}]$\\
is the process by which we adjust the base state density to account for
large-scale mixing, through $\etarho$.  For both plane-parallel and spherical
we use
\begin{equation}
\rho_{0,j}^{\outp} = \rho_{0,j}^{\inp} - \dt (\nabla\cdot\etarho\er)^{\inp}_j \enskip . 
\end{equation}

\end{enumerate}


%-----------------------------------------------------------------------------
% Time Advancement Algorithm
%-----------------------------------------------------------------------------

\subsection{Time Advancement Algorithm}

We now describe the full time advancement algorithm, making frequent
use of the shorthand developed above.  Here, we assume that the
problem is already properly initialized.  We describe the details of
the initialization in \S~\ref{Sec:Initialization}.

In paper III we discretized the enthalpy evolution equation in full, non-perturbation form.  
We have discovered that discretizing the enthalpy evolution in non-perturbational form 
leads to better numerical properties.  This is more like paper II.\\

%--------------------------------------------------------------------------
% STEP 1
%--------------------------------------------------------------------------

\begin{description}

\item[Step 1.] {\em Define the average expansion at time $t^\nph$ and the new $w_0.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item At the beginning of each time step, we need an estimate for the time-centered
source term in the velocity divergence constraint,
\begin{equation}
  S =  -\sigma  \sum_k  \xi_k \omegadot_k  + 
  \frac{1}{\rho p_\rho} \sum_k p_{X_k}  {\omegadot}_k  + \sigma \Hnuc + \sigma \Hext \enskip ,
\label{eq:defineS} 
\end{equation}
(paper III; eq.~[19]).

If this is the first step of the calculation ($n=0$), we set
\begin{equation}
S^{\half,\star} = \frac{S^0 + S^1}{2} \enskip ,
\end{equation}
where $S^1$ is found through the iterative process that initializes the calculation.
Otherwise, following the method used in our small-scale low Mach number algorithm
(Cite Bell04), we extrapolate to the half-time using the source
terms at the previous and current time levels
\begin{equation}
S^{\nph,\star} = S^n + \frac{\Delta t^n}{2} \frac{S^n - S^{n-1}}{\Delta t^{n-1}} \enskip .
\end{equation}

\item Define
\begin{equation}
\overline{S}^{\nph,\star} = {\mathrm{\bf Avg}} \left(S^{\nph,\star}\right) \enskip .
\end{equation}

\item Construct $w_0^{\nph,\star}$

\begin{description}

\item[plane-parallel:] We integrate
\begin{equation}
\frac{\partial w_0}{\partial r} =  \Sbar - \frac{1}{\gammabar p_0} \etarho g 
\enskip \label{eq:divw0} ,
\end{equation}
using the lagged $\psi^{\nmh}$ and the volume discrepancy correction with $f=0.3$,
\begin{equation}
\frac{\partial w_0^{\nph,\star}}{\partial r} =  \overline{S}^{\nph,\star} 
- \frac{1}{\gammabar^{n} p_0^{n}}
\left\{ \psi^{\nmh} - 
f \left[\frac{p_0^n - \overline{p(\rho,h,X_k)^n}}{\Delta t^n} \right]\right\}
\enskip .
\end{equation}

\item[spherical:] See Paper IV for working notes until we finalize this.

\end{description}

\item Using 
\begin{equation}
- \frac{1}{\rho_0} \frac{\partial \pizero}{\partial r} 
= \frac{\partial w_0}{\partial t} + w_0 \frac{\partial w_0}{\partial r} 
\enskip, \label{eq:pizero}
\end{equation}
define the scaled pressure gradient
\begin{equation}
-\left ( \frac{1}{\rho_0^n} \frac{\partial \pizeroone}{\partial r} \right ) = 
\frac{w_0^{\nph,\star} - w_0^\nmh}{(\dt^n+\dt^{n-1})/2} 
+  w_0^{n,\star} \left(\frac{\partial w_0}{\partial r}\right)^{n,\star} \enskip ,
\end{equation} 
where $w_0^{n,\star}$ and $(\partial w_0 / \partial r)^{n,\star}$ are
\begin{equation}
w_0^{n,\star} = \frac{\dt^{n} w_0^{\nmh} + \dt^{n-1} w_0^{\nph,\star}}{\dt^n+\dt^{n-1}} 
\enskip,\end{equation}
\begin{equation}
\left(\frac{\partial w_0}{\partial r}\right)^{n,\star} = 
\frac{1}{\dt^n+\dt^{n-1} } 
\left [ \dt^{n} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nmh}
+ \dt^{n-1} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nph,\star} \right ] 
\enskip.\end{equation}
If $n=0$, we use $\dt^{-1} = \dt^0$.

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 2
%--------------------------------------------------------------------------
\item[Step 2.] {\em Construct the provisional edge-based advective velocity}, $\uadvone$.\\

The local velocity field is described by

The procedure to construct $\uadvone$ is described in detail in Appendix B of paper III.
We note that  $\uadvone$ satisfies the discrete versions of 
\begin{equation}
\int_{\Omega_H} \ut \cdotb \er \; dA = 0 \label{eq:udoterzero} \enskip ,
\end{equation}
(paper III; eq.~[21])
and
\begin{equation}
\nablab \cdotb (\beta_0 \ut )  = \beta_0 \left(S - \Sbar \right )\enskip ,
\label{eq:tildeconstraint}
\end{equation}
(paper III; eq.~[39]).  The discretization with the volume discrepancy correction is
\begin{equation}
\nablab \cdotb \left(\beta_0^n \uadvone\right) = 
\beta_0^n \left(S^{\nph,\star} - \overline{S}^{\nph,\star}\right)
+ \frac{f}{\gammabar^n p_0^n}
\left[\frac{p(\rho,h,X_k)^n - \overline{p(\rho,h,X_k)^n}}{\Delta t^n}\right] \enskip .
\end{equation}

%--------------------------------------------------------------------------
% STEP 3
%--------------------------------------------------------------------------
\item[Step 3.] {\em React the full state and base state through the first time 
interval of $\dt / 2.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf React State}$[\rho^n, (\rho h)^n, X_k^n, T^n, (\rho\Hext)^n]
                   \rightarrow$ $[ \rho^{(1)}, (\rho h)^{(1)}, X_k^{(1)}, T^{(1)},
                                  (\rho \omegadot_k)^{(1)}, (\rho \Hnuc)^{(1)} ].$  

\item {\bf React Base}$[(\rho h)_0^n,(\overline{\rho \Hnuc})^{(1)},(\overline{\rho\Hext})^n] \rightarrow [(\rho h)_0^{(1)}]$

\item
Define
\begin{eqnarray}
\gammabar^{(1)}        &=& {\rm{\bf Avg}} \left[ \Gamma_1(\rho^{(1)}, p_0^{n}, X_k^{(1)}) \right] \enskip , \\
 {\beta   }_0^{(1)}    &=& \beta   \left(\rho_0^{n}, p_0^{n}, \gammabar^{(1)}\right) \enskip .
\end{eqnarray}

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 4
%--------------------------------------------------------------------------
\item[Step 4.] {\em Advect the base state, then the full state, through a time interval 
of $\dt.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf Advect Base}$[\rhozero^{n}, (\rho h)_0^{(1)}, p_0^{n}, \beta_0^{(1)}, w_0^{\nph,\star}, \psi^{\nmh}] \rightarrow $
$[\rho_0^{(2),\star}, (\rho h)_0^{(2),\star}, \rho_0^{\nph,\star,{\rm pred}}, p_0^{n+1,\star}].$ 

\item Update the species.  Here we do a difference approximation
  to 
  \begin{equation}
  \frac{\partial (\rho X_k)}{\partial t} + \nablab \cdotb (\ubold \rho X_k) =
         \rho {\omegadot}_k \enskip , \label{eq:species}
  \end{equation}
  neglecting the reaction terms.  The update consists of two steps:

  \begin{enumerate}
  \renewcommand{\labelenumii}{{\bf \roman{enumii}}.}

  \item Compute the species edge states, $(\rho X_k)^{(1),\nph,\star}$,
  for the conservative update of $(\rho X_k)$. 
  Here we predict $\rho'$ and $X_k$ to the edges to obtain 
  $\rho^{'(1),\nph,\star}$ and $X_k^{(1),\nph,\star}$ using a second-order
  Taylor expansion in space and time, as described in paper II,
  Appendix A, using $\V = \uadvone+w_0^{\nph,\star} \er$.  We use the base
  state density, $\rho_0$, to convert this to an edge state for $\rho$,

\begin{equation}
\rho^{(1),\nph,\star} = 
\rho^{'(1),\nph,\star} + \frac{\rho_0^n + \rho_0^{(2),\star}}{2} \enskip ,
\end{equation}

  \item Evolve $(\rho X_k)^{(1)} \rightarrow (\rho X_k)^{(2),\star}$
  without explicitly including the reaction terms,
\begin{equation}
(\rho X_k)^{(2),\star} = (\rho X_k)^{(1)} 
 - \dt \; \left\{ \nablab \cdotb \left[ \left(\uadvone+w_0^{\nph,\star} \er\right)  
  (\rho X_k)^{(1),\nph,\star} \right] \right\} \enskip ,
\end{equation}
\begin{equation}
\rho^{(2),\star} = \sum_k (\rho X_k)^{(2),\star} \enskip ,
\end{equation}
\begin{equation}
X_k^{(2),\star} = (\rho X_k)^{(2),\star} / \rho^{(2),\star}
\end{equation}

\end{enumerate}

\item Define an edge-centered $\etarho^{\nph,\star}$, cell-centered 
$(\nabla\cdot\etarho\er)^{\nph,\star}$, and cell-centered $\psi_j^{\nph,\star}$:

\begin{description}
\item[plane-parallel:]~

\begin{equation}
 \etarho^{\nph,\star} =  {\rm {\bf Avg}} \sum_k \left[ \left(\uadvone \cdotb \er + w_0^{\nph,\star}\right) (\rho X_k)^{(1),\nph,\star} \right] - w_0^{\nph,\star} \rho_0^{\nph,\star,{\rm pred}} \enskip ,
\end{equation}
\begin{equation}
(\nabla\cdot\etarho\er)_j^{\nph,\star} = 
\frac{\eta_{\rho,j+\myhalf}^{\nph,\star}-\eta_{\rho,j-\myhalf}^{\nph,\star}}{\Delta r} \enskip ,
\end{equation}
\begin{equation}
 \psi_j^{\nph,\star} = \frac{1}{2} \left(\eta_{\rho,j-\myhalf}^{\nph,\star} + \eta_{\rho,j+\myhalf}^{\nph,\star}\right) g \enskip .
\end{equation}

\item[spherical:] See {\tt MAESTO/docs/eta\_notes} for working notes until we finlize 
the details.

\end{description}

\item Update the enthalpy.  The full enthalpy equation is 
  \begin{equation}
  \frac{\partial (\rho h)}{\partial t}  = - \nablab \cdotb (\ubold \rho h)
+ \frac{Dp_0}{Dt} + \nabla\cdot\kth\nabla T + \rho \Hnuc + \rho \Hext 
\enskip , \label{eq:rhohupd} 
  \end{equation}
Here we consider only the advection, neglecting the reaction terms and thermal diffusion terms,
and solve a discretized version of
  \begin{equation}
  \frac{\partial (\rho h)}{\partial t}  = - \nablab \cdotb (\ubold \rho h)
+ \frac{Dp_0}{Dt} 
\enskip , \label{eq:rhohupdadv} 
  \end{equation}

  \begin{enumerate}
  \renewcommand{\labelenumii}{{\bf \roman{enumii}}.}

  \item Compute the enthalpy edge state, $(\rho h)^{(1),\nph,\star},$
    for the conservative update of $(\rho h).$  Here we predict $(\rho
    h)'$ to the edges to obtain $(\rho h)^{'(1),\nph,\star}$, 
    using a second-order Taylor expansion in space
    and time, as described in paper II, Appendix A, using $\V =
    \uadvone+w_0^{\nph,\star} \er$.  We do not include the reaction
    terms in the enthalpy prediction, since we accounted for them
    already in {\bf React State}.  We use the base state enthalpy,
    $(\rho h)_0$, to convert this to an edge state for $(\rho h)$,
    \MarginPar{in these notes we currently assume pred type 1, $(\rho h)'$}
\begin{equation}
(\rho h)^{(1),\nph,\star} = 
(\rho h)^{'(1),\nph,\star} + \frac{(\rho h)_0^n + (\rho h)_0^{(2),\star}}{2}
\enskip .
\end{equation}

  \item Evolve $(\rho h)^{(1)} \rightarrow (\rho h)^{(2'),\star}$ without
  explicitly including the reaction terms,
  \begin{eqnarray}
  (\rho h)^{(2'),\star} &=& (\rho h)^{(1)} - \dt \; \left\{ \nablab
      \cdotb \left[ \left(\uadvone+w_0^{\nph,\star} \er\right) (\rho
      h)^{(1),\nph,\star} \right] \right\} \nonumber \\ && + \dt \;
    \left(\uadvone \cdotb \er\right) \left(\frac{\partial
      p_0}{\partial r} \right)^{n} + \dt \; \psi^{\nph,*} \enskip ,
  \end{eqnarray}
  \MarginPar{we should also show the update in the case that $(\rho h)'$ is the flux}
  \end{enumerate}

\item {\bf Correct Base}
$[\rho_0^{(2),\star}, (\nabla\cdot\etarho\er)^{\nph,*}] \rightarrow [\rho_0^{n+1,\star}]$.


%--------------------------------------------------------------------------
% STEP 4.1
%--------------------------------------------------------------------------

\item Diffuse the enthalpy through a time interval of $\dt$.  Here we begin
with the enthalpy equation (eq.~[eq:rhohup]), but consider only the 
diffusion terms,
\begin{equation}
  \frac{\partial (\rho h)}{\partial t}  = 
 \nabla\cdot\kth\nabla T 
\enskip . \label{eq:rhohupdthermal} 
  \end{equation}
We can recast this as an enthalpy-diffusion equation by applying the
chain-rule to $h(p_0,T,X_k)$,
\begin{equation}
\nabla h = h_p \nabla p_0 + c_p \nabla T + \sum_k \xi_k \nabla X_k \enskip ,
\end{equation}
giving
\begin{equation}
  \frac{\partial (\rho h)}{\partial t}  = 
 \nabla\cdot \frac{\kth}{c_p}\nabla h -  
 \sum_k \nabla\cdot \frac{\xi_k \kth}{c_p}\nabla X_k -
 \nabla\cdot \frac{h_p \kth}{c_p}\nabla p_0 
\enskip . \label{eq:rhohupdthermal2} 
  \end{equation}


Compute $\kth^{(1)}, c_p^{(1)}$, and $\xi_k^{(1)}$ from $\rho^{(1)}, T^{(1)}$, and $X_k^{(1)}$ as inputs to the equation of state.  The update is given by
\begin{eqnarray}
(\rho h)^{(2),\star} &=& (\rho h)^{(2'),\star} + \frac{\dt}{2}\nabla\cdot\left(\frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(2),\star} + \frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(2),\star} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{(2),\star} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{(1)}\right),
\end{eqnarray}
which is numerically implemented as a diffusion equation for $h^{(2),\star}$,
\begin{eqnarray}
\left(\rho^{(2),\star} - \frac{\dt}{2}\nabla\cdot\frac{\kth^{(1)}}{c_p^{(1)}}\nabla\right)h^{(2),\star} &=& (\rho h)^{(2'),\star} + \frac{\dt}{2}\nabla\cdot\frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\nonumber\\
&&- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(2),\star} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{(2),\star} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{(1)}\right),
\end{eqnarray}
\item Update the temperature
\begin{equation}
T^{(2),\star} = T\left(\rho^{(2),\star}, h^{(2),\star}, X_k^{(2),\star}\right) {\hbox{ \rm using the equation of state.}}
\end{equation}

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 5
%--------------------------------------------------------------------------
\item[Step 5.] {\em React the full state through a second time interval of $\dt / 2.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf React State}$[ \rho^{(2),\star},(\rho h)^{(2),\star}, X_k^{(2),\star}, 
                             T^{(2),\star}, (\rho\Hext)^{(2),\star}] $\\
$\rightarrow [ \rho^{n+1,\star},(\rho h)^{n+1,\star}, X_k^{n+1,\star}, T^{n+1,\star}, 
              (\rho \omegadot_k)^{(2),\star}, (\rho \Hnuc)^{(2),\star} ].$  

\item Define
\begin{eqnarray}
 \gammabar^{n+1,\star}    &=& {\rm{\bf Avg}} \left[ \Gamma_1(\rho^{n+1,\star}, p_0^{n+1,\star}, 
                                                      X_k^{n+1,\star}) \right] \enskip , \\
 {\beta   }_0^{n+1,\star}    &=& \beta   \left(\rho_0^{n+1,\star}, p_0^{n+1,\star}, \gammabar^{n+1,\star}\right) \enskip .
\end{eqnarray}

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 6
%--------------------------------------------------------------------------
\item[Step 6.] {\em Define a new average expansion rate at time $t^\nph.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}
\item Define
\begin{equation}
  S^{n+1,\star} =  -\sigma  \sum_k  \xi_k  (\omegadot_k)^{(2),\star}  + 
  \sigma \Hnuc^{(2),\star} +
  \frac{1}{\rho p_\rho} \sum_k p_{X_k}  ({\omegadot}_k)^{(2),\star}  
  + \sigma \Hext \enskip .
\end{equation} 
where $(\omegadot_k)^{(2),\star} = (\rho \omegadot_k)^{(2),\star} / \rho^{(2),\star}$
and the remaining quantities are defined using $X_k^{n+1,\star},$ $\rho^{n+1,\star},$ 
and $T^{n+1,\star}$ from step 5.
Then define
\begin{equation}
 S^\nph = \frac{S^n + S^{n+1,\star}}{2} \enskip. 
\end{equation}

\item Define
\begin{equation}
\overline{S}^{\nph} = {\mathrm{\bf Avg}} (S^{\nph}) \enskip.
\end{equation}

\item Construct $w_0^{\nph}$

\begin{description}

\item[plane-parallel:] We integrate equation (\ref{eq:divw0}) with the 
volume discrepancy correction,
\begin{equation}
\frac{\partial w_0^{\nph}}{\partial r} = 
\overline{S}^{\nph,\star} - \frac{1}{\gammabar^{\nph,\star} p_0^{\nph,\star}}
\left\{ \psi^{\nph,\star} - f \left[\frac{p_0^{\nph,\star} - \overline{p(\rho,h,X_k)^{\nph,\star}}}{\Delta t^n}\right]\right\}
\enskip ,
\end{equation}
\begin{equation}
\gammabar^{\nph,\star} = \frac{\gammabar^{n} + \gammabar^{n+1,\star}}{2}
\end{equation}
\begin{equation}
p_0^{\nph,\star} = \frac{p_0^{n} + p_0^{n+1,\star}}{2}
\end{equation}
\begin{equation}
\overline{p(\rho,h,X_k)^{\nph,\star}} = 
\frac{\overline{p(\rho,h,X_k)^n} + \overline{p(\rho,h,X_k)^{n+1,\star}}}{2}
\end{equation}

\item[spherical:] See Paper IV for working notes until we finalize this.

\end{description}



\item Using equation (\ref{eq:pizero}), define
\begin{equation}
-\left ( \frac{1}{\rho_0^n} \frac{\partial \pizerotwo}{\partial r} \right ) = 
\frac{w_0^{\nph} - w_0^\nmh}{\myhalf(\dt^n+\dt^{n-1})} 
+ w_0^n \left(\frac{\partial w_0}{\partial r}\right)^n.
\end{equation}
where $w_0^n$ and $(\partial w_0 / \partial r)^{n}$ are defined through
\begin{equation}
w_0^{n,\star} = \frac{\dt^{n} w_0^{\nmh} + \dt^{n-1} w_0^{\nph,\star}}{\dt^n+\dt^{n-1}}\enskip,\label{eq:w0nstar}
\end{equation}
(paper III; eq.~[53]) and
\begin{equation}
\left(\frac{\partial w_0}{\partial r}\right)^{n,\star} = \frac{1}{\dt^n+\dt^{n-1} } \left [ \dt^{n} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nmh}
+ \dt^{n-1} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nph,\star} \right ] \enskip.\label{eq:dw0drnstar}
\end{equation}
(paper III; eq.~[54]).

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 7
%--------------------------------------------------------------------------
\item[Step 7.] {\em Construct the final edge-based advective velocity}, $\uadvtwo$.

The procedure to construct $\uadvtwo$ is described in detail in Appendix B of paper III
and is analogous to the procedure used in step 2, but with updated values
for $w_0$ and $\pizero.$  We note that $\uadvtwo$ satisfies the discrete versions of 
equations (\ref{eq:udoterzero}) and (\ref{eq:tildeconstraint}).   The discretization
with the volume discrepancy correction is
\begin{eqnarray}
\nablab \cdotb \left(\beta_0^{\nph,\star} \uadvtwo\right) &=& 
\beta_0^{\nph,\star} \left(S^{\nph} - \overline{S}^{\nph}\right) \nonumber \\
&& + \frac{f}{\gammabar^{\nph,\star} p_0^{\nph,\star}}
\left[\frac{p(\rho,h,X_k)^{\nph,\star} - \overline{p(\rho,h,X_k)^{\nph,\star}}}{\Delta t^n}\right]
\enskip , \nonumber \\
\end{eqnarray}
\begin{equation}
\beta_0^{\nph,\star} = \frac{ \beta_0^n +  \beta_0^{n+1,\star} }{2} \enskip .
\end{equation}

%--------------------------------------------------------------------------
% STEP 8
%--------------------------------------------------------------------------
\item[Step 8.] {\em Advect the base state, then the full state, through a time interval of $\dt.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf Advect Base}$(\rho_0^{n}, (\rho h)_0^{(1)}, p_0^{n}, \beta_0^{(1)}, w_0^{\nph}, \psi^{\nph,\star} ) \rightarrow $
$[\rho_0^{(2)}, (\rho h)_0^{(2)}, \rho_0^{\nph,{\rm pred}}, p_0^{n+1}].$ 

\item Update the species.  Here we do a difference approximation to
  eq.~\ref{eq:species}, neglecting the reaction terms.  The
  update consists of two steps:

  \begin{enumerate}
  \renewcommand{\labelenumii}{{\bf \roman{enumii}}.}

  \item Compute the species edge states, $(\rho X_k)^{(1),\nph}$, for
    the conservative update of $(\rho X_k)$.  Here we predict $\rho'$ 
    and $X_k$ to the edges to obtain $\rho^{'(1),\nph}$ and 
    $X_k^{(1),\nph}$ using a second-order Taylor expansion in
    space and time, as described in paper II, Appendix A, using $\V =
    \uadvtwo+w_0^{\nph} \er$.  We use the base
    state density, $\rho_0$, to convert this to an edge state for $\rho$,

\begin{equation}
\rho^{(1),\nph} = \rho^{'(1),\nph} + \frac{\rho_0^n + \rho_0^{(2)}}{2}\enskip ,
\end{equation}

    \item Evolve $(\rho X_k)^{(1)} \rightarrow (\rho X_k)^{(2)}$
      without explicitly including the reaction terms,
\begin{equation}
(\rho X_k)^{(2)} = (\rho X_k)^{(1)} 
- \dt \; \left\{ \nablab \cdotb \left[\left(\uadvtwo+w_0^{\nph} \er\right)  
(\rho X_k)^{(1),\nph} \right] \right\}  \enskip ,
\end{equation}
\begin{equation}
\rho^{(2)} = \sum_k (\rho X_k)^{(2)} \enskip ,
\end{equation}
\begin{equation}
X_k^{(2)} = (\rho X_k)^{(2)} / \rho^{(2)}
\end{equation}


   \end{enumerate}

\item Define an edge-centered $\etarho^{\nph}$, cell-centered 
$(\nabla\cdot\etarho\er)^{\nph}$, and a cell-centered $\psi_j^{\nph}$,

\begin{description}

\item[plane-parallel:] ~

\begin{equation}
 \etarho^{\nph} = {\rm {\bf Avg}} \sum_k \left [\left(\uadvtwo \cdotb \er + w_0^{\nph}\right) (\rho X_k)^{(1),\nph} \right] - w_0^{\nph} \rho_0^{\nph,{\rm pred}} \enskip ,
\end{equation}
\begin{equation}
(\nabla\cdot\etarho\er)_j^{\nph} = \frac{\eta_{\rho,j+\myhalf}^{\nph} - \eta_{\rho,j-\myhalf}^{\nph}}{\Delta r} \enskip , \\
\end{equation}
\begin{equation}
 \psi_j^{\nph} = \frac{1}{2} \left(\eta_{\rho,j-\myhalf}^{\nph} + \eta_{\rho,j+\myhalf}^{\nph}\right) g \enskip .
\end{equation}

\item[spherical:]~

\end{description}

\item Update the enthalpy, using a difference approximation to
  eq.~\ref{eq:rhohupd}, neglecting the reaction terms.

  \begin{enumerate}
  \renewcommand{\labelenumii}{{\bf \roman{enumii}}.}

  \item Compute the enthalpy edge state, $(\rho h)^{(1),\nph}$, for
    the conservative update of $(\rho h)$. Here we predict $(\rho h)'$
    to the edges to obtain $(\rho h)^{'(1),\nph}$, 
    using a second-order Taylor expansion in space and
    time, as described in paper II, Appendix A, using $\V =
    \uadvtwo+w_0^{\nph} \er$.  Again, we do not include the reaction
    terms in the enthalpy prediction since we accounted for them
    already in {\bf React State}. We use the base state enthalpy,
    $(\rho h)_0$, to convert these to edge states for $(\rho h)$,
\begin{equation}
(\rho h)^{(1),\nph} = 
(\rho h)^{'(1),\nph} + \frac{(\rho h)_0^n + (\rho h)_0^{(2)}}{2} \enskip .
\end{equation}

   \item Evolve $(\rho h)^{(1)} \rightarrow (\rho h)^{(2)}$ without
     explicitly including the reaction terms,
\begin{eqnarray}
(\rho h)^{(2')} &=& (\rho h)^{(1)} - \dt \; \left\{ \nablab \cdotb \left[ \left(\uadvtwo+w_0^{\nph} \er\right)  
(\rho h)^{(1),\nph} \right] \right\} \nonumber \\
&& + \frac{\dt}{2} \; \left(\uadvtwo \cdotb \er\right)
\left [ \left(\frac{\partial p_0}{\partial r} \right)^{n}
      + \left(\frac{\partial p_0}{\partial r} \right)^{n+1}  \right ] 
+ \dt \; \psi^{\nph} \enskip ,
\end{eqnarray}

\end{enumerate}

\item {\bf Correct Base}
$[\rho_0^{(2)}, (\nabla\cdot\etarho\er)^{\nph}] \rightarrow [\rho_0^{n+1}]$

%--------------------------------------------------------------------------
% STEP 8.1
%--------------------------------------------------------------------------
\item Diffuse the enthalpy through a time interval of $\dt$.  Compute $\kth^{(2),\star}, c_p^{(2),\star}$, and $\xi_k^{(2),\star}$, from $\rho^{(2),\star}, T^{(2),\star}$, and $X_k^{(2),\star}$ as inputs to the equation of state.  The update is given by
\begin{eqnarray}
(\rho h)^{(2)} &=& (\rho h)^{(2')} + \frac{\dt}{2}\nabla\cdot\left(\frac{\kth^{(2),\star}}{c_p^{(2),\star}}\nabla h^{(2)} + \frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla X_k^{(2)} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla p_0^{(2)} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{(1)}\right),
\end{eqnarray}
which is numerically implemented as a diffusion equation for $h^{(2)}$,
\begin{eqnarray}
\left(\rho^{(2)} - \frac{\dt}{2}\nabla\cdot\frac{\kth^{(2),\star}}{c_p^{(2),\star}}\nabla\right)h^{(2)} &=& (\rho h)^{(2')} + \frac{\dt}{2}\nabla\cdot\frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\nonumber\\
&&- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla X_k^{(2)} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla p_0^{(2)} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{(1)}\right),
\end{eqnarray}
\item Update the temperature
\begin{equation}
T^{(2)} = T\left(\rho^{(2)}, h^{(2)}, X_k^{(2)}\right) {\hbox{ \rm using the equation of state.}}
\end{equation}

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 9
%--------------------------------------------------------------------------
\item[Step 9.] {\em React the full state and base state through a second time 
interval of $\dt / 2.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf React State}$[\rho^{(2)},(\rho h)^{(2)}, X_k^{(2)},T^{(2)}, (\rho^{(2)} \Hext) ]$\\
                   $\rightarrow [\rho^{n+1}, (\rho h)^{n+1}, X_k^{n+1}, T^{n+1}, 
                               (\rho \omegadot_k)^{(2)}, (\rho \Hnuc)^{(2)} ].$  

\item {\bf React Base}$[(\rho h)_0^{(2)},(\overline{\rho \Hnuc})^{(2)},(\overline{\rho\Hext})^{(2)}] \rightarrow [(\rho h)_0^{n+1}]$

\item Define
\begin{eqnarray}
 \gammabar^{n+1}    &=& {\rm{\bf Avg}}\left[\Gamma_1(\rho^{n+1}, p_0^{n+1}, {X_k}^{n+1}) \right] \enskip , \\ 
 {\beta   }_0^{n+1}    &=& \beta   \left(\rho_0^{n+1}, p_0^{n+1},   \gammabar^{n+1}\right) \enskip .
\end{eqnarray}

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 10
%--------------------------------------------------------------------------
\item[Step 10.] {\em Compute $S^{n+1}$ for the final projection.}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}
\item Define
\begin{equation}
  S^{n+1} =  -\sigma  \sum_k  \xi_k (\omegadot_k)^{(2)}  + \sigma \Hnuc^{(2)} +
  \frac{1}{\rho p_\rho} \sum_k p_{X_k}  ({\omegadot}_k)^{(2)}  
   + \sigma \Hext \enskip ,
\end{equation}
where $(\omegadot_k)^{(2)} = (\rho \omegadot_k)^{(2)} / \rho^{(2)}$
and the remaining quantities are defined using $X_k^{n+1},$ $\rho^{n+1},$
and $T^{n+1}$ from step 9.

\item Define
\begin{equation}
\overline{S}^{n+1} = {\mathrm{\bf Avg}} (S^{n+1}) \enskip.
\end{equation}

\end{enumerate}


%--------------------------------------------------------------------------
% STEP 11
%--------------------------------------------------------------------------
\item[Step 11.] {\em Update the velocity}.  

The velocity update happens analogously to paper II, using $S^{n+1}$ from step 10.
We update the velocity field $\ut^n$ to $\ut^{n+1,\star}$ by discretizing
\begin{equation}
\frac{\partial\ut}{\partial t} = - \ut \cdotb \nablab \ut - w_0 \frac{\partial \ut}{\partial r}
                                 - \left(\ut \cdotb \er\right) \frac{\partial w_0}{\partial r} \er
                                 - \frac{1}{\rho} \nablab\pi
                                 + \frac{1}{\rho_0} \frac{\partial \pizero}{\partial r} \er
                                 - \frac{(\rho-\rhozero)}{\rho} \; g \; \er  \label{eq:utildeupd}  \enskip\
 ,
\end{equation}
(paper III; eq.~[37]) as 
\begin{eqnarray}
\ut^{n+1,\star} &=& \ut^n - \dt \;
 \left[\left(\uadvtwo+ w_0^{\nph} \er\right) \cdotb \nablab \ut \right]^\nph
      - \dt \; \left(\uadvtwo \cdotb \er\right)  \left(\frac{\partial w_0^{\nph}}{\partial r} \right) \er \nonumber \\
   &&   + \dt \left[ - \frac{1}{\rho^\nph} {\mathbf{G}} \pi^\nmh
        + \frac{1}{\rho_0} {\mathbf{G}} \pizerotwo
        - \frac{(\rho^\nph-\rhozero^\nph)}{\rho^\nph} g \er \right] \enskip ,
\end{eqnarray}
where $\rho^\nph = ( \rho^n + \rho^{n+1} )/2$
and $\mathbf{G}$ approximates a cell-centered gradient from nodal data. 
The construction of $[(\uadvtwo+ w_0^{\nph} \er \cdotb \nablab) \ut ]^\nph$
is described in paper II, Appendix A, with $\V = \uadvtwo+w_0^{\nph} \er$ and~$s$ set to each
component of $\ut^n$ individually.

Finally, we impose the divergence constraint from equation (\ref{eq:tildeconstraint}) 
including the volume discrepancy correction,
\begin{equation}
\nablab \cdotb \left(\beta_0^{\nph} \ut^{n+1} \right)  = \beta_0^{\nph} \left(S^{n+1} - \overline{S}^{n+1} \right)
+ \frac{f}{\gammabar^{n+1} p_0^{n+1}}
\left[\frac{p(\rho,h,X_k)^{n+1} - \overline{p(\rho,h,X_k)^{n+1}}}{\Delta t^n}\right]
\enskip,
\end{equation}
by defining ${\bf V} = \ut^{n+1,\star} + ( \dt / \rho^\nph ) \; \mathbf{G} \pi^\nmh$ 
and solving
\begin{equation}
 L_\beta^\rho \phi =
   D \left ( \beta_0^{\nph} {\bf V} \right) - \beta_0^{\nph} \left(S^{n+1}-\overline{S}^{n+1} \right)
- \frac{f}{\gammabar^{n+1} p_0^{n+1}}
\left[\frac{p(\rho,h,X_k)^{n+1} - \overline{p(\rho,h,X_k)^{n+1}}}{\Delta t^n}\right] \enskip,
\end{equation}
for nodal values of $\phi$, where
$\beta_0^\nph = ( \beta_0^n + \beta_0^{n+1} )/2$ and
$L_\beta^\rho$ is the standard bilinear
finite element approximation to $\nablab \cdotb ({\beta_0^\nph}/{\rho^\nph}) \nablab.$
\MarginPar{Why are $\beta$ and $\rho$ time centered here instead using the new time value?  Does this have something to do with how $\phi$ relates to a lagged pressure?}
In this step, $D$ is a discrete second-order operator that approximates the 
divergence at nodes from cell-centered data and satisfies
$\mathbf{G} = -D^T.$ 
(See (cite almgrenBellSzymczak:1996) for a detailed discussion of this
approximate projection; see (cite almgren:bell:crutchfield) for a discussion
of this particular form of the projection operand.)  
We solve the linear system of equation
\begin{equation}
 L_\beta^\rho \phi =
   D \left ( \beta_0^{\nph} {\bf V} \right) - \beta_0^{\nph} \left(S^{n+1}-\overline{S}^{n+1} \right)\enskip,
\label{eq:nodal_solve}
\end{equation}
(paper III; eq.~[77]) using multigrid V-cycles with Gauss-Seidel relaxation.

We determine the new time velocity field from
\begin{equation}
\ut^{n+1} = {\bf V} - \frac{1}{\rho^\nph} \mathbf{G} \phi \enskip ,
\end{equation}
and the new time-centered perturbational pressure from
\begin{equation}
  \pi^\nph = \frac{1}{\dt} \phi \enskip .
\end{equation}

%--------------------------------------------------------------------------
% STEP 12
%--------------------------------------------------------------------------
\item[Step 12.] {\em Compute a new $\dt.$}

Compute $\dt$ for the next time step with the procedure described in \S~ref{sec:timesteps},
using $w_0$ as computed in step 6 and
$\ut^{n+1}$ as computed in step 11.  We use this $\dt$ in the next time step. 


\end{description}

\noindent This completes the time advancement of the algorithm.



%-----------------------------------------------------------------------------
% Initialization
%-----------------------------------------------------------------------------

\subsection{Initialization}\label{Sec:Initialization}

We start each calculation with user-specified initial values for
$\rho$, $X_k$ and $T,$ as well as an initial background state.  In
order for the low Mach number assumption to hold, the initial data
must be thermodynamically consistent with the initial background
state.  In addition, the initial velocity field must satisfy an
initial approximation to the divergence constraint.  We use an iterative
procedure to compute both an initial right-hand-side for the
constraint equation and an initial velocity field that satisfies
the constraint.  The user specifies the number of iterations,
$N_{\rm iters}^{S},$ in this first step of the initialization procedure.

The initial perturbational pressure also needs to be determined for
use in steps 2, 7 and 11. 
This is done through a second iterative procedure which follows the
time advancement algorithm as described in steps 1-11 in \S~ref{Sec:Alg}.  
The user specifies the number of iterations, 
$N_{\rm iters}^{\pi},$ in this second step of the initialization procedure.
The details for both iterations are given below.\\

%--------------------------------------------------------------------------
% STEP 0
%--------------------------------------------------------------------------
\noindent {\bf Step 0.} {\em Initialization}

Start with initial data $X_k^{\initp}, \rho^{\initp},$ $T^{\initp},$ an 
initial base state, and an initial guess for the velocity, $\ubold^{\initp}.$
Use the equation of state to determine $(\rho h)^{\initp}$.  Set
$w_0^1 = 0$ as an initial approximation.  Compute $\beta_0^{\initp}$ as a function of 
the initial data.  Then, project $\ubold^{\initp}$ using $\beta_0^{\initp}$ and 
$S = \rho\Hext$, giving $\ubold^{0,1}$.  The next part of the initialization process 
proceeds as follows.

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}
\renewcommand{\labelenumii}{\roman{enumii}.}

\item {\bf Do} {$\nu = 1,...,N_{\rm iters}^{S}$.}
  \begin{enumerate}

  \item Estimate $\Delta t^\nu$ using $\ubold^{0,\nu}$ and $w_0^\nu.$

  \item {\bf React State}$[ \rho^{\initp},(\rho h)^{\initp}, X_k^{\initp}, T^{\initp}, (\rho^{\initp} \Hext) ] \rightarrow [\rho^{\outp}, (\rho h)^{\outp}, X_k^{\outp}, T^{\outp}, (\rho \omegadot_k)^{0,\nu} ].$

  \item Compute $S^{0,\nu}$ from equation (\ref{eq:defineS}) 
        using $(\rho \omegadot_k)^{0,\nu}$ and the initial data.

  \item Compute $\overline{S}^{0,\nu} = {\mathrm{\bf Avg}} (S^{0,\nu}).$

  \item Compute $w_0^{\nu+1}$ as in step 1c using $\overline{S}^{0,\nu}$ and $\psi^{\nmh} = 0$.
        

  \item Project $\ubold^{0,\nu}$ using $\beta_0^{\initp}$ and 
        $(S^{0,\nu} - \overline{S}^{0,\nu})$ as the source term.  
        This yields $\ubold^{0,\nu+1}.$

  \end{enumerate}

  {\bf End do.}

  Define $S^0 = S^{0,N_{\rm iters}^S}$, $w_0^{-\myhalf} = w_0^{N_{\rm iters}^S+1}$, 
$\dt^0 = \Delta t^{N_{\rm iters}^S},$ and $\ubold^0 = \ubold^{0,N_{\rm iters}^S+1}.$

\end{enumerate}

Next, we need to construct an approximation to the time-centered perturbational pressure,
$\pi,$  and an approximation to the divergence constraint at the end of the
first time step.  As initial approximations, set $S^{1,0} = S^0$,
$\etarho^{-\half} = 0$, $\psi^{-\half} = 0$, and $\pi^{-\half} = 0.$
\begin{enumerate}
  \renewcommand{\theenumi}{{\bf \alph{enumi}}}
  \renewcommand{\labelenumii}{\roman{enumii}.}
  \addtocounter{enumi}{1}
  
\item {\bf Do} {$\nu = 0,...,N_{\rm iters}^{\pi}-1$.}
  
  \begin{enumerate}
  \item Perform steps 1--11 as described above, using 
    $S^{\half,\star} = (S^0 + S^{1,\nu})/2$ in step 1 as described.
    The only other difference in the time advancement is that in step 11
    we define ${\bf V} = (\ut^{1,\star} - \ut^0)$ and solve
    \begin{equation}  L_\beta^\rho \phi =
      D \left ( \beta_0^{\half} {\bf V} \right) - \beta_0^{\half} \left[ (S^{1}-\overline{S}^{1}) - (S^{0}-\overline{S}^{0}) \right] \enskip . 
    \end{equation}
    (The motivation for this form of the projection in the initial pressure iterations
    is discussed in (cite almgren:bell:crutchfield).)
      We discard the new velocity resulting from this, but keep the new  
      value for $\pi^{\half} = \pi^{-\half} + (1 / \dt) \; \phi.$  
      These steps also yield new scalar data at time $\dt,$ which
      we discard,  and new values for $\etarho^{\half}$ (step 8), $\psi^{\half}$ (step 8), 
      $S^{1,\nu+1}$ (step 10), and $\pi^{\half}$ (step 11), which we keep.
    \item Set $\pi^{-\half} = \pi^{\half}$, $\etarho^{-\half} = \etarho^{\half}$,
      and $\psi^{-\half} = \psi^{\half}$. 
    \end{enumerate}
    
    {\bf End do.}
    
    Finally, we define $S^1 = S^{1,N_{\rm iters}^\pi}.$
    
  \end{enumerate}

\end{document}
