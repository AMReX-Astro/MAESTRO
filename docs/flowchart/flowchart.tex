Here we outline the algorithm currently implemented in the code.  Our
starting point for this description are the series of papers describing
the development of the algorithm:
\begin{itemize}
\item {\em Low Mach Number Modeling of Type Ia
  Supernovae. I. Hydrodynamics,} A.~S.~Almgren, J.~B.~Bell, 
  C.~A.~Rendleman, \& M.~Zingale 2006, ApJ, 637, 922 (henceforth
  paper~I)
\item {\em Low Mach Number Modeling of Type Ia Supernovae. II. Energy
  Evolution,} A.~S.~Almgren, J.~B.~Bell, C.~A.~Rendleman, \& M.~Zingale
  2006, ApJ, 649, 927 (henceforth paper~II)
\item {\em Low Mach Number Modeling of Type Ia Supernovae. III. Reactions,}
A.~S.~Almgren, J.~B.~Bell, A.~Nonaka, \& M.~Zingale
  2008, ApJ, 684, 449 (henceforth paper~III)
\item {\em Low Mach Number Modeling of Type Ia Supernovae. IV. White Dwarf Convection,}
A.~S.~Almgren, J.~B.~Bell, A.~Nonaka, \& M.~Zingale,
  in preparation (henceforth paper~IV)
\end{itemize}
We also carry over some ideas from our small-scale low Mach number algorithm
for astrophysical flows:
\begin{itemize}
\item {\em Adaptive Low Mach Number Simulations of Nuclear Flames,}
J.~B.~Bell, M.~S.~Day, C.~A.~Rendleman, S.~E.~Woosley, \& M.~Zingale
2004, JCP, 195, 2, 677 (henceforth BDRWZ)
\end{itemize}

\section{Changes Between Paper 3 and Paper 4}
\begin{enumerate}
\item {\tt fill\_3d} and {\tt average} algorithms.
\item We update temperature after each {\bf React State} as well as the advection step.
\item We have created a {\tt burning\_cutoff\_density}, where the burning does
not happen below this density.  It is presently set to {\tt base\_cutoff\_density}.
\item Use corner coupling in advection.
\item We use {\tt use\_tfromp} to update temperature using $T=T(\rho,X_k,p_0)$ rather 
than $T=T(\rho,h,X_k)$.
\end{enumerate}
Changes which modify enthalpy update.  These are separate because in this paper,
enthalpy is only used as a diagnostic since we use {\tt use\_tfromp}.  If we don't
mention these items in paper IV, they should me noted in paper 4.5.
\begin{enumerate}
\item We have changed the discretization of $\Ub\cdot\nabla p_0$ in the enthalpy
update to $\nabla\cdot(\Ub p_0) - p_0\nabla\cdot\Ub$.
\item In paper III we discretized the enthalpy evolution equation in
full, non-perturbation form, $\rho h$.  Since then we have discovered that 
discretizing the enthalpy evolution in perturbational form, $(\rho h)'$,
leads to better numerical properties.  We use {\tt enthalpy\_pred\_type = 1}.
This is more like paper II.
\item We have turned off the evolution of $h$ above the atmosphere and instead
compute $h$ with the EOS using {\tt do\_eos\_h\_above\_cutoff = TRUE}.
\end{enumerate}
\section{Changes Between Papers 4 and Papers 4.5}
\begin{enumerate}
\item We split the update of the density and enthalpy in steps 4 and 8.
Now, density is updated first, allowing us to compute time-centered values of 
$\psi$ that are then used in the enthalpy update.
\item We split {\bf Advect Base} into separate {\bf Advect Base Density},
{\bf Advect Base Pressure}, and {\bf Advect Base Enthalpy}.  The calling sequence
is in the main flow chart.
\item We replaced {\bf Correct Base} with $\rho_0 = {\rm{\bf Avg}}(\rho)$ in 
plane-parallel and $\rho_0 = \rho_0 + {\rm{\bf Avg}}(\rho - \rho_0)$ in spherical,
eliminating the need for $\nabla\cdot\etarho$.  {\bf Correct Base} is now used
analogously for setting $(\rho h)_0$ after {\bf React State}.
\item After {\bf React State}, we set $(\rho h)_0 = {\rm{\bf Avg}}(\rho h)$ in 
plane-parallel and $(\rho h)_0 = (\rho h)_0 + {\rm{\bf Avg}}[(\rho h) - (\rho h)_0]$ 
in spherical.  This means that {\bf React Base} no longer exists, and the intermediate 
states, $(\rho h)_0^{(1)}$ and $(\rho h)_0^{(2)}$, no longer have to exist.  
{\bf Advect Base Enthalpy} will advance $(\rho h)_0^n \rightarrow (\rho h)_0^{n+1}$ 
directly.  This also means we don't have to deal with $\eta_{\rho h}$ or a 
{\bf Diffuse Base}.
\item In {\bf Step 4} and {\bf Step 8}, we moved {\bf Correct Base} so it
occurs after the full state density update and  before {\bf Advect Base Pressure}.  
Since the full enthalpy advance ``feels'' the effects of the time-centered $\etarho$, 
we should rely on a $\rho_0^{n+1}$ that also feels the effects.
\item {\bf AMR!!!}
\end{enumerate}
Changes specific to spherical:
\begin{enumerate}
\item Discuss {\bf Advect Base} routines and {\bf Correct Base} routine.
\item $\etarho$ and $\psi$ equations.
\end{enumerate}
\section{Changes Between Papers 4.5 and Paper 5}
\begin{enumerate}
\item Use PPM limiters in advection.
\end{enumerate}
\section{Changes Between Paper 5 and XRB Paper}
\begin{enumerate}
\item We have added thermal diffusion, controlled by {\tt use\_thermal\_diffusion},
{\tt temp\_diffusion\_formulation}, and {\tt thermal\_diffusion\_type}.
\item We added the volume discrepancy term to the velocity constraint equation,
controlled by the input parameter, {\tt dpdt\_factor}.
\end{enumerate}

%-----------------------------------------------------------------------------
% Future Considerations
%-----------------------------------------------------------------------------

\section{Future Considerations}

\begin{itemize}

\item Should we eliminate {\bf Advect Base Pressure} entirely, and instead directly
enforce HSE after {\bf Correct Base}?  {\bf Advect Base Pressure} was just a fancy
way of enforcing HSE anyway, so we just compute the new pressure directly.  The
problems we have seen with enforcing HSE directly have to do with the roundoff
error that accumulates, causing the temperature computed from the EOS to drift.
However, using {\bf Advect Base Pressure}, the latest version of {\bf test\_basestate}
does not work after some bug fixes.

\item Should we use a predictor-corrector for updating the full-state density?
Specifically, after calling {\bf Correct Base}, should we do a full-state density 
advance and {\bf Correct Base} using the more accurate estimate of $\rho_0^{n+1}$?

\end{itemize}

%-----------------------------------------------------------------------------
% Notation
%-----------------------------------------------------------------------------

\section{Notation}

%%%%%%%%%%%%%%%%
% symbol table
%%%%%%%%%%%%%%%%

\renewcommand{\arraystretch}{1.5}
%
\begin{center}
\begin{longtable}{|l|p{4.0in}|l|}
\caption[definition of symbols.]{definition of symbols.} \label{table:sym} \\
%
\hline \multicolumn{1}{|c|}{\textbf{symbol}} & 
       \multicolumn{1}{ c|}{\textbf{meaning}} & 
       \multicolumn{1}{ c|}{\textbf{units}} \\ \hline 
\endfirsthead

\multicolumn{3}{c}%
{{\tablename\ \thetable{}---continued}} \\
\hline \multicolumn{1}{|c|}{\textbf{symbol}} & 
       \multicolumn{1}{ c|}{\textbf{meaning}} & 
       \multicolumn{1}{ c|}{\textbf{units}} \\ \hline 
\endhead

\multicolumn{3}{|r|}{{\em continued on next page}} \\ \hline
\endfoot

\hline 
\endlastfoot

$c_p$   & specific heat at constant pressure
          ($c_p \equiv \left . \partial h / \partial T \right |_{p,X_k}$)
        & erg~g$^{-1}$~K$^{-1}$ \\
\hline
$f$     & volume discrepancy factor ($0 \le f \le 1$) & -- \\
\hline
$g$     & gravitational acceleration                 & cm~s$^{-2}$ \\
\hline
$h$     & specific enthalpy                          & erg~g$^{-1}$ \\
\hline
$\Hext$ & external heating energy generation rate    & erg~g$^{-1}$~s$^{-1}$ \\
\hline
$\Hnuc$ & nuclear energy generation rate             & erg~g$^{-1}$~s$^{-1}$ \\
\hline
$h_p$   & $h_p \equiv \left . \partial h / \partial p \right |_{T,X_k}$ & cm$^{3}$~g$^{-1}$ \\
\hline
$\kth$  & thermal conductivity                       & erg~cm$^{-1}$~s$^{-1}$~K$^{-1}$ \\
\hline
$p_0$   & base state pressure                        & erg~cm$^{-3}$ \\
\hline
$p_T$   & $p_T \equiv \left . \partial p / \partial T \right |_{\rho,X_k}$ & erg~cm$^{-3}$~K$^{-1}$ \\
\hline
$p_{X_k}$ & $p_{X_k} \equiv \left . \partial p / \partial X_k \right |_{p,T,X_{j,j\ne k}}$ & erg~cm$^{-3}$ \\
\hline
$p_\rho$ & $p_\rho \equiv \left . \partial p / \partial \rho \right |_{T,X_k}$ & erg~g$^{-1}$ \\
\hline
$q_k$   & specific nuclear binding energy            & erg~g$^{-1}$  \\
\hline
$r$     & radial coordinate (direction of gravity)   & cm \\
\hline
$s$     & specific entropy                           & erg~g$^{-1}$~K$^{-1}$ \\
\hline
$S$     & source term to the divergence constraint   & s$^{-1}$ \\
\hline
$t$     & time                                       & s \\
\hline
$T$     & temperature                                & K \\
\hline
$\Ub$     & total velocity ($\Ub = \Ubt + w_0 \er$) & cm~s$^{-1}$ \\
\hline
$\Ubt$   & local velocity                             & cm~s$^{-1}$ \\
\hline
$\uadv$ & advective velocity (edge-centered)         & cm~s$^{-1}$ \\
\hline
$w_0$   & base state expansion velocity              & cm~s$^{-1}$ \\
\hline
$X_k$   & mass fraction of the species ($\sum_k X_k = 1$) & -- \\
\hline
$\beta_0$ & coefficient to velocity
            in velocity constraint equation  & g~cm$^{-3}$ \\
\hline
$\Gamma_1$ & first adiabatic exponent ($\Gamma_1 \equiv \left . d \log p/d \log \rho \right |_s$) & -- \\
\hline
$\etarho$ & $\etarho \equiv \overline{(\rho' \Ubt \cdot \er)}$ & g~cm$^{-2}$~s$^{-1}$ \\
\hline
$\xi_k$ & $\xi_k \equiv \left . \partial h / \partial X_k \right |_{p,T,X_{j,j\ne k}}$ & erg~g$^{-1}$ \\
\hline 
$\pi$   & dynamic pressure & erg~cm$^{-3}$ \\
\hline
$\pizero$ & base state dynamic pressure & erg~cm$^{-3}$ \\
\hline
$\rho$  & mass density  & g~cm$^{-3}$ \\
\hline
$\rho_0$  & base state mass density  & g~cm$^{-3}$ \\
\hline
$\rho'$  & perturbational density ($\rho' = \rho - \rho_0$) & g~cm$^{-3}$ \\
\hline
$(\rho h)_0$ & base state enthalpy density & erg~cm$^{-3}$  \\
\hline
$(\rho h)'$ & perturbational enthalpy density 
              $ \left [(\rho h)' = \rho h - (\rho h)_0 \right ]$ & erg~cm$^{-3}$  \\
\hline
$\sigma$ & $\sigma \equiv p_T/(\rho c_p p_\rho)$ & erg$^{-1}$~g \\
\hline
$\psi$  & $\psi \equiv D_0 p_0/Dt = \partial p_0/\partial t + w_0\partial p_0/\partial r$ & erg~cm$^{-3}$~s$^{-1}$ \\
\hline
$\omegadot_k$ & creation rate for species $k$ ($\omegadot_k \equiv DX_k/Dt$) & s$^{-1}$ \\
\end{longtable}
\end{center}
%
\renewcommand{\arraystretch}{1.0}
Here are some charts demonstrating what the superscript notation above scalars implies:
\begin{equation}
\left.\begin{array}{ccccccccc}
& \text{React State} & & \text{Advect State} & & \text{Diffuse Enthalpy} & & \text{React State} & \\
\rho^n & = & \rho^{(1)} & \longrightarrow & & & \rho^{(2)} & = & \rho^{n+1} \\
(\rho X_k)^n & \longrightarrow & (\rho X_k)^{(1)} & \longrightarrow & & & (\rho X_k)^{(2)} & \longrightarrow & (\rho X_k)^{n+1} \\
(\rho h)^n & \longrightarrow & (\rho h)^{(1)} & \longrightarrow & (\rho h)^{(1a)} & \longrightarrow & (\rho h)^{(2)} & \longrightarrow & (\rho h)^{n+1}\\
T^n & \longrightarrow & T^{(1)} & & & \longrightarrow & T^{(2)} & \longrightarrow & T^{n+1} \\
\end{array}\right.\nonumber
\end{equation}
\begin{equation}
\left.\begin{array}{ccccccc}
& \text{Advect Base} & & \text{Correct Base} & \\
\rho_0^n & \longrightarrow & \rho_0^{(2a)} & \longrightarrow & \rho_0^{n+1} \\
(\rho h)_0^n & \longrightarrow & & & (\rho h)_0^{n+1} \\
p_0^n & \longrightarrow & & & p_0^{n+1} \\
\end{array}\right.\nonumber
\end{equation}
\section{Shorthand Functions}
We make use of the following shorthand notations in outlining the algorithm:
\begin{enumerate}

\item For any quantity, $\phi$, we define $\overline{\phi} = ${\bf Avg}$(\phi)$
as the average over a layer at constant radius r, $\Omega_H$, as
\begin{equation}
\overline{\phi(r)}
= \frac{1}{\mathrm{A}(\Omega_H)}\int_{\Omega_H} \phi(r,{\bf x}) \; dA \enskip .
\end{equation}
In plane-parallel, this is as straightforward as averaging cell values at 
a particular height.  For spherical problems, see the description in 
paper IV, section 2.2 (or section \ref{Sec:Avg}).

\item {\bf React State}$[\rho^{\inp},(\rho h)^{\inp},X_k^{\inp},T^{\inp}, (\rho\Hext)^{\inp}, 
p_0^{\inp}]\rightarrow [\rho^{\outp}, (\rho h)^{\outp}, X_k^{\outp}, T^{\outp}, 
(\rho \omegadot_k)^{\outp}, (\rho\Hnuc)^{\outp}]$ \\
is the process by which we evolve the species and enthalpy from 
$X_k^{\inp} \rightarrow X_k^{\outp}$ 
and $(\rho h)^{\inp} \rightarrow (\rho h)^{\outp}$ by solving the following 
system of equations over a time interval of  $\Delta t/2$,
\begin{eqnarray}
\frac{\partial X_k}{\partial t} &=& \omegadot_k\enskip,\\
\frac{\partial (\rho h)}{\partial t} &=& \rho \Hnuc + \rho \Hext\enskip .
\end{eqnarray}
  In particular, to evolve the species, we solve the system:
\begin{eqnarray}
\frac{dX_k}{dt} &=& \omegadot_k(\rho,X_k,T)\enskip, \\
\frac{dT}{dt} &=&\frac{1}{c_p} \left ( -\sum_k \xi_k  \omegadot_k  + \Hnuc \right )
\enskip. \label{eq:reacttemp}
\end{eqnarray}
using the stiff ordinary differential equation integration methods
provided by the {\tt VODE} package (cite vode).  The absolute error
tolerances are set to $10^{-12}$ for the species, and a relative
tolerance of $10^{-5}$ is used for the temperature.  The integration
yields the new values of the mass fractions, $X_k^{\outp}$.  Equation
(\ref{eq:reacttemp}) is derived from the full temperature evolution equation
from equation (8) in paper III,
\begin{equation}
\label{eq:tempenthalpy}
\frac{DT}{Dt} = \frac{1}{\rho c_p} \left[ \left(1 - \rho h_p\right) \frac{D p}{D t}
 - \sum_k \rho \xi_k {\omegadot}_k 
 + \rho \Hnuc + \rho \Hext \right] \enskip , 
\end{equation}
by assuming that the pressure is constant during the burn state.  In
evolving these equations, we need to evaluate $c_p$ and $\xi_k$.  In
theory, this means evaluating the equation of state for each
right-hand side evaluation that {\tt VODE} requires.  In practice, we
freeze $c_p$ and $\xi_k$ at the start of the integration time step and
compute them using $\rho^{\inp}, X_k^{\inp},$ and $T^{\inp}$ as inputs
to the equation of state.  We update temperature using
$T^{\outp} = T(\rho^\outp,h^\outp,X_k^\outp)$ if {\tt use\_tfromp = FALSE} or 
$T^{\outp} = T(\rho^\outp,p_0,X_k^\outp)$  if {\tt use\_tfromp = TRUE}.  
Note that the density remains unchanged
during the {\bf React State} step, i.e., $\rho^{\outp} = \rho^{\inp}$.

After the new mass fractions have been computed, the reaction rates are defined as:
\begin{equation}
(\rho\omegadot_k)^{\outp} = \frac{\rho^{\outp} ( X_k^{\outp} - X_k^{\inp})}{\Delta t /2} \enskip,
\end{equation}
and the nuclear energy generation rate is defined as
\begin{equation}
(\rho\Hnuc)^{\outp} = -\sum_k q_k (\rho\omegadot_k)^{\outp} \enskip,
\end{equation}
for the case where only strong-mediated reactions are involved.  As
$\Hnuc$ is an output of the reaction network, more general networks
(i.e., involving weak interactions) can easily be added.  The enthalpy
update incorporates the external heating, $(\rho\Hext)^{\inp}$, and is
updated by
\begin{equation}
(\rho h)^{\outp} = 
(\rho h)^{\inp} + \frac{\dt}{2} (\rho\Hnuc)^{\outp} + \frac{\dt}{2} (\rho\Hext)^{\inp}\enskip.
\end{equation}

\item {\bf Advect Base Density}$[\rho_0^\inp,w_0^\inp]$
$\rightarrow [\rho_0^\outp,\rho_0^{\outp,n+\myhalf}]$\\
is the process by which we update the base state density through $\dt$ in time
as well as compute time-centered interface states, $\rho_0^{\outp,n+\myhalf}$, 
for use later in the algorithm.
\begin{description}

\item[plane-parallel:] We discretize the base state density evolution 
equation from paper III equation (29) without the $\etarho$ term,
\begin{equation}
\frac{\partial \rhozero}{\partial t} = - \nablab \cdotb \left( \rhozero w_0 \er \right)
\enskip ,
\label{eq:rho0upd_new}
\end{equation}
to compute the new base state density,
\begin{equation}
\rho_{0,j}^{\outp} = \rho_{0,j}^{\inp} - \frac{\dt}{\dr} 
\left [ \left( \rho_0^{\outp,\nph} w_0^{\inp}\right)_{j+\myhalf} -  
         \left( \rho_0^{\outp,\nph} w_0^{\inp}\right)_{j-\myhalf} \right ]
         \nonumber \enskip,
\end{equation}
where $j$ refers to the one-dimensional index in the radial direction.
The interface states, $\rho_0^{\outp,\nph}$, are computed using the
procedure described in paper II, Appendix A.\\

\item[spherical:] The base state density update now includes the area factors in the 
divergences:
\begin{equation}
\rho_{0,j}^{\outp} = \rho_{0,j}^{\inp}
 - \frac{1}{r_j^2} \frac{\dt}{\dr} 
 \left [ \left( r^2 \rho_0^{\outp,\nph} w_0^{\inp}\right)_{j+\myhalf} -  
          \left( r^2 \rho_0^{\outp,\nph} w_0^{\inp}\right)_{j-\myhalf} \right] \enskip. 
\end{equation}
\end{description}
%\item {\bf Advect Base Pressure}
%is the process by which we update the base state pressure through $\dt$ in time and
%compute $\psi$.  The input arguments are different for plane-parallel and spherical.
%\begin{description}
%\item {\bf Advect Base Pressure Planar}$[p_0^\inp,w_0^\inp,\etarho^\inp] \rightarrow 
%[p_0^\outp,\psi^\outp]$:
%
%First we compute a cell-centered $\psi^\outp$ using
%\begin{equation}
%\psi_j^\outp = 
%\frac{1}{2} \left(\eta_{\rho,j-\myhalf}^\inp + \eta_{\rho,j+\myhalf}^\inp\right) g \enskip .
%\end{equation}
%Then, we discretize the base state pressure evolution equation from paper III equation (31),
%\begin{equation}
%\frac{\partial p_0}{\partial t} = 
%-w_0 \frac{\partial p_0}{\partial r} + \psi \enskip , \label{eq:p0upd_new}
%\end{equation}
%to compute the new base state pressure,
%\begin{equation}
%p_{0,j}^\outp = p_{0,j}^\inp - \frac{\dt}{2\dr} \left (w_{0,j+\myhalf}^\inp
%+ w_{0,j-\myhalf}^\inp \right)
%\left (p_{0,j+\myhalf}^{n+\myhalf} -p_{0,j-\myhalf}^{n+\myhalf} \right ) 
%+ \dt \; \psi_j^\outp \enskip,
%\end{equation}
%where the interface states, $p_0^{n+\myhalf}$, are again found via the procedure 
%described in paper II, Appendix A.\\
%
%\item {\bf Advect Base Pressure Spherical}$[p_0^{\inp},w_0^{\inp},\gammabar^{\inp},
%\Sbar^{\inp}, \rho^\inp, X_k^\inp] \rightarrow [p_0^{\outp},\psi^{n,\outp}, 
%\psi^{n+\myhalf,\outp}]$:
%
%First use a predictor-corrector formulation for the pressure update in order to improve 
%the overall accuracy.  Beginning with equation (\ref{eq:w01}), we can write
%\begin{equation}
%\frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} = 
% \Sbar - \frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) 
%- \frac{1}{\gammabar p_0} w_0 \frac{\partial p_0}{\partial r} \enskip .
%\end{equation}
%We time-center the left hand side:
%\begin{equation}
%\frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} \approx
%\frac{2}{\gammabar^{\inp} (p_0^{\inp} + p_0^{\star})} \frac{p_0^{\star} 
%- p_0^{\inp}}{\dt}\enskip.
%\end{equation}
%We can then solve for the provisional updated pressure, $p_0^{\star}$, giving:
%\begin{equation}
%p_0^{\star} = p_0^{\inp} 
%\frac{\left(1 + \gammabar^{\inp} f\right)}{\left(1 - \gammabar^{\inp} f\right)}\enskip,
%\end{equation}
%with:
%\begin{equation}
%f = \frac{\dt}{2} \left [ \Sbar^{\inp} - 
%\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0^{\inp} \right) - 
%\frac{1}{\gammabar^{\inp} p_0^{\inp}} w_0^{\inp} 
%\left ( \frac{\partial p_0^\inp}{\partial r} \right ) \right ] \label{eq:frhs} \enskip ,
%\end{equation}
%where the $(\partial p_0^\inp / \partial r)$ is computed by interpolating $p_0^\inp$ from 
%cell-centers to edges and then differencing.  Next, we compute a provisional updated 
%$\gammabar$ using the provisional updated pressure,
%$\gammabar^\star = {\bf Avg}[\Gamma_1(\rho^{\inp},p_0^\star,X_k^{\inp})]$,
%where $\rho^\inp$ and $X_k^\inp$ are time-advanced versions of the $\rho$ and
%$X_k$ which were used to compute $\gammabar^\inp$.\\
%
%Now we begin the corrector step.  Using $p_0^\star$ and $\gammabar^\star$, 
%we can compute a more accurate approximation to equation (\ref{eq:frhs}),
%\begin{equation}
%f^\dagger = \frac{\dt}{2} \left [ \Sbar^{\inp} -
%\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0^{\inp} \right) - 
%\frac{1}{\gammabar^{\dagger} p_0^\dagger} w_0^{\inp} 
%\left ( \frac{\partial p_0^\dagger}{\partial r} \right ) \right ] \enskip ,
%\end{equation}
%where $p_0^\dagger = (p_0^\inp + p_0^\star)/2$ and
%$\gammabar^\dagger = (\gammabar^\inp + \gammabar^\star)/2$.
%This allows us to complete the corrector for the pressure update:
%\begin{equation}
%p_0^{\outp} = p_0^{\inp} \frac{\left(1 + \gammabar^{\dagger} f^\dagger\right)}{\left(1 - \gammabar^{\dagger} f^\dagger\right)}\enskip .
%\end{equation}
%Next, we compute $\psi^{\outp,n}$ and $\psi^{\outp,n+\myhalf}$.  First, we compute an 
%updated $\gammabar$ using the update pressure, 
%$\gammabar^\star = {\bf Avg}[\Gamma_1(\rho^{\inp},p_0^{\outp},X_k^{\inp})]$.  Then, 
%rewriting equation (\ref{eq:w01}), we can define
%\begin{eqnarray}
%\psi \equiv \frac{D_0 p_0}{Dt} &=& \gammabar p_0 \left [ \overline{S} - 
%       \frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) \right] \enskip .
%\end{eqnarray}
%We discretize this locally as:
%\begin{equation}
%\psi_j^{\outp,n} = 
%\left(\gammabar^\inp p_0^\inp\right)_j
%\left \{ \Sbar_j^{\inp} -  \frac{1}{r_j^2} \left [ (r^2 w_0^{\inp})_{j+\myhalf} -
%          (r^2 w_0^{\inp})_{j-\myhalf} \right ] \right \} \enskip ,
%\end{equation}
%\begin{equation}
%\psi_j^{\outp,n+\myhalf} = 
%\left(\frac{\gammabar^\inp+\gammabar^{\star}}{2}\right)_j
%\left(\frac{p_0^\inp+p_0^\outp}{2}\right)_j
%\left \{ \Sbar_j^{\inp} -  \frac{1}{r_j^2} \left [ (r^2 w_0^{\inp})_{j+\myhalf} -
%          (r^2 w_0^{\inp})_{j-\myhalf} \right ] \right \} \enskip .
%\end{equation}
%\end{description}
\item {\bf Enforce HSE}$[p_0^{\inp},\rho_0^{\inp},g^{\inp}] \rightarrow [p_0^{\outp}]$
has replaced {\bf Advect Base Pressure} from paper III as the process by which we 
update the base state pressure.  Rather than discretize the evolution equation
for $p_0$, we enforce hydrostatic equilibrium directly, which is simpler and
analytically equivalent.  We update $p_0$ using:
\begin{equation}
p_{0,j}^{\outp} = p_{0,j-1}^{\outp} + 
\frac{\Delta r}{2}\left(\rho_{0,j}^{inp}+\rho_{0,j-1}^{\inp}\right)g_{j-\myhalf}^{\inp}\enskip .
\end{equation}
Once the density is less than the cutoff density, we set $p_{0,j}^\outp = p_{0,j-1}^\outp$.
We use the boundary condition, $p_{0,jmax}^\outp = p_{0,jmax}^\inp$.

\item {\bf Advect Base Enthalpy}
is the process by which we update the base state enthalpy through $\dt$ in time.
The input arguments are different for plane-parallel and spherical.
\begin{description}
\item {\bf Advect Base Enthalpy Planar}$[(\rho h)_0^\inp,w_0^\inp,\psi^\inp] \rightarrow 
[(\rho h)_0^\outp]$:

We discretize the base state enthalpy equation,
\begin{equation}
\frac{\partial (\rho h)_0}{\partial t} = -\nabla\cdot\left[(\rho h)_0w_0\er\right] 
+ \psi \enskip ,
\end{equation}
to compute the new base state enthalpy,
\begin{equation}
(\rho h)_{0,j}^{\outp} = (\rho h)_{0,j}^{\inp} - \frac{\dt}{\Delta r}
\left\{ \left[ (\rho h)_0^{\nph} w_0^{\inp}\right]_{j+\myhalf} -  
         \left[ (\rho h)_0^{\nph} w_0^{\inp}\right]_{j-\myhalf} \right\}
+ \dt\psi_j^{\inp} \enskip ,
\end{equation}
where the interface states $(\rho h)_0^{n+\myhalf}$, are again found via the procedure 
described in paper II, Appendix A.\\

\item {\bf Advect Base Enthalpy Spherical}$[(\rho h)_0^\inp,w_0^\inp,\psi^{\inp,n},
\psi^{\inp,n+\myhalf}] \rightarrow [(\rho h)_0^\outp]$:

The base state enthalpy update now includes the area factors in the divergences:
\begin{equation}
(\rho h)_{0,j}^{\outp} = (\rho h)_{0,j}^{\inp}
 - \frac{1}{r_j^2} \frac{\dt}{\dr} 
 \left \{ \left[ r^2 (\rho h)_0^{\outp} w_0^{\inp}\right]_{j+\myhalf} -  
          \left[ r^2 (\rho h)_0^{\outp} w_0^{\inp}\right]_{j-\myhalf} \right\}
+\Delta t\psi^{\inp,n+\myhalf} \enskip. 
\end{equation}
To compute the interface states, we use $\psi^{\inp,n}$ as the forcing term, whereas in the
enthalpy update, we use $\psi^{\inp,n+\myhalf}$ as the forcing.

\end{description}

\item {\bf Correct Base}$[\rho_0^{\inp}, \rho^{\inp}] \rightarrow [\rho_0^{\outp}]$\\
is the process by which we adjust the base state density to account for
large-scale mixing.  It is also used to reset the base state enthalpy to be
the average of the full state enthalpy since we do not need to compute the complete
evolution of the base state enthalpy.
Unlike paper III where we used $\nabla\cdot\etarho$ as an adjustment to $\rho_0$, 
we instead simply set $\rho_0=\overline{\rho}$, which is analytically equivalent.
\begin{description}
\item[plane-parallel:] Set $\rho_0^{\outp} = {\bf Avg}(\rho^{\inp})$.
\item[spherical:] Set $\rho_0^{\outp} = \rho_0^{\inp} + {\bf Avg}(\rho^{\inp} - \rho_0^{\inp})$.
\end{description}

\item {\bf Compute $w_0$}\\
is the process by which we compute $w_0$.  The arguments are different for plane-parallel
and spherical.
\begin{description}
\item {\bf Compute $w_0$ Planar}$[\Sbar^{\inp},\gammabar^{\inp},p_0^{\inp},\psi^{\inp}] 
\rightarrow [w_0^{\outp}]$:

We integrate
\begin{equation}
\frac{\partial w_0}{\partial r} =  \Sbar - \frac{1}{\gammabar p_0} \psi
\enskip \label{eq:divw0} ,
\end{equation}
with the following discretization:
\begin{equation}
\frac{\partial w_0^{\outp}}{\partial r} =  \Sbar^{\inp}
- \frac{1}{\gammabar^{\inp} p_0^{\inp}}\psi^{\inp}
\enskip ,
\end{equation}
and $w_0=0$ at $r=0$.\\

The discretization with the volume discrepancy correction require an additional argument,
$\overline{p^{\inp}}$, and the discretization becomes:
\begin{equation}
\frac{\partial w_0^{\nph,\outp}}{\partial r} = 
\overline{S^{\nph,\inp}} - \frac{1}{\gammabar^{\inp} p_0^{\inp}}
\left[ \psi^{\inp} + f \left(\frac{p_0^{\inp} - \overline{p^{\inp}}}{\Delta t^n}\right)\right]
\enskip .
\end{equation}

\item {\bf Compute $w_0$ Spherical}$[\Sbar^{\inp},\gammabar^{\inp},\rho_0^{\inp},p_0^{\inp},
\etarho^{\inp}] \rightarrow[w_0^{\outp}]$:

We begin with equation (23) in paper III written in spherical coordinates:
\begin{equation}
\frac{1}{r^2}\frac{\partial}{\partial r} \left (r^2 \beta_0 w_0 \right ) =
\beta_0 \left ( \Sbar - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} \right )\enskip.
\end{equation}
We expand the spatial derivative and divide through by $\beta_0$:
\begin{equation}
\label{eq:sphconstraint}
\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) +
w_0 \frac{1}{\beta_0} \frac{\partial \beta_0}{\partial r} =
 \Sbar - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t}  \enskip .
\end{equation}
Recalling from paper I that;
\begin{equation}
\frac{1}{\gammabar p_0}  \frac{\partial p_0}{\partial r} = \frac{1}{\beta_0} \frac{\partial \beta_0}{\partial r}\enskip,
\end{equation}
and moving this term to the right hand side,
we can express equation (\ref{eq:sphconstraint}) as:
\begin{eqnarray}
\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) &=&
  \Sbar - \frac{1}{\gammabar p_0} \left( 
\frac{\partial p_0}{\partial t} + w_0 \frac{\partial p_0}{\partial r} \right)\enskip. \label{eq:w01}
\end{eqnarray}
We first solve a piece of this equation for $\ow = w_0 - \dw$:
\begin{eqnarray}
\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 \ow \right ) &=& \Sbar^{\inp} \enskip.
\end{eqnarray}
Then we can write
\begin{eqnarray}
\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 \dw \right ) &=&
  - \frac{1}{\gammabar p_0} \left[
\frac{\partial p_0}{\partial t} + (\ow + \dw)
\frac{\partial p_0}{\partial r} \right]\enskip.\label{eq:w01a}
\end{eqnarray}

Multiplying equation (\ref{eq:w01a}) through by $\gammabar p_0 $,
taking another derivative with respect to $r$, and switching the order
of temporal and spatial derivatives, we get:
\begin{equation}
\label{eq:sphconstraint_2}
\frac{\partial}{\partial r} \left [ \frac{\gammabar p_0 }{r^2} \frac{\partial}{\partial r} (r^2 \dw) \right ]
= -\frac{\partial}{\partial t} \frac{\partial p_0}{\partial r}
  -\frac{\partial}{\partial r} \left [(\ow+\dw) \frac{\partial p_0}{\partial r} \right ]\enskip.
\end{equation}

To solve for $\dw$ we will need to substitute for the derivatives of $p_0.$
To do so we start with the equation of hydrostatic equilibrium in a spherical geometry:
\begin{equation}
\frac{\partial p_0}{\partial r} = -\rho_0 g \, ; \quad
g = \frac{G m_\mathrm{encl}}{r^2}\enskip,
\end{equation}
where $m_\mathrm{encl}(r)$ is the mass enclosed at radius $r$ and $G$ is the
gravitational constant.  
Using this, we can then write equation (\ref{eq:sphconstraint_2}) as:
\begin{eqnarray}
\frac{\partial}{\partial r} \left[ \frac{\gammabar p_0}{r^2} \frac{\partial}{\partial r} (r^2 \dw) \right] &=&
 \frac{\partial}{\partial t} \left (\rho_0 g \right )
+\frac{\partial}{\partial r} \left (w_0 \rho_0 g \right) \nonumber \\
&=&
  g \left[ \frac{\partial \rho_0}{\partial t} + \frac{\partial}{\partial r} (w_0 \rho_0) \right]
+ \rho_0 \left( \frac{\partial g}{\partial t} + w_0 \frac{\partial g}{\partial r} \right) \enskip.\nonumber\\
&&
\label{eq:sphconstraint_3}
\end{eqnarray}
The mass enclosed inside any radius, $r$, is $m_\mathrm{encl}(r) = 4 \pi
\int_0^r \rhozero(s) s^2 ds$, or alternately, $\partial m_\mathrm{encl}/\partial r = 4\pi r^2 \rho_0$.  
The Lagrangian derivative of the enclosed mass is then:
\begin{eqnarray}
\frac{D_0 m_\mathrm{encl}}{D t} &=& \frac{\partial m_\mathrm{encl}}{\partial t} + w_0 \frac{\partial m_\mathrm{encl}}{\partial r} \nonumber \\
 &=& 4\pi \left( \frac{\partial}{\partial t} \int_0^r \rhozero(s) s^2 ds + w_0 r^2 \rho_0 \right) \nonumber \\
&=& 4\pi \left( \int_0^r \frac{\partial \rho_0}{\partial t} s^2 ds + w_0 r^2 \rho_0 \right) \nonumber \\
&=& 4\pi \left\{ -\int_0^r \left [ \frac{1}{s^2}\frac{\partial(s^2 \rho_0 w_0)}{\partial s} + \frac{1}{s^2}\frac{\partial (s^2 \etarho)}{\partial s} \right ]s^2 ds + w_0 r^2 \rho_0 \right\} \nonumber \\
&=&  \left . 4\pi \left(-s^2 \rho_0 w_0 \right |_0^r - \left . s^2 \etarho \right |_0^r + w_0 r^2 \rho_0 \right) \nonumber \\
&=& -4\pi r^2 \etarho \label{eq:dmdt}
\end{eqnarray}
where we used the spherical form of equation (29) in paper III, 
\begin{equation}
\label{eq:sph_continuity}
\frac{\partial \rhozero}{\partial t} + \frac{1}{r^2} \frac{\partial (r^2 \rho_0 w_0)}{\partial r} 
+ \frac{1}{r^2} \frac{\partial (r^2 \etarho )}{\partial r}  = 0 \enskip ,
\end{equation}
to eliminate $\partial \rho_0/\partial t$.  We note that in the
absence of any mixing, $\etarho=0$, and  $D_0 m_\mathrm{encl}/Dt = 0.$
Equation (\ref{eq:dmdt})
allows us to write the Lagrangian change in the gravitational
acceleration as:
\begin{eqnarray}
\frac{D_0 g}{D t} = \frac{\partial g}{\partial t} + w_0 \frac{\partial g}{\partial r} &=& \frac{D_0}{Dt}\left(\frac{G m_\mathrm{encl}}{r^2}\right) \nonumber \\
&=& G m_\mathrm{encl}\frac{D_0}{D t}\left(\frac{1}{r^2}\right) + \frac{G}{r^2}\frac{D_0 m_\mathrm{encl}}{Dt} \nonumber \\
&=& -\frac{2 w_0 G m_\mathrm{encl}}{r^3} - 4 \pi G \etarho \nonumber \\
&=& -\frac{2 w_0 g}{r} - 4 \pi G \etarho \enskip .
\end{eqnarray}

Putting it all together, equation (\ref{eq:sphconstraint_3}) becomes:
\begin{equation}
 \frac{\partial}{\partial r} \left[ \frac{\gammabar p_0}{r^2} \frac{\partial}{\partial r} (r^2 \dw) \right] 
= 
  g \left [ \frac{\partial \rho_0}{\partial t} + \frac{\partial}{\partial r} (w_0 \rho_0) \right ]
+ \rho_0 \left(\frac{-2 w_0 g}{r} - 4 \pi G \etarho \right) \label{eq:B5} \enskip.
\end{equation}
Finally, we can use equation (\ref{eq:sph_continuity})
to write equation (\ref{eq:B5}) as:
\begin{eqnarray}
\frac{\partial}{\partial r} \left[ \frac{\gammabar p_0}{r^2} \frac{\partial}{\partial r} (r^2 \dw) \right] &=&
 g \left [ -\frac{1}{r^2} \frac{\partial}{\partial r} (r^2 w_0 \rhozero)
           -\frac{1}{r^2} \frac{\partial}{\partial r} (r^2 \etarho)
           + \frac{\partial}{\partial r} (w_0 \rhozero) \right ] \nonumber \\
&& + \rho_0 \left(\frac{-2 w_0 g}{r} - 4 \pi G \etarho \right) \nonumber \\
&=& - \frac{g}{r^2} \frac{\partial (r^2 \etarho)}{\partial r} 
- \frac{4 (\ow + \dw) \rho_0 g}{r} - 4 \pi G \rhozero \etarho \label{eq:B7} \enskip .
\end{eqnarray}

\noindent We discretize this elliptic equation in the radial dimension as:
\begin{eqnarray}
&& \frac{1}{\Delta r} \left\{
\left[ \frac{\gammabar p_0}{r^2} \frac{\partial (r^2 \dw)}{\partial r} \right]_{j} -
\left[ \frac{\gammabar p_0}{r^2} \frac{\partial (r^2 \dw)}{\partial r} \right]_{j-1} \right\}
+ \left[ \frac{4 (r^2 \dw) \rho_0 g}{r^3} \right]_{j-\myhalf} \nonumber\\
&=& 
- \frac{g_{j-\myhalf}}{r_{j-\myhalf}^2 \Delta r} 
\left[ \left( r^2 \etarho \right)_{j} - \left( r^2 \etarho  \right)_{j-1} \right] 
   - \left( \frac{4 \ow \rho_0 g}{r} \right)_{j-\myhalf}
   - \left(  4 \pi G \rhozero \etarho   \right)_{j-\myhalf} \enskip , \nonumber
\end{eqnarray}
where we have chosen to solve for $(r^2 \dw)$ rather than $\dw.$
Then, using hydrostatic equilibrium, we expand this to 
\begin{eqnarray}
&& \frac{1}{\Delta r} \left\{
 \left( \frac{\gammabar p_0}{r^2}\right)_{j  } \frac{\left[ (r^2 \dw)_{j+\myhalf} - (r^2 \dw)_{j-\myhalf} \right]}{\Delta r}
-\left( \frac{\gammabar p_0}{r^2}\right)_{j-1} \frac{\left[ (r^2 \dw)_{j-\myhalf} - (r^2 \dw)_{j-\thalf}\right]}{\Delta r} \right\} \nonumber \\
&&  - \left( \frac{4}{r_{j-\myhalf} ^3} \frac{p_{0,j} - p_{0,j-1}}{\dr} \right) (r^2 \dw)_{j-\myhalf}  \nonumber \\
&=&   \left( \frac{4}{r_{j-\myhalf} ^3} \frac{p_{0,j} - p_{0,j-1}}{\dr} \right) (r^2 \ow)_{j-\myhalf}
 - \frac{g_{j-\myhalf}}{r_{j-\myhalf}^2 \Delta r} 
  \left[ \left( r^2 \etarho \right)_{j} - \left( r^2 \etarho  \right)_{j-1} \right] 
- \left(  4 \pi G \rhozero \etarho   \right)_{j-\myhalf} \enskip, \nonumber \\
\end{eqnarray}
where $\etarho$ at cell-centers is the average of the neighboring edge-values.  
If we write this in matrix form, so that:
\begin{equation}
A_j (r^2 \dw)_{j-\thalf} + B_j (r^2 \dw)_{j-\myhalf} + C_j (r^2 \dw)_{j+\myhalf} = F_j\enskip,
\end{equation}
then:
\begin{eqnarray}
A_j &=& \frac{1}{\Delta r^2} \left( \frac{\gammabar^{\inp} p_0^{\inp}}{r^2}\right)_{j-1}  \enskip, \nonumber  \\
B_j &=& -\frac{1}{\Delta r^2} \left[ \left( \frac{\gammabar^{\inp} p_0^{\inp}}{r^2}\right)_{j  }  
               +\left( \frac{\gammabar^{\inp} p_0^{\inp}}{r^2}\right)_{j-1} \right] 
              - \left( \frac{4}{r_{j-\myhalf} ^3} \frac{p_{0,j}^{\inp} - p_{0,j-1}^{\inp}}{\dr} \right) \nonumber \\
C_j &=& \frac{1}{\Delta r^2} \left( \frac{\gammabar^{\inp} p_0^{\inp}}{r^2}\right)_{j}  \enskip, \nonumber  \\
F_j &=&  \left( \frac{4}{r_{j-\myhalf} ^3} \frac{p_{0,j}^{\inp} - p_{0,j-1}^{\inp}}{\dr} \right) (r^2 \ow)_{j-\myhalf}
 - \frac{g_{j-\myhalf}}{r_{j-\myhalf}^2 \Delta r} 
\left[ \left( r^2 \etarho^{\inp} \right)_{j} - \left( r^2 \etarho^{\inp}  \right)_{j-1} \right] 
\nonumber \\
&& - \left(  4 \pi G \rhozero^{\inp} \etarho^{\inp}   \right)_{j-\myhalf} \enskip \nonumber .
\end{eqnarray}
Here,
\begin{equation}
g_{j-\myhalf} = \frac{G}{r_{j-\myhalf}^2} \sum_{k=1}^{j} \frac{4}{3} \pi  (r_{k-\myhalf}^3 - r_{k-\thalf}^3) \; \rho_{0,k-1}^{\inp} \enskip.
\end{equation}

We define the lower boundary condition, $ \dw = 0$ at $r=0,$ which
corresponds to $j=1,$ by setting:
\begin{eqnarray}
A_1 = C_1 = F_1 &=& 0\enskip, \nonumber \\
B_1 &=& 1\enskip. \nonumber
\end{eqnarray}
We also specify $\partial (r^2 \dw) / \partial r = 0$ at the the upper boundary, which corresponds to $j=N,$
by setting:
\begin{eqnarray}
A_N &=& -1\enskip, \nonumber \\
B_N &=&  1\enskip, \nonumber \\
C_N = F_N &=& 0\enskip. \nonumber
\end{eqnarray}
Finally, $w_0^{\outp} = \ow + \delta w_0$.
\end{description}

\item {\bf Compute Gravity}$[\rhozero^{\inp}] \rightarrow [g^{\outp}]$\\
is the process by which we compute gravity at both radial cell-centers and edges.
\begin{description}
\item For plane-parallel, gravity constant in space and time.
\item For spherical, we define the enclosed mass at edges, and then cell-centers:
\begin{equation}
m_{j-\myhalf} = \sum_{k=1}^j \frac{4}{3}\pi\left(r_{k-\myhalf}^3 - r_{k-\sfrac{3}{2}}^3\right)\rho_{0,k-1}^{\inp}; ~~~~~ m_j = m_{j-\myhalf} + \frac{4}{3}\pi \left(r_j^3 - r_{j-\myhalf}^3\right)\rho_{0,j}^{\inp} \enskip .
\end{equation}
Then, we define the gravity at both edges and cell-centers:
\begin{equation}
g_{j-\myhalf}^\outp = \frac{Gm_{j-\myhalf}}{r_{j-\myhalf}^2}; ~~~~~ 
g_j^\outp = \frac{Gm_j}{r_j^2}\enskip .
\end{equation}
\end{description}

\end{enumerate}

%-----------------------------------------------------------------------------
% Time Advancement Algorithm
%-----------------------------------------------------------------------------

\section{Time Advancement Algorithm}\label{Sec:Time Advancement Algorithm}

We now describe the full time advancement algorithm, making frequent
use of the shorthand developed above.  Here, we assume that the
problem is already properly initialized.  We describe the details of
the initialization in \S \ref{Sec:Initialization}.
The advance of the state through a single timestep appears as:

%--------------------------------------------------------------------------
% STEP 1
%--------------------------------------------------------------------------

\begin{description}

\item[Step 1.] {\em Define the provisional time-centered expansion, $S^{n+\myhalf,\star}$, 
base state velocity, $w_0^{n+\myhalf,\star}$, and base state velocity forcing.}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item At the beginning of each time step, we need an estimate for the time-centered
source term in the velocity divergence constraint, as given in paper III equation (19),
\begin{equation}
  S =  -\sigma  \sum_k  \xi_k \omegadot_k  + 
  \frac{1}{\rho p_\rho} \sum_k p_{X_k}  {\omegadot}_k  + \sigma \Hnuc + \sigma \Hext 
  + \frac{\sigma}{\rho}\nabla\cdot\kth\nabla T \enskip .
\label{eq:defineS} 
\end{equation}

If this is the first step of the calculation ($n=0$), we set
\begin{equation}
S^{\myhalf,\star} = \frac{S^0 + S^1}{2} \enskip ,
\end{equation}
where $S^1$ is found through the iterative process that initializes the calculation.
Otherwise, following the method used in our small-scale low Mach number algorithm
(BDRWZ), we extrapolate to the half-time using the source
terms at the previous and current time levels
\begin{equation}
S^{\nph,\star} = S^n + \frac{\Delta t^n}{2} \frac{S^n - S^{n-1}}{\Delta t^{n-1}} \enskip .
\end{equation}
\item Compute
\begin{equation}
\overline{S^{\nph,\star}} = {\mathrm{\bf Avg}} \left(S^{\nph,\star}\right) \enskip .
\end{equation}
\item Compute $w_0^{n+\myhalf,\star}$:
\begin{description}
\item For plane-parallel,\\
{\bf Compute $w_0$ Planar}$[\overline{S^{\nph,\star}},\gammabar^n,p_0^n,\psi^{n-\myhalf}] 
\rightarrow [w_0^{n+\myhalf,\star}]$.

If we are using the volume discrepancy term, compute 
$\overline{p^{\inp}} = \overline{p(\rho,h,X_k)^n}$.
\item For spherical,\\
{\bf Compute $w_0$ Spherical}$[\overline{S^{\nph,\star}},\gammabar^n,\rhozero^n,p_0^n,
\etarho^{n-\myhalf}] \rightarrow [w_0^{n+\myhalf,\star}]$.
\end{description}

\item Define the scaled pressure gradient using
\begin{equation}
- \frac{1}{\rho_0} \frac{\partial \pizero}{\partial r} 
= \frac{\partial w_0}{\partial t} + w_0 \frac{\partial w_0}{\partial r} 
\enskip, \label{eq:pizero}
\end{equation}
with the following discretization:
\begin{equation}
-\left ( \frac{1}{\rho_0^n} \frac{\partial \pizeroone}{\partial r} \right ) = 
\frac{w_0^{\nph,\star} - w_0^\nmh}{(\dt^n+\dt^{n-1})/2} 
+  w_0^{n,\star} \left(\frac{\partial w_0}{\partial r}\right)^{n,\star} \enskip ,
\end{equation} 
where $w_0^{n,\star}$ and $(\partial w_0 / \partial r)^{n,\star}$ are
\begin{equation}
w_0^{n,\star} = \frac{\dt^{n} w_0^{\nmh} + \dt^{n-1} w_0^{\nph,\star}}{\dt^n+\dt^{n-1}} 
\enskip,\end{equation}
\begin{equation}
\left(\frac{\partial w_0}{\partial r}\right)^{n,\star} = 
\frac{1}{\dt^n+\dt^{n-1} } 
\left [ \dt^{n} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nmh}
+ \dt^{n-1} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nph,\star} \right ] 
\enskip.\end{equation}
If $n=0$, we use $\dt^{-1} = \dt^0$.

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 2
%--------------------------------------------------------------------------
\item[Step 2.] {\em Construct the provisional time-centered advective velocity on 
edges, $\uadvone$.}

The local velocity field is described by paper III equation (37),
\begin{equation}
\frac{\partial\Ubt}{\partial t} = - \Ubt \cdotb \nablab \Ubt - w_0 \frac{\partial \Ubt}{\partial r}
                                 - \left(\Ubt \cdotb \er\right) \frac{\partial w_0}{\partial r} \er
                                 - \frac{1}{\rho} \nablab\pi
                                 + \frac{1}{\rho_0} \frac{\partial \pizero}{\partial r} \er
                                 - \frac{(\rho-\rhozero)}{\rho} \; g \; \er  \label{eq:utildeupd}  \enskip\
 .
\end{equation}

We construct time-centered velocities at edges, $\uadvone$, 
using a second-order unsplit Godunov procedure, as described
in Appendix B of paper III.  We note that  $\uadvone$ satisfies 
the discrete versions of paper III equation (21),
\begin{equation}
\int_{\Omega_H} \Ubt \cdotb \er \; dA = 0 \label{eq:udoterzero} \enskip ,
\end{equation}
and paper III equation (39),
\begin{equation}
\nablab \cdotb (\beta_0 \Ubt )  = \beta_0 \left(S - \Sbar \right )\enskip ,
\label{eq:tildeconstraint}
\end{equation}
with the discretization
\begin{equation}
\nablab \cdotb \left(\beta_0^n \uadvone\right) = 
\beta_0^n \left(S^{\nph,\star} - \overline{S^{\nph,\star}}\right) \enskip .
\end{equation}
The discretization with the volume discrepancy correction is
\begin{equation}
\nablab \cdotb \left(\beta_0^n \uadvone\right) = 
\beta_0^n \left\{ \left(S^{\nph,\star} - \overline{S^{\nph,\star}}\right)
+ \frac{f}{\gammabar^n p_0^n}
\left[\frac{p(\rho,h,X_k)^n - \overline{p(\rho,h,X_k)^n}}{\Delta t^n}\right]\right\} \enskip .
\end{equation}

%--------------------------------------------------------------------------
% STEP 3
%--------------------------------------------------------------------------
\item[Step 3.] {\em React the full state through the first time interval of $\dt / 2.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf React State}$[\rho^n, (\rho h)^n, X_k^n, T^n, (\rho\Hext)^n, p_0^n]
                   \rightarrow$ $[ \rho^{(1)}, (\rho h)^{(1)}, X_k^{(1)}, T^{(1)},
                                  (\rho \omegadot_k)^{(1)}, (\rho \Hnuc)^{(1)} ].$

\item {\bf Correct Base}$[(\rho h)_0^{n},(\rho h)^{(1)}] \rightarrow [(\rho h)_0^{n}]$.

\item Define
\begin{equation}
\gammabar^{(1)} = {\rm{\bf Avg}} \left[ \Gamma_1\left(\rho^{(1)}, p_0^{n}, X_k^{(1)}\right) \right] \enskip .
\end{equation}

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 4
%--------------------------------------------------------------------------
\item[Step 4.] {\em Advect the base state, then the full state, through a time interval 
of $\dt.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf Advect Base Density}$[\rhozero^{n},w_0^{\nph,\star}] \rightarrow$ 
$[\rho_0^{(2a),\star}, \rho_0^{\nph,\star,{\rm pred}}]$.

\item Update the species.  Here we do a difference approximation
  to 
  \begin{equation}
  \frac{\partial (\rho X_k)}{\partial t} + \nablab \cdotb (\Ub \rho X_k) =
         \rho {\omegadot}_k \enskip , \label{eq:species}
  \end{equation}
  neglecting the reaction terms.  The update consists of two steps:

  \begin{enumerate}
  \renewcommand{\labelenumii}{{\bf \roman{enumii}}.}

  \item Compute the species edge states, $(\rho X_k)^{(1),\nph,\star}$,
  for the conservative update of $(\rho X_k)^{(1)}$. 
  Here we predict $\rho^{'(1)} = \rho^{(1)} - \rhozero^n$ and 
  $X_k^{(1)} = (\rho X_k)^{(1)} / \rho^{(1)}$ to time-centered edges to obtain 
  $\rho^{'(1),\nph,\star}$ and $X_k^{(1),\nph,\star}$ using a second-order
  unsplit Godunov procedure, as described in paper II,
  Appendix A, using $\Vb = \uadvone+w_0^{\nph,\star} \er$.  We use the base
  state density, $\rho_0$, to convert this to an edge state for $\rho$,
\begin{equation}
\rho^{(1),\nph,\star} = 
\rho^{'(1),\nph,\star} + \frac{\rho_0^n + \rho_0^{(2a),\star}}{2} \enskip .
\label{eq:rhoXedgestate}
\end{equation}
  In plane-parallel, we use 4th-order spatial averaging to compute $\rho_0$ on 
  radial faces.  In spherical, we first map $\rho_0$ to Cartesian cell-centers 
  using the mapping in section \ref{Sec:1D Cell-Centered to Cartesian Cell-Centered}, 
  and then use 2nd-order spatial averaging to compute $\rho_0$ on all faces.

  \item Evolve $(\rho X_k)^{(1)} \rightarrow (\rho X_k)^{(2),\star}$
  without explicitly including the reaction terms,
\begin{equation}
(\rho X_k)^{(2),\star} = (\rho X_k)^{(1)} 
 - \dt \; \left\{ \nablab \cdotb \left[ \left(\uadvone+w_0^{\nph,\star} \er\right)  
  (\rho X_k)^{(1),\nph,\star} \right] \right\} \enskip ,
\end{equation}
\begin{equation}
\rho^{(2),\star} = \sum_k (\rho X_k)^{(2),\star} \enskip ,
\end{equation}
\begin{equation}
X_k^{(2),\star} = (\rho X_k)^{(2),\star} / \rho^{(2),\star}
\end{equation}

\end{enumerate}

\item Define an edge-centered $\etarho^{\nph,\star}$:

\begin{description}
\item For plane-parallel,
\begin{equation}
 \etarho^{\nph,\star} =  {\rm {\bf Avg}} \sum_k \left[ \left(\uadvone \cdotb \er + w_0^{\nph,\star}\right) (\rho X_k)^{(1),\nph,\star} \right] - w_0^{\nph,\star} \rho_0^{\nph,\star,{\rm pred}} \enskip ,
\end{equation}
\item For spherical, first construct 
$\eta_{\rho}^{{\rm cart},\nph,\star} = [\rho'(\Ubt\cdot\eb_r)]^{n+\myhalf,\star}$ using:
\begin{equation}
\eta_{\rho}^{{\rm cart},\nph,\star} = \left[\left(\frac{\rho^{(1)}+\rho^{(2),\star}}{2}\right)-\left(\frac{\rho_0^n+\rho_0^{(2a),\star}}{2}\right)\right] \sum_d \left(\uadvone \cdot \eb_d\right)n_d.
\end{equation}
Then, $\etarho^{\nph,\star}$ is the cell-centered average of $\eta_{\rho}^{{\rm cart},\nph,\star}$,
\begin{equation}
\etarho^{\nph,\star} = \overline{\eta_{\rho}^{{\rm cart},\nph,\star}}.
\end{equation}
This gives a radial cell-centered $\etarho^{\nph,\star}$.  To get $\etarho^{\nph,\star}$ at 
radial edges, average the two neighboring radial bins.
\end{description}

\item {\bf Correct Base}$[\rho_0^{(2a),\star},\rho^{(2),\star}] \rightarrow [\rho_0^{n+1,\star}]$.

\item {\bf Compute Gravity}$[\rho_0^{n+1,\star}] \rightarrow [g^{n+1,\star}]$.

%{\bf Advect Base Pressure Planar}$[p_0^n, w_0^{\nph,\star}, \etarho^{n+\myhalf,\star}]
%\rightarrow [p_0^{n+1,\star},\psi^{\nph,\star}]$.
%\item For spherical,\\
%{\bf Advect Base Pressure Spherical}$[p_0^n,w_0^{\nph,\star},\gammabar^{(1)},
%\overline{S^{\nph,\star}}, \rho^{(2),\star}, X_k^{(2),\star}]$\\
%$~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%\rightarrow [p_0^{n+1,\star},\psi^{n,\star},\psi^{\nph,\star}]$.
\item {\bf Enforce HSE}$[p_0^n,\rho_0^{n+1,\star},g^{n+1,\star}] \rightarrow [p_0^{n+1,\star}]$.

\item Compute $\psi$.
\begin{description}
\item For plane-parallel, 
\begin{equation}
\psi_j^{n+\myhalf,\star} = \frac{1}{2} \left(\eta_{\rho,j-\myhalf}^{n+\myhalf,\star} 
+ \eta_{\rho,j+\myhalf}^{n+\myhalf,\star}\right) g^{n+1,\star} \enskip .
\end{equation}
\item For spherical, first compute:
\begin{equation}
\gammabar^{(2)} = {\rm{\bf Avg}} \left[ \Gamma_1\left(\rho^{(2)}, p_0^{n+1,\star}, 
X_k^{(2)}\right) \right] \enskip .
\end{equation}
Then, define a base time and time-centered $\psi$:
\begin{equation}
\psi_j^{n,\star} = 
\left(\gammabar^{(1)} p_0^n\right)_j
\left \{ \Sbar_j^{n+\myhalf,\star} - 
\frac{1}{r_j^2} \left [ (r^2 w_0^{n+\myhalf,\star})_{j+\myhalf} -
          (r^2 w_0^{n+\myhalf,\star})_{j-\myhalf} \right ] \right \} \enskip ,
\end{equation}
\begin{eqnarray}
\psi_j^{n+\myhalf,\star} &=& 
\left(\frac{\gammabar^{(1)}+\gammabar^{(2)}}{2}\right)_j
\left(\frac{p_0^n+p_0^{n+1,\star}}{2}\right)_j \nonumber \\
&& \left \{ \Sbar_j^{n+\myhalf,\star} - 
\frac{1}{r_j^2} \left [ (r^2 w_0^{n+\myhalf,\star})_{j+\myhalf} -
          (r^2 w_0^{n+\myhalf,\star})_{j-\myhalf} \right ] \right \} \enskip .
\end{eqnarray}
\end{description}

\item Update $(\rho h)_0$.
\begin{description}
\item For plane-parallel,\\
{\bf Advect Base Enthalpy Planar}$[(\rho h)_0^{n}, w_0^{\nph,\star}, \psi^{\nph,\star}]
\rightarrow [(\rho h)_0^{n+1,\star}]$.
\item For spherical,\\
{\bf Advect Base Enthalpy Spherical}$[(\rho h)_0^{n}, w_0^{\nph,\star}, 
\psi^{n,\star},\psi^{\nph,\star}] \rightarrow [(\rho h)_0^{n+1,\star}]$.
\end{description}

\item Update the enthalpy.  The full enthalpy equation is 
  \begin{equation}
  \frac{\partial (\rho h)}{\partial t}  = - \nablab \cdotb (\Ub \rho h)
+ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} + \nabla\cdot\kth\nabla T + \rho \Hnuc + \rho \Hext 
\enskip , \label{eq:rhohupd} 
  \end{equation}
Here we consider only the advection, neglecting the reaction terms and thermal diffusion terms,
and solve a discretized version of
  \begin{equation}
  \frac{\partial (\rho h)}{\partial t}  = - \nablab \cdotb (\Ub \rho h)
+ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} 
\enskip , \label{eq:rhohupdadv} 
  \end{equation}
For spherical flows, experience has shown that solving the algebraically-equivalent form
\begin{equation}
  \frac{\partial (\rho h)}{\partial t}  = - \nablab \cdotb (\Ub \rho h)
+ \psi + \nabla \cdot (\Ubt p_0) - p_0 \nabla \cdot \Ubt  
\enskip , \label{eq:rhohupdadv2} 
\end{equation}
results in a better solution.


  \begin{enumerate}
  \renewcommand{\labelenumii}{{\bf \roman{enumii}}.}

  \item Compute the enthalpy edge state, $(\rho h)^{(1),\nph,\star},$
    for the conservative update of $(\rho h)^{(1)}.$  Here we predict 
    $(\rho h)' = (\rho h)^{(1)} - (\rho h)_0$ to time-centered edges to obtain 
    $(\rho h)^{'(1),\nph,\star}$, 
    using a second-order unsplit Godunov procedure, 
    as described in paper II, Appendix A, using $\Vb =
    \uadvone+w_0^{\nph,\star} \er$.  We do not include the reaction
    terms in the enthalpy prediction, since we accounted for them
    already in {\bf React State}.  We use the base state enthalpy,
    $(\rho h)_0$, to convert this to an edge state for $(\rho h)$,

    
\begin{equation}
(\rho h)^{(1),\nph,\star} = 
(\rho h)^{'(1),\nph,\star} + \frac{(\rho h)_0^n + (\rho h)_0^{n+1,\star}}{2}
\enskip .
\end{equation}
  In plane-parallel, we use 4th-order spatial averaging to compute $(\rho h)_0$
  on radial faces.  In spherical, we first map $h_0 \equiv (\rho h)_0/\rho_0$ 
  and $\rho_0$ to Cartesian cell-centers using the mapping in section 
  \ref{Sec:1D Cell-Centered to Cartesian Cell-Centered}, use 2nd-order spatial 
  averaging to compute $h_0$ and $\rho_0$ on all faces, and then multiply these 
  terms to get $(\rho h)_0$ on all faces.

  \item Evolve $(\rho h)^{(1)} \rightarrow (\rho h)^{(2),\star}$ without
  explicitly including the reaction terms.

\begin{description}
\item For plane-parallel,

  \begin{eqnarray}
  (\rho h)^{(2),\star} &=& (\rho h)^{(1)} - \dt \; \left\{ \nablab
      \cdotb \left[ \left(\uadvone+w_0^{\nph,\star} \er\right) (\rho
      h)^{(1),\nph,\star} \right] \right\} \nonumber \\ && + \dt \;
    \left(\uadvone \cdotb \er\right) \left(\frac{\partial
      p_0}{\partial r} \right)^{n} + \dt \; \psi^{\nph,\star} \enskip ,
  \end{eqnarray}

\item For spherical,

  \begin{eqnarray}
  (\rho h)^{(2),\star} &=& (\rho h)^{(1)} - \dt \; \left\{ \nablab
      \cdotb \left[ \left(\uadvone+w_0^{\nph,\star} \er\right) (\rho
      h)^{(1),\nph,\star} \right] \right\} \nonumber \\ 
    && + \dt \; \left \{ \nabla \cdot \left (\uadvone p_0^{n} \right ) 
       - p_0^{n} \nabla \cdot \uadvone \right \} \nonumber \\
    && + \dt \; \psi^{\nph,\star} \enskip ,
  \end{eqnarray}

\end{description}

\end{enumerate}

If {\tt do\_eos\_h\_above\_cutoff=T} (which is the default setting), then if
$\rho^{(2),\star} < {\tt base\_cutoff\_density}$, then we recompute enthalpy using
\begin{equation}
(\rho h)^{(2),\star} = \rho^{(2),\star}h\left(\rho^{(2),\star},p_0^{n+1,\star},X_k^{(2),\star}\right).
\end{equation}


%--------------------------------------------------------------------------
% STEP 4.1
%--------------------------------------------------------------------------

\item If we are using thermal diffusion, diffuse the enthalpy through a time interval of 
$\dt$.  First, define $(\rho h)^{(1a),\star} = (\rho h)^{(2),\star}$.  We recompute
$(\rho h)^{(2),\star}$ to account for thermal diffusion.  Here we begin
with the enthalpy equation (\ref{eq:rhohupd}), but consider only the 
diffusion terms,
\begin{equation}
  \frac{\partial (\rho h)}{\partial t}  = 
 \nabla\cdot\kth\nabla T 
\enskip . \label{eq:rhohupdthermal} 
  \end{equation}
We can recast this as an enthalpy-diffusion equation by applying the
chain-rule to $h(p_0,T,X_k)$,
\begin{equation}
\nabla h = h_p \nabla p_0 + c_p \nabla T + \sum_k \xi_k \nabla X_k \enskip ,
\end{equation}
giving
\begin{equation}
  \frac{\partial (\rho h)}{\partial t}  = 
 \nabla\cdot \frac{\kth}{c_p}\nabla h -  
 \sum_k \nabla\cdot \frac{\xi_k \kth}{c_p}\nabla X_k -
 \nabla\cdot \frac{h_p \kth}{c_p}\nabla p_0 
\enskip . \label{eq:rhohupdthermal2} 
  \end{equation}

Compute $\kth^{(1)}, c_p^{(1)}$, and $\xi_k^{(1)}$ from $\rho^{(1)}, T^{(1)}$, and $X_k^{(1)}$ as inputs to the equation of state.  The update is given by
\begin{eqnarray}
(\rho h)^{(2),\star} &=& (\rho h)^{(1a),\star} + \frac{\dt}{2}\nabla\cdot\left(\frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(2),\star} + \frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(2),\star} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n+1,\star} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n}\right),
\end{eqnarray}
which is numerically implemented as a diffusion equation for $h^{(2),\star}$,
\begin{eqnarray}
\left(\rho^{(2),\star} - \frac{\dt}{2}\nabla\cdot\frac{\kth^{(1)}}{c_p^{(1)}}\nabla\right)h^{(2),\star} &=& (\rho h)^{(1a),\star} + \frac{\dt}{2}\nabla\cdot\frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\nonumber\\
&&- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(2),\star} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n+1,\star} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n}\right),
\end{eqnarray}
\item Update the temperature using the equation of state.  For plane-parallel,
we update using
\begin{equation}
T^{(2),\star} = T\left(\rho^{(2),\star}, h^{(2),\star}, X_k^{(2),\star}\right) \enskip ,
\end{equation}
but in spherical, we set {\tt use\_tfromp = T}, and we use
\begin{equation}
T^{(2),\star} = T\left(\rho^{(2),\star}, p_0^{n+1,\star}, X_k^{(2),\star}\right) \enskip .
\end{equation}
The latter has the effect of completely decoupling the enthalpy equation from the 
evolution.

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 5
%--------------------------------------------------------------------------
\item[Step 5.] {\em React the full state through a second time interval of $\dt / 2.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf React State}$[ \rho^{(2),\star},(\rho h)^{(2),\star}, X_k^{(2),\star}, 
                             T^{(2),\star}, (\rho\Hext)^{(2),\star}, p_0^{n+1,\star}] $\\
$~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\rightarrow [ \rho^{n+1,\star},(\rho h)^{n+1,\star}, 
X_k^{n+1,\star}, T^{n+1,\star}, (\rho \omegadot_k)^{(2),\star}, (\rho \Hnuc)^{(2),\star} ].$  

\item Define
\begin{eqnarray}
 \gammabar^{n+1,\star}    &=& {\rm{\bf Avg}} \left[ \Gamma_1\left(\rho^{n+1,\star}, p_0^{n+1,\star}, 
                                                      X_k^{n+1,\star}\right) \right] \enskip , \\
 \beta_0^{n+1,\star}    &=& \beta   \left(\rho_0^{n+1,\star}, p_0^{n+1,\star}, \gammabar^{n+1,\star}, g^{n+1,\star}\right) \enskip ,
\end{eqnarray}
where $\beta_0$ is computed as described in paper III, Appendix C.

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 6
%--------------------------------------------------------------------------
\item[Step 6.] {\em Define the final time-centered expansion, $S^{n+\myhalf}$, 
base state velocity, $w_0^{n+\myhalf}$, and base state velocity forcing.}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}
\item Define
\begin{equation}
  S^{n+1,\star} =  -\sigma  \sum_k  \xi_k  (\omegadot_k)^{(2),\star}  + 
  \sigma \Hnuc^{(2),\star} +
  \frac{1}{\rho p_\rho} \sum_k p_{X_k}  ({\omegadot}_k)^{(2),\star}  
  + \sigma \Hext + \frac{\sigma}{\rho}\nabla\cdot\kth\nabla T^{n+1,\star} \enskip .
\end{equation} 
where $(\omegadot_k)^{(2),\star} = (\rho \omegadot_k)^{(2),\star} / \rho^{(2),\star}$
and the thermodynamic quantities are defined using $\rho^{n+1,\star}, X_k^{n+1,\star},$ 
and $T^{n+1,\star}$ as inputs to the equation of state.
Then define
\begin{equation}
 S^\nph = \frac{S^n + S^{n+1,\star}}{2} \enskip. 
\end{equation}

\item Compute
\begin{equation}
\overline{S^{\nph}} = {\mathrm{\bf Avg}} (S^{\nph}) \enskip.
\end{equation}

\item Define:
\begin{equation}
\gammabar^{\nph} = \frac{\gammabar^{n} + \gammabar^{n+1,\star}}{2}\enskip , ~~~
\rhozero^{\nph} = \frac{\rhozero^{n} + \rhozero^{n+1,\star}}{2}\enskip , ~~~
p_0^{\nph} = \frac{p_0^{n} + p_0^{n+1,\star}}{2}\enskip .
\end{equation}
\item Compute $w_0^{n+\myhalf}$:
\begin{description}
\item For plane-parallel,\\
{\bf Compute $w_0$ Planar}$[\overline{S^{\nph}},
\gammabar^{n+\myhalf},p_0^{n+\myhalf},\psi^{n+\myhalf,\star}]\rightarrow [w_0^{n+\myhalf}]$.

If we are using the volume discrepancy term, compute
\begin{equation}
\overline{p^{\inp}} = \frac{\overline{p(\rho,h,X_k)^n} + \overline{p(\rho,h,X_k)^{n+1,\star}}}{2}.
\end{equation}
\item For spherical,\\
{\bf Compute $w_0$ Spherical}$[\overline{S^{\nph}},\gammabar^{n+\myhalf},
\rhozero^{n+\myhalf},p_0^{n+\myhalf},\etarho^{n+\myhalf}] \rightarrow [w_0^{n+\myhalf}]$.
\end{description}

\item Using equation (\ref{eq:pizero}), define the scaled pressure gradient using the
following discretization:
\begin{equation}
-\left ( \frac{1}{\rho_0^n} \frac{\partial \pizerotwo}{\partial r} \right ) = 
\frac{w_0^{\nph} - w_0^\nmh}{\myhalf(\dt^n+\dt^{n-1})} 
+ w_0^n \left(\frac{\partial w_0}{\partial r}\right)^n.
\end{equation}
where $w_0^n$ and $(\partial w_0 / \partial r)^{n}$ are defined through paper III equation (53),
\begin{equation}
w_0^n = \frac{\dt^{n} w_0^{\nmh} + \dt^{n-1} w_0^{\nph}}{\dt^n+\dt^{n-1}}\enskip,\label{eq:w0nstar}
\end{equation}
and paper III equation (54),
\begin{equation}
\left(\frac{\partial w_0}{\partial r}\right)^{n} = \frac{1}{\dt^n+\dt^{n-1} } \left [ \dt^{n} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nmh}
+ \dt^{n-1} \left(\frac{\partial w_0 }{ \partial r}\right)^{\nph} \right ] \enskip.\label{eq:dw0drnstar}
\end{equation}

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 7
%--------------------------------------------------------------------------
\item[Step 7.] {\em Construct the final time-centered advective velocity on 
edges, $\uadvtwo$.}

The procedure to construct $\uadvtwo$ is described in detail in Appendix B of paper III
and is analogous to the procedure used in step 2, but with updated values
for $w_0$ and $\pizero.$  We note that $\uadvtwo$ satisfies the discrete versions of 
equations (\ref{eq:udoterzero}) and (\ref{eq:tildeconstraint}), with the discretization
\begin{equation}
\nablab \cdotb \left(\beta_0^{\nph} \uadvtwo\right) =
\beta_0^{\nph}\left(S^{\nph} - \overline{S^{\nph}}\right) \enskip ,
\end{equation}
\begin{equation}
\beta_0^{\nph} = \frac{ \beta_0^n +  \beta_0^{n+1,\star} }{2} \enskip .
\end{equation}
The discretization with the volume discrepancy correction is
\begin{equation}
\nablab \cdotb \left(\beta_0^{\nph} \uadvtwo\right) =
\beta_0^{\nph}\left\{\left(S^{\nph} - \overline{S^{\nph}}\right)
 + \frac{f}{\gammabar^{\nph} p_0^{\nph}}\cdot 
\left[\frac{p(\rho,h,X_k)^{\nph} - \overline{p(\rho,h,X_k)^{\nph}}}{\Delta t^n}\right]\right\} \enskip ,
\end{equation}

%--------------------------------------------------------------------------
% STEP 8
%--------------------------------------------------------------------------
\item[Step 8.] {\em Advect the base state, then the full state, through a time interval of $\dt.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf Advect Base Density}$[\rho_0^{n},w_0^{\nph}] \rightarrow$ 
$[\rho_0^{(2a)}, \rho_0^{\nph,{\rm pred}}]$.

\item Update the species.  Here we do a difference approximation to
  equation (\ref{eq:species}), neglecting the reaction terms.  The
  update consists of two steps:

  \begin{enumerate}
  \renewcommand{\labelenumii}{{\bf \roman{enumii}}.}

  \item Compute the species edge states, $(\rho X_k)^{(1),\nph}$, for
    the conservative update of $(\rho X_k)^{(1)}$.  Here we predict 
    $\rho^{'(1)} = \rho^{(1)} - \rhozero^n$
    and $X_k^{(1)} = (\rho X_k)^{(1)} / \rho^{(1)}$ to time-centered edges to 
    obtain $\rho^{'(1),\nph}$ and $X_k^{(1),\nph}$ using a second-order 
    unsplit Godunov procedure, as described in paper II, Appendix A, 
    using $\Vb = \uadvtwo+w_0^{\nph} \er$.  We use the base
    state density, $\rho_0$, to convert this to an edge state for $\rho$,

\begin{equation}
\rho^{(1),\nph} = \rho^{'(1),\nph} + \frac{\rho_0^n + \rho_0^{(2a)}}{2}\enskip .
\end{equation}
  In plane-parallel, we use 4th-order spatial averaging to compute $\rho_0$ on 
  radial faces.  In spherical, we first map $\rho_0$ to Cartesian cell-centers 
  using the mapping in section \ref{Sec:1D Cell-Centered to Cartesian Cell-Centered}, 
  and then use 2nd-order spatial averaging to compute $\rho_0$ on all faces.

    \item Evolve $(\rho X_k)^{(1)} \rightarrow (\rho X_k)^{(2)}$
      without explicitly including the reaction terms,
\begin{equation}
(\rho X_k)^{(2)} = (\rho X_k)^{(1)} 
- \dt \; \left\{ \nablab \cdotb \left[\left(\uadvtwo+w_0^{\nph} \er\right)  
(\rho X_k)^{(1),\nph} \right] \right\}  \enskip ,
\end{equation}
\begin{equation}
\rho^{(2)} = \sum_k (\rho X_k)^{(2)} \enskip ,
\end{equation}
\begin{equation}
X_k^{(2)} = (\rho X_k)^{(2)} / \rho^{(2)}
\end{equation}

\end{enumerate}

\item Define an edge-centered $\etarho^{\nph}$:

\begin{description}

\item For plane-parallel,
\begin{equation}
 \etarho^{\nph} = {\rm {\bf Avg}} \sum_k \left [\left(\uadvtwo \cdotb \er + w_0^{\nph}\right) (\rho X_k)^{(1),\nph} \right] - w_0^{\nph} \rho_0^{\nph,{\rm pred}} \enskip ,
\end{equation}
\item For spherical, first construct 
$\eta_{\rho}^{{\rm cart},\nph} = [\rho'(\Ubt\cdot\eb_r)]^{n+\myhalf}$ using:
\begin{equation}
\eta_{\rho}^{{\rm cart},\nph} = \left[\left(\frac{\rho^{(1)}+\rho^{(2),\star}}{2}\right)-\left(\frac{\rho_0^n+\rho_0^{(2a),\star}}{2}\right)\right] \sum_d \left(\uadvtwo \cdot \eb_d\right)n_d.
\end{equation}
Then, $\etarho^{\nph}$ is the cell-centered average of $\eta_{\rho}^{{\rm cart},\nph}$,
\begin{equation}
\etarho^{\nph} = \overline{\eta_{\rho}^{{\rm cart},\nph}}.
\end{equation}
This gives a radial cell-centered $\etarho^{\nph}$.  To get $\etarho^{\nph}$ at 
radial edges, average the two neighboring radial bins.
\end{description}

\item {\bf Correct Base}$[\rho_0^{(2a)},\rho^{(2)}] \rightarrow [\rho_0^{n+1}]$.

\item {\bf Compute Gravity}$[\rho_0^{n+1}] \rightarrow [g^{n+1}]$.

Then, set $g^{n+\myhalf} = (g^n + g^{n+1})/2$.

%\item Update $p_0$ and compute $\psi$.
%\begin{description}
%\item For plane-parallel,\\
%{\bf Advect Base Pressure Planar}$[p_0^n, w_0^{\nph}, \etarho^{n+\myhalf}]$ 
%$\rightarrow [p_0^{n+1},\psi^{\nph}]$.
%\item For spherical,\\
%{\bf Advect Base Pressure Spherical}$[p_0^n,w_0^{\nph},\gammabar^{(1)},\overline{S^{\nph}},
%\rho^{(2)},X_k^{(2)}]$\\
%$~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% \rightarrow [p_0^{n+1},\psi^n,\psi^{\nph}]$.
%\end{description}
\item {\bf Enforce HSE}$[p_0^n,\rho_0^{n+1},g^{n+1}] \rightarrow [p_0^{n+1}]$.

\item Compute $\psi$.
\begin{description}
\item For plane-parallel, 
\begin{equation}
\psi_j^{n+\myhalf} = \frac{1}{2} \left(\eta_{\rho,j-\myhalf}^{n+\myhalf} 
+ \eta_{\rho,j+\myhalf}^{n+\myhalf}\right) g^{n+1} \enskip .
\end{equation}
\item For spherical, first compute:
\begin{equation}
\gammabar^{(2),\star} = {\rm{\bf Avg}} \left[ \Gamma_1\left(\rho^{(2),\star}, p_0^{n+1}, 
X_k^{(2),\star}\right) \right] \enskip .
\end{equation}
Then, define a base time and time-centered $\psi$:
\begin{equation}
\psi_j^{n} = 
\left(\gammabar^{(1)} p_0^n\right)_j
\left \{ \Sbar_j^{n+\myhalf} - 
\frac{1}{r_j^2} \left [ (r^2 w_0^{n+\myhalf})_{j+\myhalf} -
          (r^2 w_0^{n+\myhalf})_{j-\myhalf} \right ] \right \} \enskip ,
\end{equation}
\begin{eqnarray}
\psi_j^{n+\myhalf} &=& 
\left(\frac{\gammabar^{(1)}+\gammabar^{(2),\star}}{2}\right)_j
\left(\frac{p_0^n+p_0^{n+1}}{2}\right)_j \nonumber \\
&& \left \{ \Sbar_j^{n+\myhalf} - 
\frac{1}{r_j^2} \left [ (r^2 w_0^{n+\myhalf})_{j+\myhalf} -
          (r^2 w_0^{n+\myhalf})_{j-\myhalf} \right ] \right \} \enskip .
\end{eqnarray}
\end{description}

\item Update $(\rho h)_0$.
\begin{description}
\item For plane-parallel,\\
{\bf Advect Base Enthalpy Planar}$[(\rho h)_0^n, w_0^{\nph}, \psi^{\nph}]
\rightarrow [(\rho h)_0^{n+1}]$.
\item For spherical,\\
{\bf Advect Base Enthalpy Spherical}$[(\rho h)_0^n, w_0^{\nph}, \psi^n, \psi^{\nph}]
\rightarrow [(\rho h)_0^{n+1}]$.
\end{description}

\item Update the enthalpy, using a difference approximation to
  equation (\ref{eq:rhohupd}), neglecting the reaction terms.

  \begin{enumerate}
  \renewcommand{\labelenumii}{{\bf \roman{enumii}}.}

  \item Compute the enthalpy edge state, $(\rho h)^{(1),\nph}$, for
    the conservative update of $(\rho h)^{(1)}$. Here we predict 
    $(\rho h)' = (\rho h)^{(1)} - (\rho h)_0$
    to time-centered edges to obtain $(\rho h)^{'(1),\nph}$, 
    using a second-order unsplit Godunov procedure, 
    as described in paper II, Appendix A, using $\Vb =
    \uadvtwo+w_0^{\nph} \er$.  Again, we do not include the reaction
    terms in the enthalpy prediction since we accounted for them
    already in {\bf React State}. We use the base state enthalpy,
    $(\rho h)_0$, to convert these to edge states for $(\rho h)$,
\begin{equation}
(\rho h)^{(1),\nph} = 
(\rho h)^{'(1),\nph} + \frac{(\rho h)_0^n + (\rho h)_0^{n+1}}{2} \enskip .
\end{equation}
  In plane-parallel, we use 4th-order spatial averaging to compute $(\rho h)_0$
  on radial faces.  In spherical, we first map $h_0 \equiv (\rho h)_0/\rho_0$ 
  and $\rho_0$ to Cartesian cell-centers using the mapping in section 
  \ref{Sec:1D Cell-Centered to Cartesian Cell-Centered}, use 2nd-order spatial 
  averaging to compute $h_0$ and $\rho_0$ on all faces, and then multiply these 
  terms to get $(\rho h)_0$ on all faces.

\begin{description}
\item For plane-parallel,
\begin{eqnarray}
(\rho h)^{(2)} &=& (\rho h)^{(1)} - \dt \; \left\{ \nablab \cdotb \left[ \left(\uadvtwo+w_0^{\nph} \er\right)  
(\rho h)^{(1),\nph} \right] \right\} \nonumber \\
&& + \frac{\dt}{2} \; \left(\uadvtwo \cdotb \er\right)
\left [ \left(\frac{\partial p_0}{\partial r} \right)^{n}
      + \left(\frac{\partial p_0}{\partial r} \right)^{n+1}  \right ] 
+ \dt \; \psi^{\nph} \enskip ,
\end{eqnarray}

\item For spherical,
\begin{eqnarray}
(\rho h)^{(2)} &=& (\rho h)^{(1)} - \dt \; \left\{ \nablab \cdotb \left[ \left(\uadvtwo+w_0^{\nph} \er\right)  
(\rho h)^{(1),\nph} \right] \right\} \nonumber \\
    && + \dt \; \left \{ \nabla \cdot \left (\uadvtwo p_0^{\nph} \right ) 
       - p_0^{\nph} \nabla \cdot \uadvtwo \right \} \nonumber \\
    && + \dt \; \psi^{\nph} \enskip ,
\end{eqnarray}

\end{description}

\end{enumerate}

If {\tt do\_eos\_h\_above\_cutoff=T} (which is the default setting), then if
$\rho^{(2)} < {\tt base\_cutoff\_density}$, then we recompute enthalpy using
\begin{equation}
(\rho h)^{(2)} = \rho^{(2)}h\left(\rho^{(2)},p_0^{n+1},X_k^{(2)}\right).
\end{equation}

%--------------------------------------------------------------------------
% STEP 8.1
%--------------------------------------------------------------------------
\item If we are using thermal diffusion, diffuse the enthalpy through a time interval of 
$\dt$.  First, define $(\rho h)^{(1a)} = (\rho h)^{(2)}$.  We recompute $(\rho h)^{(2)}$ to 
account for thermal diffusion.  Compute $\kth^{(2),\star}, c_p^{(2),\star}$, and 
$\xi_k^{(2),\star}$, from $\rho^{(2),\star}, T^{(2),\star}$, and $X_k^{(2),\star}$ as inputs to 
the equation of state.  The update is given by
\begin{eqnarray}
(\rho h)^{(2)} &=& (\rho h)^{(1a)} + \frac{\dt}{2}\nabla\cdot\left(\frac{\kth^{(2),\star}}{c_p^{(2),\star}}\nabla h^{(2)} + \frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla X_k^{(2)} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla p_0^{n+1} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n}\right),
\end{eqnarray}
which is numerically implemented as a diffusion equation for $h^{(2)}$,
\begin{eqnarray}
\left(\rho^{(2)} - \frac{\dt}{2}\nabla\cdot\frac{\kth^{(2),\star}}{c_p^{(2),\star}}\nabla\right)h^{(2)} &=& (\rho h)^{(1a)} + \frac{\dt}{2}\nabla\cdot\frac{\kth^{(1)}}{c_p^{(1)}}\nabla h^{(1)}\nonumber\\
&&- \frac{\dt}{2}\sum_k\nabla\cdot\left(\frac{\xi_k^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla X_k^{(2)} + \frac{\xi_k^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla X_k^{(1)}\right)\nonumber\\
&&- \frac{\dt}{2}\nabla\cdot\left(\frac{h_p^{(2),\star}\kth^{(2),\star}}{c_p^{(2),\star}}\nabla p_0^{n+1} + \frac{h_p^{(1)}\kth^{(1)}}{c_p^{(1)}}\nabla p_0^{n}\right),
\end{eqnarray}
\item Update the temperature using the equation of state.  For plane-parallel we
update using
\begin{equation}
T^{(2)} = T\left(\rho^{(2)}, h^{(2)}, X_k^{(2)}\right) \enskip ,
\end{equation}
but in spherical, we set {\tt use\_tfromp = T}, and we use
\begin{equation}
T^{(2)} = T\left(\rho^{(2)}, p_0^{n+1}, X_k^{(2)}\right) \enskip .
\end{equation}
The latter has the effect of completely decoupling the enthalpy equation from the 
evolution.

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 9
%--------------------------------------------------------------------------
\item[Step 9.] {\em React the full state through a second time interval of $\dt / 2.$}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}

\item {\bf React State}$[\rho^{(2)},(\rho h)^{(2)}, X_k^{(2)},T^{(2)}, (\rho\Hext)^{(2)},
p_0^{n+1}]$\\
$~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\rightarrow [\rho^{n+1}, 
(\rho h)^{n+1}, X_k^{n+1}, T^{n+1}, (\rho \omegadot_k)^{(2)}, (\rho \Hnuc)^{(2)} ].$  

\item Define
\begin{eqnarray}
 \gammabar^{n+1}    &=& {\rm{\bf Avg}}\left[\Gamma_1\left(\rho^{n+1}, p_0^{n+1}, X_k^{n+1}\right) \right] \enskip , \\ 
 \beta_0^{n+1}    &=& \beta   \left(\rho_0^{n+1}, p_0^{n+1}, \gammabar^{n+1}, g^{n+1}\right) \enskip ,
\end{eqnarray}
where $\beta_0$ is computed as described in paper III, Appendix C.

\end{enumerate}

%--------------------------------------------------------------------------
% STEP 10
%--------------------------------------------------------------------------
\item[Step 10.] {\em Compute $S^{n+1}$ for the final projection.}

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}
\item Define
\begin{equation}
  S^{n+1} =  -\sigma  \sum_k  \xi_k (\omegadot_k)^{(2)}  + \sigma \Hnuc^{(2)} +
  \frac{1}{\rho p_\rho} \sum_k p_{X_k}  ({\omegadot}_k)^{(2)}  
   + \sigma \Hext + \frac{\sigma}{\rho}\nabla\cdot\kth\nabla T^{n+1} \enskip ,
\end{equation}
where $(\omegadot_k)^{(2)} = (\rho \omegadot_k)^{(2)} / \rho^{(2)}$
and the thermodynamic quantities are defined using $\rho^{n+1}, X_k^{n+1},$
and $T^{n+1}$ as inputs to the equation of state.

\item Compute
\begin{equation}
\overline{S^{n+1}} = {\mathrm{\bf Avg}} (S^{n+1}) \enskip.
\end{equation}

\end{enumerate}


%--------------------------------------------------------------------------
% STEP 11
%--------------------------------------------------------------------------
\item[Step 11.] {\em Update the velocity}.  

The velocity update happens analogously to paper II, using $S^{n+1}$ from step 10.
We update the velocity field $\Ubt^n$ to $\Ubt^{n+1,\star}$ by discretizing 
equation (\ref{eq:utildeupd}) as
\begin{eqnarray}
\Ubt^{n+1,\star} &=& \Ubt^n - \dt \;
 \left[\left(\uadvtwo+ w_0^{\nph} \er\right) \cdotb \nablab \Ubt \right]^\nph
      - \dt \; \left(\uadvtwo \cdotb \er\right)  \left(\frac{\partial w_0^{\nph}}{\partial r} \right) \er \nonumber \\
   &&   + \dt \left[ - \frac{1}{\rho^\nph} {\mathbf{G}} \pi^\nmh
        + \frac{1}{\rho_0} {\mathbf{G}} \pizerotwo
        - \frac{(\rho^\nph-\rhozero^\nph)}{\rho^\nph} g^{n+\myhalf} \er \right] \enskip ,
\end{eqnarray}
where $\rho^{\nph}$ is defined as
\begin{equation}
\rho^\nph = \frac{\rho^n + \rho^{n+1}}{2}\enskip ,
\end{equation}
and $\mathbf{G}$ approximates a cell-centered gradient from nodal data.
The construction of $[(\uadvtwo+ w_0^{\nph} \er \cdotb \nablab) \Ubt ]^\nph$
is described in paper II, Appendix A, with $\Vb = \uadvtwo+w_0^{\nph} \er$ and $s$ 
set to each component of $\Ubt^n$ individually.  Here, the $\star$ superscript 
does not refer to the predictor-corrector aspect of the algorithm, but rather 
than the updated velocity does not satisfy the divergence constraint.

Finally, we impose the divergence constraint from equation (\ref{eq:tildeconstraint}):
\begin{equation}
\nablab \cdotb \left(\beta_0^{\nph} \Ubt^{n+1} \right) 
= \beta_0^{\nph} \left(S^{n+1} - \overline{S^{n+1}} \right) \enskip,
\end{equation}
where $\beta_0^{n+\myhalf}$ is now defined as
\begin{equation}
\beta_0^{n+\myhalf} = \frac{\beta_0^n + \beta_0^{n+1}}{2}\enskip .
\end{equation}
The discretization with the volume discrepancy term is:
\begin{equation}
\nablab \cdotb \left(\beta_0^{\nph} \Ubt^{n+1} \right)  = \beta_0^{\nph}\left\{  \left(S^{n+1} - \overline{S^{n+1}} \right)
+ \frac{f}{\gammabar^{n+1} p_0^{n+1}}
\left[\frac{p(\rho,h,X_k)^{n+1} - \overline{p(\rho,h,X_k)^{n+1}}}{\Delta t^n}\right]\right\}
\enskip .
\end{equation}

To solve this equation, we define
${\bf V} = \Ubt^{n+1,\star} + ( \dt / \rho^\nph ) \; \mathbf{G} \pi^\nmh$ 
and solve
\begin{equation}
 L_\beta^\rho \phi = D \left ( \beta_0^{\nph} {\bf V} \right) - \beta_0^{\nph} 
\left(S^{n+1}-\overline{S^{n+1}} \right) \enskip, \label{Linear System for Multigrid}
\end{equation}
for nodal values of $\phi$, where $L_\beta^\rho$ is the standard bilinear
finite element approximation to $\nablab \cdotb ({\beta_0^\nph}/{\rho^\nph}) \nablab.$
The discretization with the volume discrepancy term is:
\begin{equation}
 L_\beta^\rho \phi =
   D \left ( \beta_0^{\nph} {\bf V} \right) - \beta_0^{\nph}\left\{ \left(S^{n+1}-\overline{S^{n+1}} \right)
- \frac{f}{\gammabar^{n+1} p_0^{n+1}}
\left[\frac{p(\rho,h,X_k)^{n+1} - \overline{p(\rho,h,X_k)^{n+1}}}{\Delta t^n}\right]\right\} \enskip.
\end{equation}
In this step, $D$ is a discrete second-order operator that approximates the 
divergence at nodes from cell-centered data and satisfies
$\mathbf{G} = -D^T.$ 
(See (cite almgrenBellSzymczak:1996) for a detailed discussion of this
approximate projection; see (cite almgren:bell:crutchfield) for a discussion
of this particular form of the projection operand.)  
We solve the linear system of equation (\ref{Linear System for Multigrid})
using multigrid V-cycles with Gauss-Seidel relaxation.

We determine the new time velocity field from
\begin{equation}
\Ubt^{n+1} = {\bf V} - \frac{1}{\rho^\nph} \mathbf{G} \phi \enskip ,
\end{equation}
and the new time-centered perturbational pressure from
\begin{equation}
  \pi^\nph = \frac{1}{\dt} \phi \enskip .
\end{equation}

%--------------------------------------------------------------------------
% STEP 12
%--------------------------------------------------------------------------
\item[Step 12.] {\em Compute a new $\dt.$}

Compute $\dt$ for the next time step with the procedure described in \S 3.4 of paper III
using $w_0$ as computed in step 6 and
$\Ubt^{n+1}$ as computed in step 11.  We use this $\dt$ in the next time step. 


\end{description}

\noindent This completes the time advancement of the algorithm.



%-----------------------------------------------------------------------------
% Initialization
%-----------------------------------------------------------------------------

\section{Initialization}\label{Sec:Initialization}

We start each calculation with user-specified initial values for
$\rho$, $X_k$ and $T,$ as well as an initial background state.  In
order for the low Mach number assumption to hold, the initial data
must be thermodynamically consistent with the initial background
state.  In addition, the initial velocity field must satisfy an
initial approximation to the divergence constraint.  We use an iterative
procedure to compute both an initial right-hand-side for the
constraint equation and an initial velocity field that satisfies
the constraint.  The user specifies the number of iterations,
$N_{\rm iters}^{S},$ in this first step of the initialization procedure.

The initial perturbational pressure also needs to be determined for
use in steps 2, 7 and 11. 
This is done through a second iterative procedure which follows the
time advancement algorithm as described in steps 1-11 in 
\S \ref{Sec:Time Advancement Algorithm}.  
The user specifies the number of iterations, 
$N_{\rm iters}^{\pi},$ in this second step of the initialization procedure.
The details for both iterations are given below.\\

%--------------------------------------------------------------------------
% STEP 0
%--------------------------------------------------------------------------
\noindent {\bf Step 0.} {\em Initialization}

First, we need to construct approximations to $S^0, w_0^{-\myhalf}, \Delta t^0$, 
and $\Ub^0$.  Start with initial data $X_k^{\initp}, \rho^{\initp},$ $T^{\initp},$ an 
initial base state, and an initial guess for the velocity, $\Ub^{\initp}$.
Set $w_0^0 = 0$ as an initial approximation.  Use the equation of state to 
determine $(\rho h)^{\initp}$.  Compute $\beta_0^0$ as a function of 
the initial data.  Then, project $\Ub^{\initp}$ using $\beta_0^0$ and 
$S = \rho\Hext$, giving $\Ub^{0,0}$.  The next part of the initialization process 
proceeds as follows.

\begin{enumerate}
\renewcommand{\theenumi}{{\bf \alph{enumi}}}
\renewcommand{\labelenumii}{\roman{enumii}.}

\item {\bf Do} {$\nu = 1,...,N_{\rm iters}^{S}$.}
  \begin{enumerate}

  \item Estimate $\Delta t^\nu$ using $\Ub^{0,\nu-1}$ and $w_0^{\nu-1}.$

  \item {\bf React State}$[ \rho^{\initp},(\rho h)^{\initp}, X_k^{\initp}, T^{\initp}, 
(\rho^{\initp} \Hext), p_0^{\initp}] \rightarrow [\rho^{\outp}, (\rho h)^{\outp}, 
X_k^{\outp}, T^{\outp}, (\rho \omegadot_k)^{0,\nu} ].$

  \item Compute $S^{0,\nu}$ from equation (\ref{eq:defineS}) 
        using $(\rho \omegadot_k)^{0,\nu}$ and the initial data.

  \item Compute $\overline{S^{0,\nu}} = {\mathrm{\bf Avg}} (S^{0,\nu}).$

  \item Compute $w_0^{\nu}$ as in step 1c using $\overline{S^{0,\nu}}$ and $\psi=0$.
        
  \item Project $\Ub^{0,\nu-1}$ using $\beta_0^0$ and 
        $(S^{0,\nu} - \overline{S^{0,\nu}})$ as the source term.  
        This yields $\Ub^{0,\nu}.$

  \end{enumerate}

  {\bf End do.}

  Define $S^0 = S^{0,N_{\rm iters}^S}$, $w_0^{-\myhalf} = w_0^{N_{\rm iters}^S}$, 
$\dt^0 = \Delta t^{N_{\rm iters}^S},$ and $\Ub^0 = \Ub^{0,N_{\rm iters}^S}.$

\end{enumerate}

Next, we need to construct approximations to $\etarho^{-\myhalf}, \psi^{-\myhalf}, S^1$,
and $\pi^{-\myhalf}$.  As initial approximations, set 
$\etarho^{-\myhalf}=0, \psi^{-\myhalf}=0, S^{1,0}=S^0$, and $\pi^{-\myhalf}=0.$
\begin{enumerate}
  \renewcommand{\theenumi}{{\bf \alph{enumi}}}
  \renewcommand{\labelenumii}{\roman{enumii}.}
  \addtocounter{enumi}{1}
  
\item {\bf Do} {$\nu = 1,...,N_{\rm iters}^{\pi}$.}
  
  \begin{enumerate}
  \item Perform steps 1--11 as described above, using 
    $S^{\myhalf,\star} = (S^0 + S^{1,\nu-1})/2$ in step 1 as described.
    The only other difference in the time advancement is that in step 11
    we define ${\bf V} = (\Ubt^{1,\star} - \Ubt^0)$ and solve
    \begin{equation}  L_\beta^\rho \phi =
      D \left ( \beta_0^{\myhalf} {\bf V} \right) - \beta_0^{\myhalf} \left[ \left(S^{1}-\overline{S^{1}}\right) - \left(S^{0}-\overline{S^{0}}\right) \right] \enskip . 
    \end{equation}
    (The motivation for this form of the projection in the initial pressure iterations
    is discussed in (cite almgren:bell:crutchfield).)
      We discard the new velocity resulting from this, but keep the new  
      value for $\pi^{\myhalf} = \pi^{-\myhalf} + (1 / \dt) \; \phi.$  
      These steps also yield new scalar data at time $\dt,$ which
      we discard,  and new values for $\etarho^{\myhalf}$ (step 8), $\psi^{\myhalf}$ (step 8), 
      $S^{1,\nu}$ (step 10), and $\pi^{\myhalf}$ (step 11), which we keep.
    \item Set $\pi^{-\myhalf} = \pi^{\myhalf}$, $\etarho^{-\myhalf} = \etarho^{\myhalf}$,
      and $\psi^{-\myhalf} = \psi^{\myhalf}$. 
    \end{enumerate}
    
    {\bf End do.}
    
    Finally, we define $S^1 = S^{1,N_{\rm iters}^\pi}.$
    
  \end{enumerate}
