\documentclass[11pt]{article} 

\tolerance=600

\usepackage{amsmath,color}

% Margins
\usepackage[lmargin=1.0in,rmargin=1.0in,tmargin=0.75in,bmargin=0.75in]{geometry}

\def\half  {\frac{1}{2}}
\def\dt    {\Delta t}

\def\edge  {\rm EDGE}
\def\mac   {\rm MAC}
\def\trans {\rm TRANS}

\def\eb    {{\bf e}}
\def\fb    {{\bf f}}
\def\ib    {{\bf i}}
\def\Ub    {{\bf U}}

\def\Ubt   {\widetilde{\bf U}}
\def\ut    {\tilde{u}}
\def\vt    {\tilde{v}}
\def\wt    {\tilde{w}}

\title{Notes on the Godunov Step in {\tt MAESTRO}}

\setlength{\marginparwidth}{0.75in}
\newcommand{\MarginPar}[1]{\marginpar{%
\vskip-\baselineskip %raise the marginpar a bit
\raggedright\tiny\sffamily
\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}

\maketitle

These are working notes for the Godunov step in {\tt MAESTRO}.
\section{Differences Between These Notes and the Code}
\begin{enumerate}
\item In both equations (\ref{Radial utrans_L}) and (\ref{Radial utrans_R}), we are omitting the terms in equation (\ref{Perturbational Velocity Equation}) proportional to $w_0$ (by using $\wt$ rather than $w$ as the advection speed) and $(\Ubt\cdot\eb_r)$ (by omitting the term altogether).
\item In equation (\ref{Force Term}), we do not include the term proportional to $\partial\pi_0/\partial r$.
\end{enumerate}
\section{Questions}
\begin{enumerate}
\item We need to re-examine when to include the term proportional to $(\Ubt\cdot\eb_r)$ in equation (\ref{Perturbational Velocity Equation}) when we do a 1D extrapolation of the radial velocity.  For example, equations (\ref{Radial utrans_L}) and (\ref{Radial utrans_R}) include it, but equations (\ref{1D wt_L extrap}) and (\ref{1D wt_R extrap}) do not.
\item In equations (\ref{wt_L Extrapolation}) and (\ref{wt_R Extrapolation}), we could also compute the term proportional to $\partial w_0/\partial r$ by averaging $w^{\trans}$.
\end{enumerate}
\section{Computing $\Ubt^{\trans}$}
In {\tt advance\_premac.f90}, we call the function {\tt mkutrans}, which computes the edge-centered transverse velocities, $\Ubt^{\trans}$.  These transverse velocities do not contain $w_0$, so immediately following the call to {\tt mkutrans}, we call {\tt addw0} to compute $\Ub^{\trans}$ from $\Ubt^{\trans}$.  We will only compute the normal component of velocity at each face.\\

The evolution equation for the perturbational velocity is:
\begin{equation}
\frac{\partial\Ubt}{\partial t} = -\Ubt\cdot\nabla\Ubt - w_0\frac{\partial\Ubt}{\partial r} - (\Ubt\cdot\eb_r)\frac{\partial w_0}{\partial r}\eb_r - \frac{1}{\rho}\nabla\pi + \frac{1}{\rho_0}\frac{\partial\pi_0}{\partial r}\eb_r - \frac{(\rho-\rho_0)}{\rho}g\eb_r.\label{Perturbational Velocity Equation}
\end{equation}
We are going to use a 1D Taylor series extrapolation in space and time to compute time-centered normal components of $\Ubt^{\trans}$ at face-centers.  By 1D, we mean that we omit any spatial derivatives that are not in the direction of the extrapolation.  We first compute ``left/right'' states, and then use a Riemann solver to pick the final state.
\subsection{2D Cartesian Case}
For the rest of this paper, for 2D Cartesian problems, $\Ub = (u,w)$ and $\Ubt = (u,\wt)$.  We will use the shorthand $\ib = (x,r)$.\\

For the x-faces, the 1D extrapolation of $u$ is:
\begin{eqnarray}
u_L &=& u_{\ib-\eb_x}^n + \left(\half - \frac{\dt}{2h}u_{\ib-\eb_x}^n\right)\Delta_x u_{\ib-\eb_x}^n, \\
u_R &=& u_{\ib}^n - \left(\half + \frac{\dt}{2h}u_{\ib}^n\right)\Delta_x u_{\ib}^n.
\end{eqnarray}
We pick the final edge states using a Riemann solver:
\begin{equation}
u^{\trans}_{\ib-\half\eb_x} =
\begin{cases}
0, & (u_L \le 0 ~ {\rm AND} ~ u_R \ge 0) ~ {\rm OR} ~ |u_L + u_R| < \epsilon, \\
u_L, & u_L + u_R > 0, \\
u_R, & u_L + u_R < 0, \\
\end{cases}
\end{equation}
For the r-faces, we choose include the radial derivative terms proportional to $w_0$ and $(\Ubt\cdot\eb_r) = \wt$.  The term proportional to $w_0$ is included by using $w$ rather than $\wt$ as the advection speed.  The term proportional to $\wt$ is an additional term.  For the r-faces, the 1D extrapolation of $\wt$ is:
\begin{eqnarray}
\wt_L &=& \wt_{\ib-\eb_r}^n + \left(\half - \frac{\dt}{2h}w_{\ib-\eb_r}^n\right)\Delta_r \wt_{\ib-\eb_r}^n - \frac{\dt}{2}\wt_{\ib-\eb_r}^n\left(\frac{\partial w_0}{\partial r}\right)_{\ib-\eb_r},\label{Radial utrans_L} \\
\wt_R &=& \wt_{\ib}^n - \left(\half + \frac{\dt}{2h}w_{\ib}^n\right)\Delta_r \wt_{\ib}^n - \frac{\dt}{2}\wt_{\ib}^n\left(\frac{\partial w_0}{\partial r}\right)_{\ib}.\label{Radial utrans_R}
\end{eqnarray}
The total radial velocity is defined as:
\begin{equation}
w_{\ib}^n = \wt_{\ib}^n + \frac{w_{0,r+\half}+w_{0,r-\half}}{2}.\label{Total Radial Velocity}
\end{equation}
The spatial derivatives of $w_0$ are given by the two-point centered difference:
\begin{equation}
\left(\frac{\partial w_0}{\partial r}\right)_{\ib} = \frac{w_{0,r+\half}-w_{0,r-\half}}{h}.\label{Radial Derivative of w_0}
\end{equation}
We pick the final edge states using:
\begin{equation}
\wt^{\trans}_{\ib-\half\eb_r} =
\begin{cases}
0, & (w_L \le 0 ~ {\rm AND} ~ w_R \ge 0) ~ {\rm OR} ~ |w_L + w_R| < \epsilon, \\
\wt_L, & w_L + w_R > 0, \\
\wt_R, & w_L + w_R < 0, \\
\end{cases}
\end{equation}
where $w_L = \wt_L + w_{0,r-\half}$ and $w_R = \wt_R + w_{0,r-\half}$.  Finally, we call {\tt addw0} to compute $w^{\trans}$ from $\wt^{\trans}$.
\subsection{3D Cartesian Case}
For the rest of this paper, for 3D Cartesian problems, $\Ub = (u,v,w)$ and $\Ubt = (u,v,\wt)$.  We will use the shorthand $\ib = (x,y,r)$.\\

The only difference between the 2D and 3D Cartesian cases is that we must also compute $v^{\trans}$.  The procedure is analogous to computing $u^{\trans}$.  For y-faces, the 1D extrapolation of $v$ is:
\begin{eqnarray}
v_L &=& v_{\ib-\eb_y}^n + \left(\half - \frac{\dt}{2h}v_{\ib-\eb_y}^n\right)\Delta_y v_{\ib-\eb_y}^n, \\
v_R &=& v_{\ib}^n - \left(\half + \frac{\dt}{2h}v_{\ib}^n\right)\Delta_y v_{\ib}^n,
\end{eqnarray}
\begin{equation}
v^{\trans}_{\ib-\half\eb_y} =
\begin{cases}
0, & (v_L \le 0 ~ {\rm AND} ~ v_R \ge 0) ~ {\rm OR} ~ |v_L + v_R| < \epsilon, \\
v_L, & v_L + v_R > 0, \\
v_R, & v_L + v_R < 0. \\
\end{cases}
\end{equation}
\subsection{3D Spherical Case}
For the rest of this paper, for 3D spherical problems, $\Ub = (u,v,w)$ and $\Ubt = (\ut,\vt,\wt)$.  We will use the shorthand $\ib = (x,y,z)$.\\

We first construct $\Ub$ by mapping $w_0$ onto a Cartesian array and adding it to $\Ubt$.  This is a spherical generalization of equation (\ref{Total Radial Velocity}).  We also map $\partial w_0/\partial r$ onto a Cartesian array.  This is a spherical generalization of equation (\ref{Radial Derivative of w_0}).  Then we use a 1D extrapolation analogous to equations equations (\ref{Radial utrans_L}) and (\ref{Radial utrans_R}).  For example, for x-faces:
\begin{eqnarray}
\ut_L &=& \ut_{\ib-\eb_x}^n + \left(\half - \frac{\dt}{2h}u_{\ib-\eb_x}^n\right)\Delta_x\ut_{\ib-\eb_x}^n - \frac{\dt}{2}\left[(\Ubt^n\cdot\eb_r)\left(\frac{\partial w_0}{\partial r}\right)(\eb_r\cdot\eb_x)\right]_{\ib-\eb_x}, \\
\ut_R &=& \ut_{\ib}^n - \left(\half + \frac{\dt}{2h}u_{\ib}^n\right)\Delta_x\ut_{\ib}^n - \frac{\dt}{2}\left[(\Ubt^n\cdot\eb_r)\left(\frac{\partial w_0}{\partial r}\right)(\eb_r\cdot\eb_x)\right]_{\ib}.
\end{eqnarray}
Then, we use the same Riemann solver as the Cartesian case to obtain $\ut^{\trans}$.  To compute $\vt^{\trans}$ (or $\wt^{\trans}$), simply replace all instaces of $\ut$ with $\vt$ (or $\wt$) and all instaces of $x$ with $y$ (or $z$).  Finally, we call {\tt addw0} to compute $\Ub^{\trans}$ from $\Ubt^{\trans}$.
\section{Computing $\Ubt^{\mac,*}$}
In {\tt advance\_premac.f90}, we call {\tt make\_edge\_state} to compute $\Ubt^{\mac,*}$.  We will only compute the normal component of velocity at each face.
\subsection{2D Cartesian Case}
We begin by computing a time-centered 1D extrapolation of $u$ to r-faces:
\begin{eqnarray}
u_L^{1D} &=& u_{\ib-\eb_r}^n + \left(\half - \frac{\dt}{2h}w_{\ib-\eb_r}^n\right)\Delta_r u_{\ib-\eb_r}^n, \\
u_R^{1D} &=& u_{\ib} - \left(\half + \frac{\dt}{2h}w_{\ib}^n\right)\Delta_r u_{\ib}^n.
\end{eqnarray}
Then we upwind based on $w^{\trans}$:
\begin{equation}
u_{\ib-\half\eb_r}^{1D} =
\begin{cases}
\half(u_L^{1D} + u_R^{1D}), & \left|w^{\trans}_{\ib-\half\eb_r}\right| < \epsilon \\
u_L^{1D}, & w^{\trans}_{\ib-\half\eb_r} > 0, \\
u_R^{1D}, & w^{\trans}_{\ib-\half\eb_r} < 0. \\
\end{cases}
\end{equation}
Then, we do a full-dimensional extrapolation of $u$ to x-faces:
\begin{eqnarray}
u_L &=& u_{\ib-\eb_x}^n + \left(\half - \frac{\dt}{2h}u_{\ib-\eb_x}\right)\Delta_x u_{\ib-\eb_x}^n + \frac{\dt}{2}f_{u,\ib-\eb_x} \nonumber \\
&& - \frac{\dt}{4h}\left(w_{\ib-\eb_x+\half\eb_r}^{\trans}+w_{\ib-\eb_x-\half\eb_r}^{\trans}\right)\left(u_{\ib-\eb_x+\half\eb_r}^{1D} - u_{\ib-\eb_x-\half\eb_r}^{1D}\right), \\
u_R &=& u_{\ib}^n - \left(\half + \frac{\dt}{2h}u_{\ib}\right)\Delta_x u_{\ib}^n + \frac{\dt}{2}f_{u,\ib} \nonumber \\
&& - \frac{\dt}{4h}\left(w_{\ib+\half\eb_r}^{\trans}+w_{\ib-\half\eb_r}^{\trans}\right)\left(u_{\ib+\half\eb_r}^{1D} - u_{\ib-\half\eb_r}^{1D}\right),
\end{eqnarray}
where the force term is given by:
\begin{equation}
\fb =
\left(\begin{array}{c}
f_u \\
f_w \\
\end{array}\right)
= \frac{1}{\rho}\nabla\pi + \frac{1}{\rho_0}\frac{\partial\pi_0}{\partial r}\eb_r - \frac{(\rho-\rho_0)}{\rho}g\eb_r.\label{Force Term}
\end{equation}
Finally, we solve a Riemann problem:
\begin{equation}
u_{\ib-\half\eb_x}^{\mac,*} =
\begin{cases}
0, & \left(u_L \le 0 ~ {\rm AND} ~ u_R \ge 0\right) ~ {\rm OR} ~ \left|u_L + u_R\right| < \epsilon, \\
u_L, & u_L + u_R > 0, \\
u_R, & u_L + u_R < 0. 
\end{cases}
\end{equation}

To compute $\wt^{\mac,*}$, we use an analogous procedure for computing $u^{\mac,*}$, except that we need to incorporate the terms in equation (\ref{Perturbational Velocity Equation}) proportional to $w_0$ and $\partial w_0/\partial r$ into the full-dimensional extrapolation.  We compute a time-centered 1D extrapolation of $\wt$ to x-faces:
\begin{eqnarray}
\wt_L^{1D} &=& \wt_{\ib-\eb_x}^n + \left(\half - \frac{\dt}{2h}u_{\ib-\eb_x}^n\right)\Delta_x \wt_{\ib-\eb_x}^n, \\
\wt_R^{1D} &=& \wt_{\ib} - \left(\half + \frac{\dt}{2h}u_{\ib}^n\right)\Delta_x \wt_{\ib}^n.
\end{eqnarray}
Then we upwind based on $u^{\trans}$:
\begin{equation}
\wt_{\ib-\half\eb_x}^{1D} =
\begin{cases}
\half(\wt_L^{1D} + \wt_R^{1D}), & \left|u^{\trans}_{\ib-\half\eb_x}\right| < \epsilon \\
\wt_L^{1D}, & u^{\trans}_{\ib-\half\eb_x} > 0, \\
\wt_R^{1D}, & u^{\trans}_{\ib-\half\eb_x} < 0. \\
\end{cases}
\end{equation}
Then, we do a full-dimensional extrapolation of $\wt$ to r-faces, incorporating the extra term proportional to $w_0$ by using $w$ instead of $\wt$ as the advection velocity and the extra term proportional to $\partial w_0/\partial r$ as a separate term:
\begin{eqnarray}
\wt_L &=& \wt_{\ib-\eb_r}^n + \left(\half - \frac{\dt}{2h}w_{\ib-\eb_r}\right)\Delta_r \wt_{\ib-\eb_r}^n + \frac{\dt}{2}f_{w,\ib-\eb_r} \nonumber \\
&& - \frac{\dt}{4h}\left(u_{\ib+\half\eb_x-\eb_r}^{\trans}+u_{\ib-\half\eb_x-\eb_r}^{\trans}\right)\left(\wt_{\ib+\half\eb_x-\eb_r}^{1D} - \wt_{\ib-\half\eb_x-\eb_r}^{1D}\right) \nonumber \\
&& - \frac{\dt}{2h}\wt_{\ib-\eb_r}(w_{0,j-\half} - w_{0,j-\frac{3}{2}}),\label{wt_L Extrapolation} \\
\wt_R &=& \wt_{\ib}^n - \left(\half + \frac{\dt}{2h}w_{\ib}\right)\Delta_r \wt_{\ib}^n + \frac{\dt}{2}f_{w,\ib} \nonumber \\
&& - \frac{\dt}{4h}\left(u_{\ib+\half\eb_x}^{\trans}+u_{\ib-\half\eb_x}^{\trans}\right)\left(\wt_{\ib+\half\eb_x}^{1D} - \wt_{\ib-\half\eb_x}^{1D}\right) \nonumber \\
&& - \frac{\dt}{2h}\wt_{\ib}(w_{0,j+\half} - w_{0,j-\half}).\label{wt_R Extrapolation}
\end{eqnarray}
Next, we solve a Riemann problem:
\begin{equation}
\wt_{\ib-\half\eb_r}^{\mac,*} =
\begin{cases}
0, & \left(w_L \le 0 ~ {\rm AND} ~ w_R \ge 0\right) ~ {\rm OR} ~ \left|w_L + w_R\right| < \epsilon, \\
\wt_L, & w_L + w_R > 0, \\
\wt_R, & w_L + w_R < 0. 
\end{cases}
\end{equation}
Finally, we call {\tt addw0} to compute $\Ub^{\mac,*}$ from $\Ubt^{\mac,*}$.
\subsection{3D Cartesian Case}
\subsection{3D Spherical Case}
\section{Computing $\rho^{'\edge}, X_k^{\edge}, h^{\edge},$ and $T^{\edge}$}
\subsection{2D Cartesian Case}
\subsection{3D Cartesian Case}
\subsection{3D Spherical Case}
\section{Computing $\Ubt^{\edge}$}
In {\tt velocity\_advance.f90}, we call {\tt make\_edge\_state} to compute $\Ubt^{\edge}$.  Unlike when we computed $\Ubt^{\trans}$ and $\Ubt^{\mac,*}$, we need all components of velocity at each face.
\subsection{2D Cartesian Case}
We begin by computing a time-centered 1D extrapolation of $u$ to all faces.  The extrapolation of $u$ to x-faces is:
\begin{eqnarray}
u_{L,\ib-\half\eb_x}^{1D} &=& u_{\ib-\eb_x}^n + \left(\half - \frac{\dt}{2h}u_{\ib-\eb_x}^n\right)\Delta_x u_{\ib-\eb_x}^n, \\
u_{R,\ib-\half\eb_x}^{1D} &=& u_{\ib} - \left(\half + \frac{\dt}{2h}u_{\ib}^n\right)\Delta_x u_{\ib}^n.
\end{eqnarray}
Then we upwind based on $u^{\trans}$:
\begin{equation}
u_{\ib-\half\eb_x}^{1D} =
\begin{cases}
\half(u_{L,\ib-\half\eb_x}^{1D} + u_{R,\ib-\half\eb_x}^{1D}), & \left|u^{\trans}_{\ib-\half\eb_x}\right| < \epsilon \\
u_{L,\ib-\half\eb_x}^{1D}, & u^{\trans}_{\ib-\half\eb_x} > 0, \\
u_{R,\ib-\half\eb_x}^{1D}, & u^{\trans}_{\ib-\half\eb_x} < 0. \\
\end{cases}
\end{equation}
The extrapolation of $u$ to r-faces is:
\begin{eqnarray}
u_{L,\ib-\half\eb_r}^{1D} &=& u_{\ib-\eb_r}^n + \left(\half - \frac{\dt}{2h}w_{\ib-\eb_r}^n\right)\Delta_r u_{\ib-\eb_r}^n, \\
u_{R,\ib-\half\eb_r}^{1D} &=& u_{\ib} - \left(\half + \frac{\dt}{2h}w_{\ib}^n\right)\Delta_r u_{\ib}^n.
\end{eqnarray}
Then we upwind based on $w^{\trans}$:
\begin{equation}
u_{\ib-\half\eb_r}^{1D} =
\begin{cases}
\half(u_{L,\ib-\half\eb_r}^{1D} + u_{R,\ib-\half\eb_r}^{1D}), & \left|w^{\trans}_{\ib-\half\eb_r}\right| < \epsilon \\
u_{L,\ib-\half\eb_r}^{1D}, & w^{\trans}_{\ib-\half\eb_r} > 0, \\
u_{R,\ib-\half\eb_r}^{1D}, & w^{\trans}_{\ib-\half\eb_r} < 0. \\
\end{cases}
\end{equation}
We repeat this procedure to compute a time-centered 1D extrapolation of $\wt$ at each face.  The extrapolation of $\wt$ to x-faces is:
\begin{eqnarray}
\wt_{L,\ib-\half\eb_x}^{1D} &=& \wt_{\ib-\eb_x}^n + \left(\half - \frac{\dt}{2h}u_{\ib-\eb_x}^n\right)\Delta_x \wt_{\ib-\eb_x}^n, \\
\wt_{R,\ib-\half\eb_x}^{1D} &=& \wt_{\ib} - \left(\half + \frac{\dt}{2h}u_{\ib}^n\right)\Delta_x \wt_{\ib}^n.
\end{eqnarray}
Then we upwind based on $u^{\trans}$:
\begin{equation}
\wt_{\ib-\half\eb_x}^{1D} =
\begin{cases}
\half(\wt_{L,\ib-\half\eb_x}^{1D} + \wt_{R,\ib-\half\eb_x}^{1D}), & \left|u^{\trans}_{\ib-\half\eb_x}\right| < \epsilon \\
\wt_{L,\ib-\half\eb_x}^{1D}, & u^{\trans}_{\ib-\half\eb_x} > 0, \\
\wt_{R,\ib-\half\eb_x}^{1D}, & u^{\trans}_{\ib-\half\eb_x} < 0. \\
\end{cases}
\end{equation}
The extrapolation of $\wt$ to r-faces is:
\begin{eqnarray}
\wt_{L,\ib-\half\eb_r}^{1D} &=& \wt_{\ib-\eb_r}^n + \left(\half - \frac{\dt}{2h}w_{\ib-\eb_r}^n\right)\Delta_r \wt_{\ib-\eb_r}^n, \label{1D wt_L extrap} \\
\wt_{R,\ib-\half\eb_r}^{1D} &=& \wt_{\ib} - \left(\half + \frac{\dt}{2h}w_{\ib}^n\right)\Delta_r \wt_{\ib}^n. \label{1D wt_R extrap}
\end{eqnarray}
Then we upwind based on $w^{\trans}$:
\begin{equation}
\wt_{\ib-\half\eb_r}^{1D} =
\begin{cases}
\half(\wt_{L,\ib-\half\eb_r}^{1D} + \wt_{R,\ib-\half\eb_r}^{1D}), & \left|w^{\trans}_{\ib-\half\eb_r}\right| < \epsilon \\
\wt_{L,\ib-\half\eb_r}^{1D}, & w^{\trans}_{\ib-\half\eb_r} > 0, \\
\wt_{R,\ib-\half\eb_r}^{1D}, & w^{\trans}_{\ib-\half\eb_r} < 0. \\
\end{cases}
\end{equation}
Now we do a full-dimensional extrapolation of $u$ to each face.  The extrapolation of $u$ to x-faces is:
\begin{eqnarray}
u_{L,\ib-\half\eb_x}^{\edge} &=& u_{\ib-\eb_x}^n + \left(\half - \frac{\dt}{2h}u_{\ib-\half\eb_x}^{\mac}\right)\Delta_x u_{\ib-\eb_x}^n + \frac{\dt}{2}f_{u,\ib-\eb_x} \nonumber \\
&& - \frac{\dt}{4h}\left(w_{\ib-\eb_x+\half\eb_r}^{\trans}+w_{\ib-\eb_x-\half\eb_r}^{\trans}\right)\left(u_{\ib-\eb_x+\half\eb_r}^{1D} - u_{\ib-\eb_x-\half\eb_r}^{1D}\right), \\
u_{R,\ib-\half\eb_x}^{\edge} &=& u_{\ib}^n - \left(\half + \frac{\dt}{2h}u_{\ib-\half\eb_x}^{\mac}\right)\Delta_x u_{\ib}^n + \frac{\dt}{2}f_{u,\ib} \nonumber \\
&& - \frac{\dt}{4h}\left(w_{\ib+\half\eb_r}^{\trans}+w_{\ib-\half\eb_r}^{\trans}\right)\left(u_{\ib+\half\eb_r}^{1D} - u_{\ib-\half\eb_r}^{1D}\right).
\end{eqnarray}
Then, we upwind based on $u^{\mac}$.
\begin{equation}
u_{\ib-\half\eb_x}^{\edge} =
\begin{cases}
\half(u_{L,\ib-\half\eb_x}^{\edge} + u_{R,\ib-\half\eb_x}^{\edge}), & \left|u^{\mac}_{\ib-\half\eb_x}\right| < \epsilon \\
u_{L,\ib-\half\eb_x}^{\edge}, & u^{\mac}_{\ib-\half\eb_x} > 0, \\
u_{R,\ib-\half\eb_x}^{\edge}, & u^{\mac}_{\ib-\half\eb_x} < 0.
\end{cases}
\end{equation}
The full-dimensional extrapolation of $u$ to r-faces is:
\begin{eqnarray}
u_{L,\ib-\half\eb_r}^{\edge} &=& u_{\ib-\eb_r}^n + \left(\half - \frac{\dt}{2h}w_{\ib-\half\eb_r}^{\mac}\right)\Delta_r u_{\ib-\eb_r}^n + \frac{\dt}{2}f_{u,\ib-\eb_r} \nonumber \\
&& - \frac{\dt}{4h}\left(u_{\ib+\half\eb_x-\eb_r}^{\trans}+u_{\ib-\half\eb_x-\eb_r}^{\trans}\right)\left(u_{\ib+\half\eb_x-\eb_r}^{1D} - u_{\ib-\half\eb_x-\eb_r}^{1D}\right),  \\
u_{R,\ib-\half\eb_r}^{\edge} &=& u_{\ib}^n - \left(\half + \frac{\dt}{2h}w_{\ib-\half\eb_r}^{\mac}\right)\Delta_r u_{\ib}^n + \frac{\dt}{2}f_{u,\ib} \nonumber \\
&& - \frac{\dt}{4h}\left(u_{\ib+\half\eb_x}^{\trans}+u_{\ib-\half\eb_x}^{\trans}\right)\left(u_{\ib+\half\eb_x}^{1D} - u_{\ib-\half\eb_x}^{1D}\right). 
\end{eqnarray}
Then, we upwind based on $w^{\mac}$.
\begin{equation}
u_{\ib-\half\eb_r}^{\edge} =
\begin{cases}
\half(u_{L,\ib-\half\eb_r}^{\edge} + u_{R,\ib-\half\eb_r}^{\edge}), & \left|w^{\mac}_{\ib-\half\eb_r}\right| < \epsilon \\
u_{L,\ib-\half\eb_r}^{\edge}, & u^{\mac}_{\ib-\half\eb_r} > 0, \\
u_{R,\ib-\half\eb_r}^{\edge}, & u^{\mac}_{\ib-\half\eb_r} < 0.
\end{cases}
\end{equation}
Now we do a full-dimensional extrapolatino of $\wt$ to each face.  This is different from the extrapolation of $u$ to faces because we must include the term proportional to $\partial w_0/\partial r$ in equation (\ref{Perturbational Velocity Equation}).  The full-dimensional extrapolation of $\wt$ to x-faces is:
\begin{eqnarray}
\wt_{L,\ib-\half\eb_x}^{\edge} &=& \wt_{\ib-\eb_x}^n + \left(\half - \frac{\dt}{2h}u_{\ib-\half\eb_x}^{\mac}\right)\Delta_x \wt_{\ib-\eb_x}^n + \frac{\dt}{2}f_{w,\ib-\eb_x} \nonumber \\
&& - \frac{\dt}{4h}\left(w_{\ib-\eb_x+\half\eb_r}^{\trans}+w_{\ib-\eb_x-\half\eb_r}^{\trans}\right)\left(\wt_{\ib-\eb_x+\half\eb_r}^{1D} - \wt_{\ib-\eb_x-\half\eb_r}^{1D}\right) \nonumber \\
&& - \frac{\dt}{4h}\left(\wt_{\ib-\eb_x+\half\eb_r}^{\trans}+\wt_{\ib-\eb_x-\half\eb_r}^{\trans}\right)\left(w_{0,\ib-\eb_x+\half\eb_r}-w_{0,\ib-\eb_x-\half\eb_r}\right), \\
\wt_{R,\ib-\half\eb_x}^{\edge} &=& \wt_{\ib}^n - \left(\half + \frac{\dt}{2h}u_{\ib-\half\eb_x}^{\mac}\right)\Delta_x \wt_{\ib}^n + \frac{\dt}{2}f_{w,\ib} \nonumber \\
&& - \frac{\dt}{4h}\left(w_{\ib+\half\eb_r}^{\trans}+w_{\ib-\half\eb_r}^{\trans}\right)\left(\wt_{\ib+\half\eb_r}^{1D} - \wt_{\ib-\half\eb_r}^{1D}\right) \nonumber \\
&& - \frac{\dt}{4h}\left(\wt_{\ib+\half\eb_r}^{\trans}+\wt_{\ib-\half\eb_r}^{\trans}\right)\left(w_{0,\ib+\half\eb_r}-w_{0,\ib-\half\eb_r}\right).
\end{eqnarray}
Then, we upwind based on $u^{\mac}$:
\begin{equation}
\wt_{\ib-\half\eb_x}^{\edge} =
\begin{cases}
\half(\wt_{L,\ib-\half\eb_x}^{\edge} + \wt_{R,\ib-\half\eb_x}^{\edge}), & \left|u^{\mac}_{\ib-\half\eb_x}\right| < \epsilon \\
\wt_{L,\ib-\half\eb_x}^{\edge}, & u^{\mac}_{\ib-\half\eb_x} > 0, \\
\wt_{R,\ib-\half\eb_x}^{\edge}, & u^{\mac}_{\ib-\half\eb_x} < 0.
\end{cases}
\end{equation}
The full-dimensional extrapolation of $\wt$ to r-faces is:
\begin{eqnarray}
\wt_{L,\ib-\half\eb_r}^{\edge} &=& \wt_{\ib-\eb_r}^n + \left(\half - \frac{\dt}{2h}w_{\ib-\half\eb_r}^{\mac}\right)\Delta_r \wt_{\ib-\eb_r}^n + \frac{\dt}{2}f_{w,\ib-\eb_r} \nonumber \\
&& - \frac{\dt}{4h}\left(u_{\ib+\half\eb_x-\eb_r}^{\trans}+u_{\ib-\half\eb_x-\eb_r}^{\trans}\right)\left(\wt_{\ib+\half\eb_x-\eb_r}^{1D} - \wt_{\ib-\half\eb_x-\eb_r}^{1D}\right) \nonumber \\
&& -
\frac{\dt}{4h}\left(\wt_{\ib-\half\eb_r}^{\trans}+\wt_{\ib-\frac{3}{2}\eb_r}^{\trans}\right)\left(w_{0,\ib-\half\eb_r}-w_{0,\ib-\frac{3}{2}\eb_r}\right),\\
\wt_{R,\ib-\half\eb_r}^{\edge} &=& \wt_{\ib}^n + \left(\half - \frac{\dt}{2h}w_{\ib-\half\eb_r}^{\mac}\right)\Delta_r \wt_{\ib}^n + \frac{\dt}{2}f_{w,\ib} \nonumber \\
&& - \frac{\dt}{4h}\left(u_{\ib+\half\eb_x}^{\trans}+u_{\ib-\half\eb_x}^{\trans}\right)\left(\wt_{\ib+\half\eb_x}^{1D} - \wt_{\ib-\half\eb_x}^{1D}\right) \nonumber \\
&& -
\frac{\dt}{4h}\left(\wt_{\ib-\half\eb_r}^{\trans}+\wt_{\ib+\half\eb_r}^{\trans}\right)\left(w_{0,\ib+\half\eb_r}-w_{0,\ib-\half\eb_r}\right).
\end{eqnarray}
Then, we upwind based on $w^{\mac}$:
\begin{equation}
\wt_{\ib-\half\eb_r}^{\edge} =
\begin{cases}
\half(\wt_{L,\ib-\half\eb_r}^{\edge} + \wt_{R,\ib-\half\eb_r}^{\edge}), & \left|w^{\mac}_{\ib-\half\eb_r}\right| < \epsilon \\
\wt_{L,\ib-\half\eb_r}^{\edge}, & w^{\mac}_{\ib-\half\eb_r} > 0, \\
\wt_{R,\ib-\half\eb_r}^{\edge}, & w^{\mac}_{\ib-\half\eb_r} < 0.
\end{cases}
\end{equation}
\subsection{3D Cartesian Case}
\subsection{3D Spherical Case}
\cleardoublepage
\section{Forces}
\begin{table*}
\begin{center}
\caption{Forcing term into make edge scal \newline}
\begin{tabular}{|c|c|c|}
\multicolumn{1}{c}{PRED X}   & \multicolumn{1}{c}{Force} \\
\hline
  &   \\
T $(X)$ & $0$ \\
  &   \\
T $(\rho^\prime)$ & $-\rho^\prime \; \nabla \cdot (\ut+w_0 \eb_r) - \nabla \cdot (\ut \rho_0) $  \\
  &   \\
\hline
\end{tabular}
\end{center}
\begin{center}
\begin{tabular}{|c|c|}
\multicolumn{1}{c}{H PRED TYPE}   & \multicolumn{1}{c}{Force} \\
\hline
   & \\
 1 $((\rho h)^\prime)$ &  $(\tilde{w} \frac{\partial p_0}{\partial r}) - (\rho h)^\prime \; \nabla \cdot (\ut+w_0 \eb_r) - \nabla \cdot (\ut (\rho h)_0) $  \\
   & \\
 2 $(h)$ & $\frac{1}{\rho} (\psi + \tilde{w} \frac{\partial p_0}{\partial r})$  \\
   & \\
 3 $(T)$ & $\frac{1}{\rho c_p} \left[ (1 - \rho h_p) (\psi + \tilde{w} \frac{\partial p_0}{\partial r}) \right]$ \\
   & \\
 4 $(T)$ & $\frac{1}{\rho c_p} \left[ (1 - \rho h_p) (\psi + \tilde{w} \frac{\partial p_0}{\partial r}) \right]$ \\
   & \\
\hline
\end{tabular}
\end{center}
\end{table*}


\begin{table*}
\begin{center}
\caption{Quantity that goes into and out of make edge scal \newline}
\begin{tabular}{|c|c|c|c|}
\multicolumn{2}{c}{PREDICT} & \multicolumn{1}{c}{} & \multicolumn{1}{c}{} \\
\multicolumn{1}{c}{X} & \multicolumn{1}{c}{h pred type} & \multicolumn{1}{c}{Species } & \multicolumn{1}{c}{h/T } \\
\hline
T & 1 & $X$ and $\rho^\prime$ & $(\rho h)^\prime$ \\
T & 2 & $X$ and $\rho^\prime$ & $h$  \\
T & 3 & $X$ and $\rho^\prime$ & $T$  \\
T & 4 & $X$ and $\rho^\prime$ & $T$  \\
\hline
\end{tabular}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{When predicting temp ... \newline}
\begin{tabular}{|c|c|c|c|c|}
\multicolumn{1}{c}{PRED X} & \multicolumn{1}{c}{type} & \multicolumn{1}{c}{Inputs } & 
\multicolumn{1}{c}{EOS inputs} & \multicolumn{1}{c}{output} \\
\hline
T & 3 & $X$ and $\rho^\prime$ & $\rho = \rho_0 + \rho^\prime$ &  $(\rho h)^\prime = \rho h - (\rho h)_0$ \\
  &   &                   & $   X = $ given & \\
  &   &                   &                 & \\
T & 4 & $X$ and $\rho^\prime$ & $\rho = \rho_0 + \rho^\prime$ & $h$ \\
  &   &                   & $   X = $ given & \\
  &   &                   &                 & \\
\hline
\end{tabular}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Quantity that goes into mkflux on edges \newline}
\begin{tabular}{|c|c|c|c|c|}
\multicolumn{2}{c}{PREDICT} & \multicolumn{1}{c}{} & \multicolumn{1}{c}{} \\
\multicolumn{1}{c}{X} & \multicolumn{1}{c}{h pred type} & \multicolumn{1}{c}{Species } & \multicolumn{1}{c}{h/T } & \multicolumn{1}{c}{$\rho^\prime$} \\
\hline
T & 1 & $X$ and $\rho^\prime$ & $(\rho h)^\prime$ & \\
T & 2 & $X$ and $\rho^\prime$ & $h$ & \\
T & 3 & $X$ and $\rho^\prime$ & $(\rho h)^\prime$ & \\
T & 4 & $X$ and $\rho^\prime$ & $h$ & \\
\hline
\end{tabular}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Quantity that is created in mkflux and passed into update scal\newline}
\begin{tabular}{|c|c|c|c|c|c|c|c|}
\multicolumn{2}{c}{PREDICT}   & 
\multicolumn{1}{c}{} & \multicolumn{1}{c}{}  
& \multicolumn{2}{c}{Add db?} & \multicolumn{2}{c}{Forcing term }\\
\multicolumn{1}{c}{X}   & \multicolumn{1}{c}{type} &
\multicolumn{1}{c}{Species } & \multicolumn{1}{c}{$(\rho h)$} 
& \multicolumn{1}{c}{X} & \multicolumn{1}{c}{h} & \multicolumn{1}{c}{$(\rho X)$} & \multicolumn{1}{c}{$(\rho h)$} \\
\hline
T & 1 & $(\ut+w_0)(\rho_0+\rho^\prime) X          $ & $(\ut+w_0)(\rho h)^\prime + \ut (\rho h)_0$ & N & Y & 0 & $ (\tilde{w} \frac{\partial p_0}{\partial r}) $ \\
T & 2 & $(\ut+w_0)(\rho_0+\rho^\prime) X          $ & $(\ut+w_0) (\rho_0+\rho^\prime) h$ & N & N & 0 & $ (\psi + \tilde{w} \frac{\partial p_0}{\partial r}) $ \\
T & 3 & $(\ut+w_0)(\rho_0+\rho^\prime) X          $ & $(\ut+w_0)(\rho h)^\prime + \ut (\rho h)_0$ & N & Y & 0 & $ (\tilde{w} \frac{\partial p_0}{\partial r}) $ \\
T & 4 & $(\ut+w_0)(\rho_0+\rho^\prime) X          $ & $(\ut+w_0) (\rho_0+\rho^\prime) h$ & N & N & 0 & $ (\psi + \tilde{w} \frac{\partial p_0}{\partial r}) $ \\
\hline
\end{tabular}
\end{center}
\end{table*}

\end{document}
