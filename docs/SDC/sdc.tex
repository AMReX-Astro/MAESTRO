\section{SDC Overview}

\maestro\ integrates the following system of equations:
\begin{eqnarray}
\frac{\partial\Ub}{\partial t} &=& 
    -\Ub\cdot\nabla\Ub  - \frac{1}{\rho}\nabla\pi 
    - \frac{\rho-\rho_0}{\rho} g\eb_r,\label{eq:momentum}\\
\frac{\partial(\rho X_k)}{\partial t} &=& 
    -\nabla\cdot(\rho X_k\Ub) + \rho\omegadot_k,\label{eq:species}\\
\frac{\partial(\rho h)}{\partial t} &=& 
    -\nabla\cdot(\rho h\Ub) + \frac{Dp_0}{Dt} 
    + \rho\Hnuc ,\label{eq:enthalpy}
\end{eqnarray}
together with a constraint equation.

By default, \maestro\ uses an operator-split approach to coupling
the different physical processes together (hydro, reactions, diffusion).
With operator-splitting, we
react for a half timestep, then perform the hydrodynamics and thermal
diffusion on this intermediate state, and finally react for the
remaining half timestep to advance the solution.  For problems where
the reactions greatly alter the energy balance or composition, this
operator splitting approach can lead to inaccuracies in the solution.
This can be more of an issue for low Mach number methods that can take
large hydrodynamic time steps.

An alternate approach to coupling is spectral deferred corrections
(SDC). SDC is an iterative approach to couple the various operations
together, with each operator seeing an iteratively lagged
approximation of the other operations as a source term.  The SDC
algorithm converges to an integral representation of the solution in
time that couples all of the processes together in a self-consistent
fashion, see \cite{Non11}.

As a first attempt, we will work on coupling hydro and reactions only
via SDC, with a time-independent base state.  



\section{Strang-split Overview}

In the Strang-split version of \maestro, the reaction and advection
processes operate independent of one-another.  The species and
enthalpy equations are updated through $\Delta t$ using the following
sequence:

\begin{itemize}

\item React for $\Delta t/2$

In the Strang-split version of \maestro, the reaction network solves just
the reaction portion of the species evolution equations along with a
temperature evolution equation.  This is done using a standard ODE solver
(like {\tt VODE}) on the system:
\begin{eqnarray}
\frac{dX_k}{dt} &=& \omegadot_k(\rho,X_k,T) \\
\frac{dT}{dt}   &=& 
    \frac{1}{c_p} \left ( -\sum_k \xi_k  \omegadot_k  + \Hnuc \right ).
\end{eqnarray}
Here, $T$ is evolved solely to evaluate the reaction rates,
$\omegadot_k(\rho,X_k,T)$.  Furthermore, we simplify the problem
``freezing'' the thermodynamics---i.e., $c_p$ and $\xi_k$ are evaluated at the
start of the integration and held constant thereafter.

We update the enthalpy at the end of the integration as:
\begin{equation}
h^\mathrm{new} = h^\mathrm{old} + \frac{\Delta t}{2} \Hnuc
\end{equation}

\item Advect for $\Delta t$

Here we solve
\begin{eqnarray}
\frac{\partial(\rho X_k)}{\partial t} &=& 
    -\nabla\cdot(\rho X_k\Ub) \\
\frac{\partial(\rho h)}{\partial t} &=& 
    -\nabla\cdot(\rho h\Ub) + \frac{Dp_0}{Dt} 
\end{eqnarray}

Note that no explicit reaction terms appear here.  Since the advection
takes place using the state updated from the reaction step, the effect
of the reactions is implicitly contained in the advective update.

\item React for $\Delta t/2$

Finally, we react again, starting with the state left by the advection
step.

\end{itemize}

\section{SDC Without Thermal Diffusion or Base State Evolution}
In the SDC version, the VODE integration at the end of an SDC
iteration is responsible for updating all the thermodynamic quantities
\{$\rho$, $(\rho h)$, and $(\rho X_k$)\}, including both the advective
fluxes (incorporated via a piecewise constant advective flux source
term) and the reactions.  This provides a much stronger coupling between
the physical processes.  In particular, our system now looks like:
\begin{eqnarray}
\frac{d(\rho X_k)}{dt} &=& \rho \omegadot_k(\rho,X_k,T) + A_{\rho X_k} \label{eq:sdc:rhoX} \\
\frac{d(\rho h)}{dt}   &=& \rho \Hnuc + A_{\rho h} \label{eq:sdc:rhoh}
\end{eqnarray}
Here, $A_{\rho X_k}$ and $A_{\rho h}$ are piecewise-constant (in time)
approximations to the change in ${\rho X_k}$ and ${\rho h}$ (respectively)
due to the advection.  These are constructed by calling {\tt density\_advance}
and {\tt enthalpy\_advance} in \maestro\ and passed into the network solver
during the reaction step.  A flowchart of the \maestro\ SDC algorithm is 
shown in figure~\ref{fig:sdc:flowchart}.

\begin{figure}[tb]
\centering
\includegraphics[scale=0.65]{\sdcfigpath/flowchart_SDC}
\caption[Graphical flowchart of \maestro\ SDC]
  {\label{fig:sdc:flowchart} A flowchart of the \maestro\ SDC algorithm.  The
  thermodynamic state variables and local velocity are
  indicated in each step.  The base state is not shown as it is time-independent.
  Red text indicates that quantity was
  updated during that step.  The predictor is 
  outlined by the dotted box.  The blue text indicates state
  variables that are the same in {\bf Step 6} as they are in
  {\bf Step 2}, i.e., they are unchanged by the predictor steps.
  The SDC loop is shown in the gray dotted box.}
\end{figure}


\subsection{Advective Update}

In the advective update, our goal is to compute $A_{\rho X_k}$ and
$A_{\rho h}$.  These terms approximate the following:
\begin{eqnarray}
A_{\rho X_k} &=&  \left [- \nabla \cdot (\rho X_k \Ub) \right ]^{n+1/2} \\
A_{\rho h}   &=&  \left [- \nabla \cdot (\rho h U) + \frac{Dp_0}{Dt} \right ]^{n+1/2}
\end{eqnarray}
The construction of the interface states used in the advective terms
uses an iteratively-lagged approximation to the reaction source terms
($I_{\rho X_k}$ and $I_{\rho h}$, see below) in the interface
prediction.  This explicitly couples the reaction process to the
advection process.


\subsection{Final Update}

The RHS routine that the ODE solver operates on will first construct
the density as:
\begin{equation}
\rho = \sum_k (\rho X_k)
\end{equation}
It will then derive the temperature from the equation of state.  If we
are running with {\tt use\_tfromp = T}, then we do
\begin{equation}
T = T(\rho, p_0, X_k)
\end{equation}
otherwise, we do
\begin{equation}
T = T(\rho, h, X_k)
\end{equation}
Note that in constrast to the Strang-split version, here we call the EOS
every time we enter the RHS routine.

Finally we integrate the ODE system (Eqs.~\ref{eq:sdc:rhoX} and \ref{eq:sdc:rhoh}).
At the end of the integration, we define $I_{\rho X_k}$ and $I_{\rho
  h}$.  The actual form of these depends on what we are predicting.
We note that we only need $I_{\rho X_k}$ and $I_{\rho h}$ for the
prediction of the interface states, not the final conservative update.
That is because all we need from the advection solver is the
approximation to $A_{\rho X_k}$ and $A_{\rho h}$, not the final
updated state.

\subsubsection{Species Source Terms.}
For the species prediction, the form of $I_{\rho X_k}$ depends on
{\tt species\_pred\_type} (see \S \ref{sec:pred:density}):  
\begin{itemize}
\item {\tt species\_pred\_type} = 1 (predict $\rho'$ and $X_k$)
%
\begin{equation}
I_{X_k} = \frac{1}{\rho^{n+\myhalf}} \left [ 
      \frac{(\rho X_k)^\mathrm{new} - 
            (\rho X_k)^\mathrm{old}}{\Delta t} - A_{\rho X_k}  \right ]
\end{equation}

\item {\tt species\_pred\_type} = 2 (predict $\rho'$ and $(\rho X_k)$)
%
\begin{equation}
I_{\rho X_k} = \frac{(\rho X_k)^\mathrm{new} - (\rho X_k)^\mathrm{old}}{\Delta t} - A_{\rho X_k} 
\label{eq:sdc:Irhoo}
\end{equation}

\item {\tt species\_pred\_type} = 3 (predict $\rho$ and $X_k$)
%
\begin{equation}
I_{X_k} = \frac{1}{\rho^{n+\myhalf}} \left [ 
      \frac{(\rho X_k)^\mathrm{new} - 
            (\rho X_k)^\mathrm{old}}{\Delta t} - A_{\rho X_k}  \right ]
\end{equation}

\end{itemize}

We note that there is no $I$ term for $\rho$ or $\rho'$ prediction, since
the density evolution equation does not have a reaction source term.

\subsubsection{Enthalpy Source Terms.}
The obvious analog to the above form for $I_{\rho X_k}$ is to define
\begin{equation}
I_{\rho h}  = \frac{(\rho h)^\mathrm{new} - (\rho h)^\mathrm{old}}{\Delta t} - A_{\rho h}
\label{eq:sdc:Irhoh}
\end{equation}
This can be thought of as an approximation to $(\rho \Hnuc)$,
but this does not match any of the quantities we predict for the
enthalpy update ({\tt enthalpy\_pred\_type}, see \S
\ref{sec:pred:enthalpy}).  The appropriate constructions
are:

\begin{itemize}
\item {\tt enthalpy\_pred\_type} = {\tt predict\_rhoprime} 

Not implemented.

Here we need an $I_{\rho h}$ term for the $(\rho h)'$ evolution
equation (see Eq.~\ref{rhohprime equation}).  Defining the source
terms for this requires a base state enthalpy that knows about the
source terms---this is currently not implemented.

In particular, should $(\rho h)_0$ see a $\overline{(\rho \Hnuc)}$ term?
what about an average thermal diffusion?



\item {\tt enthalpy\_pred\_type} = {\tt predict\_h} 

This is the most straightforward prediction type.  The SDC solver
integrates the equation for $(\rho h)$:
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\nabla\cdot(\rho h \Ub) + \frac{Dp_0}{Dt}  + \rho H_{\rm nuc} 
\end{equation}
(shown here without diffusion or external heat sources).  Expanding
the time derivative and divergence, and using the continuity equation
we see:
\begin{equation}
\frac{\partial h}{\partial t} = -\Ub \cdot \nabla h + \frac{1}{\rho} \frac{Dp_0}{Dt}  + \frac{1}{\rho} (\rho H_{\rm nuc}) \label{eq:sdc:h}
\end{equation}
Comparing these equations, we see that 
\begin{equation}
I_{h}  = \frac{1}{\rho^{n+\myhalf}} \left [
    \frac{(\rho h)^\mathrm{new} - (\rho h)^\mathrm{old}}{\Delta t} - A_{\rho h} \right ]
\end{equation}


\item {\tt enthalpy\_pred\_type} = {\tt predict\_T\_then\_rhoprime} or 
      {\tt enthalpy\_pred\_type} = {\tt predict\_T\_then\_h} 

Both of these {\tt enthalpy\_pred\_type}s predict temperature.  Expressing
$h = h(p_0,T,X_k)$ and differentiating along particle paths:
\begin{eqnarray}
\frac{Dh}{Dt} &=& \left . \frac{\partial h}{\partial T} \right |_{p,X_k} \frac{DT}{Dt} +
                  \left . \frac{\partial h}{\partial p} \right |_{T,X_k} \frac{Dp_0}{Dt} +
           \sum_k \left . \frac{\partial h}{\partial X_k} \right |_{p,T} \frac{DX_k}{Dt} \\
              &=& c_p \frac{DT}{Dt} + h_p  \frac{Dp_0}{Dt} + \sum_k \xi_k \omegadot_k
\end{eqnarray}
where $c_p$, $h_p$, and $\xi_k$ are as defined in the table of symbols
(Table~\ref{table:sym}), and we substitute $DX_k/Dt = \omegadot_k$ (from the species
continuity equation, Eq.~\ref{species equation}).  Using Eq.~\ref{eq:sdc:h}, we have
the familiar temperature evolution equation:
\begin{equation}
\rho c_p \frac{DT}{Dt} = \underbrace{(1 - \rho h_p) \frac{Dp_0}{Dt}}_{\begin{smallmatrix}\text{already~accounted~for} \\ \text{in~T~prediction}\end{smallmatrix}} - \sum_k \xi_k \rho \omegadot_k + \rho \Hnuc
\end{equation}
where the underbraced term is already present in {\tt mktempforce}.  Recognizing that
Eq.~\ref{eq:sdc:Irhoh} is the SDC approximation to $(\rho \Hnuc)$ and Eq.~\ref{eq:sdc:Irhoo} is the 
SDC approximation to $(\rho \omegadot_k)$, we can define
\begin{equation}
I_T = \frac{1}{\rho^{n+\myhalf} c_p^{n+\myhalf}} \left \{
  \left [ \frac{(\rho h)^\mathrm{new} - (\rho h)^\mathrm{old}}{\Delta t} - A_{\rho h} \right ]
  - \sum_k \xi_k^{n+\myhalf} \left [      \frac{(\rho X_k)^\mathrm{new} - 
            (\rho X_k)^\mathrm{old}}{\Delta t} - A_{\rho X_k}  \right ] \right \}
\end{equation}



\end{itemize}


\subsubsection{Implementation}

This is done in {\tt advance.f90} just after the call to {\tt react\_state},
stored in the \multifab\ called {\tt intra}.
These terms are used as the source terms for the
advection step in the next SDC iteration.

\section{Summary of Changes}
The major changes from the non-SDC-enabled burners is the addition of
the advective terms to the system of ODEs, the fact that we integrate
$(\rho X_k)$ instead of just $X_k$, integrate $(\rho h)$ instead
of $T$, and the need to derive the
temperature from the input state for each RHS evaluation by {\tt
  VODE}.

Note also that the SDC integration by {\tt VODE} does not operate on 
the velocities at all.  That update is handled in the same fashion 
as the Strang-split version of the code.

The {\tt ignition\_simple\_SDC} burner shows how to setup the system
for {\tt use\_tfromp = T} or {\tt F}.  Presently, this implementation
does not support {\tt evolve\_base\_state = T} (in particular, we 
need to evolve $p_0$ in the RHS routine).

\section{Algorithm Flowchart - ADR with Fixed Base State}
We now include thermal diffusion and assume the base state is constant in time but not space:
\begin{eqnarray}
\frac{\partial\Ub}{\partial t} &=& 
    -\Ub\cdot\nabla\Ub  - \frac{1}{\rho}\nabla\pi 
    - \frac{\rho-\rho_0}{\rho} g\eb_r,\\
\frac{\partial(\rho X_k)}{\partial t} &=& 
    -\nabla\cdot(\rho X_k\Ub) + \rho\omegadot_k,\\
\frac{\partial(\rho h)}{\partial t} &=&
    -\nabla\cdot(\rho h\Ub) + \frac{Dp_0}{Dt} 
    + \rho\Hnuc
    + \underbrace{\nabla\cdot\frac{\kth}{c_p}\nabla h - \sum_k\nabla\cdot\frac{\xi_k k_{\rm th}}{c_p}\nabla X_k - \nabla\cdot\frac{h_p k_{\rm th}}{c_p}\nabla p_0}_{\nabla\cdot k_{\rm th}\nabla T}.
\end{eqnarray}


{\bf Step 1:} ({\it Advance thermodynamic variables}) In this step we integrate $(\rho, \rho X_k, \rho h)$ over the full time step.  We use a predictor-corrector approach, as explained below.\\

{\bf Step 1A:} ({\it Predictor}) In the predictor, we compute a preliminary estimate of $(\rho, \rho X_k, \rho h)$ at the new time level in order to obtain time-advanced values of $S, \beta_0$, and the other thermodynamic coefficients used in the corrector.  In summary, we compute advection velocities using a Godunov method and a MAC projection, compute advective fluxes, use a Crank-Nicolson-like discretization to compute diffusive fluxes, and integrate the entire system with VODE.  The quantities $(S, \beta_0, k_{\rm th}, c_p, \xi_k, h_p)^n$ are computed from the the state at $t^n$.  Here are the details.\\

{\bf Step 1A-i:} ({\it Compute advection velocities}) Use $\Ub^n$ and a second-order Godunov method to compute time-centered edge velocities, $\uadvone$, with a lagged pressure gradient and explicit buoyancy forcing terms.  The $\star$ superscript indicates that this field does not satisfy the divergence constrain.  Compute $S^{n+\myhalf,{\rm pred}}$ by extrapolating in time,
\begin{equation}
S^{n+\myhalf,{\rm pred}} = S^n + \frac{\Delta t^n}{2}\frac{S^n - S^{n-1}}{\Delta t^{n-1}},
\end{equation}
and project $\uadvone$ to obtain $\uadvpred$, which satisfies
\begin{equation}
\nabla\cdot\left(\beta_0^n\uadvpred\right) = S^{n+\myhalf,\rm{pred}}.
\end{equation}

{\bf Step 1A-ii:} Use $\uadvpred$ and a second-order Godunov integrator to compute time-centered edge states, $(\rho X_k, \rho h)^{n+\myhalf,{\rm pred}}$, with time-lagged reaction processes and explicitly evaluated diffusion and thermodynamic pressure as source terms.  Advance the density using
\begin{equation}
\frac{\rho^{n+1,{\rm pred}} - \rho^n}{\Delta t} = -\sum_m\nabla\cdot\left[\left(\rho X_k\right)^{n+\myhalf,{\rm pred}}\uadvpred\right].
\end{equation}

{\bf Step 1A-iii:}   Solve a Crank-Nicolson diffusion equation to advance enthalpy, using base-time transport coefficients everywhere.\\

{\bf Step 1A-iv:} Use VODE to advance ($\rho X_k, \rho h$), using piecewise-constant, time-centered advective and diffusive flux divergences.\\

{\bf Step 1B:} ({\it Corrector}) The quantities $(S, \beta_0, k_{\rm th}, c_p, \xi_k, h_p)^{n+1,{\rm pred}}$ are computed from the the state at $t^{n+1,{\rm pred}}$.  Here are the details.\\

{\bf Step 1B-i:} ({\it Compute updated advection velocities}) First, compute $S^{n+\myhalf}$ and $\beta_0^{n+\myhalf}$ using
\begin{equation}
S^{n+\myhalf} = \frac{S^n + S^{n+1,{\rm pred}}}{2}, \qquad \beta_0^{n+\myhalf} = \frac{\beta_0^n + \beta_0^{n+1,{\rm pred}}}{2}
\end{equation}
Then, project $\uadvone$ to obtain $\uadv$, which satisfies
\begin{equation}
\nabla\cdot\left(\beta_0^{n+\myhalf}\uadv\right) = S^{n+\myhalf}.
\end{equation}



{\bf Step 1B-ii:} Advance the species and density with the advective fluxes.  Solve a backward-Euler type correction equation for diffusion to advance $\rho h$.

{\bf Step 1B-iii:} Use VODE to advance $\rho X_k$ and $\rho h$, using piecewise-constant, time-centered advective and diffusive flux divergences.  Skip to Step 3 if this is the final MISDC iteration.\\

{\bf Step 1B-iv:} ({\it Optional}) Compute $S^{n+1,(0)}$, define $S^{n+\myhalf,(0)}$, and perform a MAC projection to obtain an updated advection velocity.  Then return to {\bf Step 2B-i}.\\

{\bf Step 2:} ({\it Advance the velocity})\\
