\documentclass[11pt]{article} 

\tolerance=600

\usepackage{amsmath,color,epsfig,epsf}

% Margins
\usepackage[lmargin=0.5in,rmargin=1.5in,tmargin=0.5in,bmargin=0.5in]{geometry}

\newcommand{\sfrac}[2]{\mathchoice
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
   \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
   \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}}
  {#1\!/#2}}

\def\half  {\frac{1}{2}}
\newcommand{\myhalf}{\sfrac{1}{2}}

\def\dt    {\Delta t}
\def\kth   {k_{\rm th}}
\def\init  {\rm init}
\def\model {\rm model}
\def\raw   {\rm raw}

\def\edge  {\rm EDGE}
\def\mac   {\rm MAC}
\def\trans {\rm TRANS}

\def\eb    {{\bf e}}
\def\fb    {{\bf f}}
\def\ib    {{\bf i}}
\def\Ub    {{\bf U}}

\def\Ubt   {\widetilde{\bf U}}
\def\ut    {\tilde{u}}
\def\vt    {\tilde{v}}
\def\wt    {\tilde{w}}

\title{Notes on generating initial models for mapping into {\tt MAESTRO}}

\setlength{\marginparwidth}{1.0in}
\newcommand{\MarginPar}[1]{\marginpar{%
\vskip-\baselineskip %raise the marginpar a bit
\raggedright\tiny\sffamily
\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}

\maketitle
\tableofcontents

\clearpage

\section{Creating the Model Data from Raw Data}
We begin with raw data, $\rho^{\raw}, T^{\raw}, p^{\raw}$, and $X^{\raw}$.  Here is the raw data file for each test problem:
\begin{eqnarray}
{\tt test2} & \rightarrow & {\tt ???} \nonumber \\
{\tt test\_convect} & \rightarrow & {\tt ???} \nonumber \\
{\tt wdconvect} & \rightarrow & {\tt ???} \nonumber \\
{\tt spherical\_heat} & \rightarrow & {\tt ???} \nonumber \\
{\tt xrb} & \rightarrow & {\tt initial\_models/xrb/sorted\_xrb.raw} \nonumber
\end{eqnarray}
Using the raw data, we need to generate model data with the same resolution as the base state.  Note that for spherical problems we set $\Delta r = \Delta x$.  We use a fortran subroutine to interpolate the raw data, yielding the model data, $\rho^{\model}, T^{\model}, p^{\model}$, and $X^{\model}$.  The fortran subroutine then uses an iterative procedure to modify the model data so that it is thermodynamically consistent with the {\tt MAESTRO} equation of state (EOS), and also satisfies our chosen hydrostatic equilibrium (HSE) discretization,
\begin{equation}
\frac{p_r - p_{r-1}}{\Delta r} = \frac{\rho_r + \rho_{r-1}}{2}g,\label{HSE Discretization}
\end{equation}
to a user defined tolerance.  Here are the fortran subroutines for each test problem:
\begin{eqnarray}
{\tt test2} & \rightarrow & {\tt ???} \nonumber \\
{\tt test\_convect} & \rightarrow & {\tt ???} \nonumber \\
{\tt wdconvect} & \rightarrow & {\tt ???} \nonumber \\
{\tt spherical\_heat} & \rightarrow & {\tt ???} \nonumber \\
{\tt xrb} & \rightarrow & {\tt initial\_models/xrb/init\_1d.f90} \nonumber
\end{eqnarray}
The model data is not generated at run-time - it must be generated in advance of running any MAESTRO examples.  The inputs file should point to the file containing the model data.
\subsection{Multilevel Plane-Parallel}
We need to generate model data with the same resolution as the finest base state resolution.
\section{Creating the Initial Data from the Model Data}
In {\tt base\_state.f90}, using the subroutine {\tt init\_base\_state.f90} (which is actually a terrible name since we are setting the initial data, not the base state), we set the initial data $\rho^{\init}, T^{\init}, p^{\init}$ and $X^{\init}$ equal to the model data.  Then, we set $h^{\init} = h^{\init}(\rho^{\init},T^{\init},X^{\init})$.  Note that in the code, $p^{\init}$ is also overwritten, but the value of $p^{\init}$ does not change since we called $p^{\model} = p^{\model}(\rho^{\model},T^{\model},X^{\model})$ at the end of the previous fortran subroutine.
\subsection{Multilevel Plane-Parallel}
For the finest level, we can set the initial data equal to the model data.  For the non-finest levels, we use linear interpolation to compute the initial data.  For cells that are covered by finer cells, we average $\rho^{\init}, (\rho h)^{\init},$ and $(\rho X)^{\init}$ from the fine cell to get the coarse cell value.  Then, for every cell not at the finest level, we call the EOS to compute $p^{\init},T^{\init} = p^{\init},T^{\init}(\rho^{\init},h^{\init},X^{\init})$.\MarginPar{Now $p^{\init}$ and $\rho^{\init}$ are not in HSE.  Is this a problem?}
\section{Creating the Base State and Full State}\label{Sec:Creating the Base State and Full State}
Given $p^{\init}, \rho^{\init}, T^{\init},$ and $X^{\init}$, this section describes how the base state ($\rho_0$ and $p_0$) and full state ($\rho, h, X$, and $T$) are computed.  We require that $\rho_0 = \overline\rho$, the base state is in HSE according to equation (\ref{HSE Discretization}), and the full state is in thermodynamic equilibrium with $p_0$.  Here are the steps:
\begin{enumerate}
\item For plane-parallel problems, fill $\rho^{\init}, h^{\init}, X^{\init}$, and $T^{\init}$ onto a multifab to obtain the full state $\rho, h, X$, and $T$.  For spherical problems, fill $\rho^{\init}, p^{\init}$, and $X^{\init}$ onto a multifab to obtain the full state $\rho, p$, and $X$, and then call the EOS to obtain the full state $h,T = h,T(\rho,p,X)$.  Note that the multifab version of $p$ is temporary, and can be deallocated after this step.
\item For spherical problems, skip the remaining steps and instead set $p_0 = p^{\init}$ and $\rho_0 = \rho^{\init}$.
\item If {\tt perturb\_model} = F, skip the remaining steps and instead set $p_0 = p^{\init}$ and $\rho_0 = \rho^{\init}$.
\item Perturb $T$, then compute $\rho = \rho(p^{\init},T,X)$.
\item Set $\rho_0 = \overline\rho$.
\item Compute $p_0$ using equation (\ref{HSE Discretization}), using $p_{0,r=0}$ as the initial condition.\MarginPar{We may change the location of the initial condition.}
\item Compute the full state $T,h = T,h(\rho,p_0,X)$.
\end{enumerate}
Now $\rho_0 = \overline\rho$, the base state is in HSE, and the full state is in thermodynamic equilibrium with $p_0$.
\subsection{Multilevel Plane-Parallel}
Refer to figure \ref{Fig:Multilevel Initialization}.  The dots represent the initial data, which was generated at the finest resolution on the domain, and is in HSE as well as thermodynamic equilibrium.  The circles represent the fine level data points in the 1D array.  The squares represent the coarse level data points in the 1D array.  We modify step 1 in \S~\ref{Sec:Creating the Base State and Full State} as follows:
\begin{enumerate}
\item Step 1
\begin{enumerate}
\item Copy the initial data from the dots directly into the circles.  For the squares, compute only $\rho$ and $X$ by averaging $\rho$ and $(\rho X)$ from the two corresponding dots.
\item Integrate to get $p$ in the squares.  We need a fancy stencil at coarse-fine interfaces that I haven't finished deriving.  Away from coarse-fine interfaces, we can use our standard HSE discretization.
\item Call EOS to get $T$ and $h$ in the squares, i.e., $T,h = Th,h(\rho,p,X)$.
\item We now copy this 1D profile onto the full multifab.
\end{enumerate}
\end{enumerate}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[tpb]
\begin{center}
\epsffile{./multilevel_init.eps}
\caption{Multilevel Initialization}
\label{Fig:Multilevel Initialization}
\end{center}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Working Notes on Coarse-Fine HSE Discretization - Not Final}
Integrating the HSE discretization upward, when we encounter a change from coarse to fine, here is an equation to integrate up to the coarse-fine interface
\begin{equation}
\frac{p_{r-\myhalf}^l - p_{\sfrac{r}{2}-1}^{l-1}}{\Delta r^{l-1}/2} = \frac{\rho_{r-\myhalf}^l + \rho_{\sfrac{r}{2}-1}^{l-1}}{2}g ~~~ \rightarrow ~~~ p_{r-\myhalf}^l = p_{\sfrac{r}{2}-1}^{l-1} + \frac{\Delta r^{l-1} g}{4}\left(\rho_{r-\myhalf}^l + \rho_{\sfrac{r}{2}-1}^{l-1}\right).
\end{equation}
Here is an equation to integrate from the coarse-fine interface up to the cell center
\begin{equation}
\frac{p_r^l - p_{r-\myhalf}^l}{\Delta r^l/2} = \frac{\rho_r^l + \rho_{r-\myhalf}^l}{2}g ~~~ \rightarrow ~~~ p_r^l = p_{r-\myhalf}^l + \frac{\Delta r^l g}{4}\left(\rho_r^l + \rho_{r-\myhalf}^l\right).
\end{equation}
Combining equations gives
\begin{equation}
p_r^l = p_{\sfrac{r}{2}-1}^{l-1} + \frac{\Delta r^{l-1} g}{4}\left(\rho_{r-\myhalf}^l + \rho_{\sfrac{r}{2}-1}^{l-1}\right) + \frac{\Delta r^l g}{4}\left(\rho_r^l + \rho_{r-\myhalf}^l\right).
\end{equation}
We can simplify using
\begin{equation}
\Delta r^{l-1} = 2\Delta r^l,
\end{equation}
\begin{equation}
\rho_{r-\myhalf}^l = \frac{2}{3}\rho_r^l + \frac{1}{3}\rho_{\sfrac{r}{2}-1}^{l-1}.
\end{equation}
Simplifying
\begin{eqnarray}
p_r^l &=& p_{\sfrac{r}{2}-1}^{l-1} + \frac{\Delta r^l g}{2}\left(\frac{2}{3}\rho_r^l + \frac{1}{3}\rho_{\sfrac{r}{2}-1}^{l-1} + \rho_{\sfrac{r}{2}-1}^{l-1}\right) + \frac{\Delta r^l g}{4}\left(\rho_r^l + \frac{2}{3}\rho_r^l + \frac{1}{3}\rho_{\sfrac{r}{2}-1}^{l-1}\right) \nonumber \\
&=& p_{\sfrac{r}{2}-1}^{l-1} + \frac{3\Delta r^l g}{4}\left(\rho_{\sfrac{r}{2}-1}^{l-1} + \rho_r^l\right).
\end{eqnarray}
When we encounter a change from fine to coarse, analogously
\begin{equation}
p_{r}^l = p_{2(r-1)+1}^{l+1} + \frac{3\Delta r^{l+1}g}{4}\left(\rho_{2(r-1)+1}^{l+1} + \rho_{r}^l\right).
\end{equation}

\end{document}
