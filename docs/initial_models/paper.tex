\documentclass[11pt]{article} 

\tolerance=600

\usepackage{amsmath,color}

% Margins
\usepackage[lmargin=0.5in,rmargin=1.5in,tmargin=0.5in,bmargin=0.5in]{geometry}

\def\half  {\frac{1}{2}}
\def\dt    {\Delta t}
\def\kth   {k_{\rm th}}
\def\init  {\rm init}

\def\edge  {\rm EDGE}
\def\mac   {\rm MAC}
\def\trans {\rm TRANS}

\def\eb    {{\bf e}}
\def\fb    {{\bf f}}
\def\ib    {{\bf i}}
\def\Ub    {{\bf U}}

\def\Ubt   {\widetilde{\bf U}}
\def\ut    {\tilde{u}}
\def\vt    {\tilde{v}}
\def\wt    {\tilde{w}}

\title{Notes on generating initial models for mapping into {\tt MAESTRO}}

\setlength{\marginparwidth}{1.0in}
\newcommand{\MarginPar}[1]{\marginpar{%
\vskip-\baselineskip %raise the marginpar a bit
\raggedright\tiny\sffamily
\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}

\maketitle
\tableofcontents

\clearpage

\section{Creating the Initial Model}
The initial model returns the pressure, density, temperature, and species, denoted $p^{\init}, \rho^{\init}, T^{\init},$ and $X_k^{\init}$.  The initial model uses an iterative procedure \MarginPar{add an overview of the iterative procedure} to return a state that is both thermodynamically consistent with the {\tt MAESTRO} EOS, and in hydrostatic equilibrium,
\begin{equation}
\frac{p_r^{\init} - p_{r-1}^{\init}}{\Delta r} = \frac{\rho_r^{\init} + \rho_{r-1}^{\init}}{2}g,\label{HSE Discretization}
\end{equation}
to a user-defined tolerance.  Here is a list of which model file is used for each test problem:\MarginPar{This needs to be filled in and checked for accuracy}
\begin{eqnarray}
{\tt test2} & \rightarrow & {\tt ???} \nonumber \\
{\tt test\_convect} & \rightarrow & {\tt ???} \nonumber \\
{\tt wdconvect} & \rightarrow & {\tt ???} \nonumber \\
{\tt spherical\_heat} & \rightarrow & {\tt ???} \nonumber \\
{\tt xrb} & \rightarrow & {\tt initial\_models/xrb/sorted\_xrb.raw} \nonumber
\end{eqnarray}
The initial model needs to be created at the same resolution as the base state (for single-level problems) and at the same resolution of the finest resolution base state (for multi-level plane-parallel problems).  For spherical, we force $\Delta r = \Delta x$.

\section{Initialization Procedure}
Given data from an initial model file ($p^{\init}, \rho^{\init}, T^{\init},$ and $X^{\init}$), this section describes how the base state ($\rho_0$ and $p_0$) and full state ($\rho, h, X$, and $T$) are computed.  At the end of the initialization, we require that $\rho_0 = \overline\rho$, the base state is in hydrostatic equilibrium according to equation (\ref{HSE Discretization}), and the full state is in thermodynamic equilibrium with $p_0$.  Here are the steps:
\begin{enumerate}
\item Call the EOS to obtain a 1D $p^{\init},h^{\init} = p^{\init},h^{\init}(\rho^{\init},T^{\init},X^{\init})$.  Note that this overwrites the $p^{\init}$ from the initial model file, but this should not change $p^{\init}$ since this pressure was already both thermodynamically consistent and in hydrostatic equilibrium.
\item For plane-parallel problems, fill $\rho^{\init}, h^{\init}, X^{\init}$, and $T^{\init}$ onto a multifab to obtain the full state $\rho, h, X$, and $T$.  For spherical problems, fill $\rho^{\init}, p^{\init}$, and $X^{\init}$ onto a multifab to obtain the full state $\rho, p$, and $X$, and then call the EOS to obtain the full state $h,T = h,T(\rho,p,X)$.
\item For spherical problems, skip the remaining steps and instead set $p_0 = p^{\init}$ and $\rho_0 = \rho^{\init}$.
\item If {\tt perturb\_model} = F, skip the remaining steps and instead set $p_0 = p^{\init}$ and $\rho_0 = \rho^{\init}$.
\item Perturb $T$, then compute $\rho,h = \rho,h(p^{\init},T,X)$.
\item Set $\rho_0 = \overline\rho$.
\item Compute $p_0$ using equation (\ref{HSE Discretization}).
\item Compute the full state $T,h = T,h(\rho,p_0,X)$.
\end{enumerate}
Now the full state is in thermodynamic equilibrium with $p_0$, and the base state is in hydrostatic equilibrium.
\end{document}
