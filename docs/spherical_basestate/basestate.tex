
\section{\label{app:gravity} Modifications for a Spherical Self-Gravitating Star}

In papers II and III, we calculated the hydrostatic expansion of the base state
in plane-parallel geometry under the assumption that the weight of the
material above (or below) any given fluid parcel does not change
during hydrostatic expansion.  This assumption holds when the
gravitational acceleration is independent of location.  Here we discuss the
modifications to the algorithm in paper III required to treat a spherical 
self-gravitating star.

\subsection{Calculation of $w_0$}\label{Sec:Spherical w0 Calculation}

%In the low Mach number model, we allow the density and
%temperature perturbations to be large compared to the background
%state, but we require the pressure perturbation to be small.
%Therefore, if the star expands, we need to incorporate that expansion
%into the background state.  Furthermore, we need to know the velocity of the
%base state expansion for the evolution of the perturbed
%quantities.

We begin with equation (23) in paper III written in spherical coordinates:
\[
\frac{1}{r^2}\frac{\partial}{\partial r} \left (r^2 \beta_0 w_0 \right ) =
\beta_0 \left ( \Sbar - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} \right )\enskip.
\]
We expand the spatial derivative and divide through by $\beta_0$:
\begin{equation}
\label{eq:sphconstraint}
\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) +
w_0 \frac{1}{\beta_0} \frac{\partial \beta_0}{\partial r} =
 \Sbar - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t}  \enskip .
\end{equation}
Recalling from paper I that;
\[
\frac{1}{\gammabar p_0}  \frac{\partial p_0}{\partial r} = \frac{1}{\beta_0} \frac{\partial \beta_0}{\partial r}\enskip,
\]
and moving this term to the right hand side,
we can express equation (\ref{eq:sphconstraint}) as:
\begin{eqnarray}
%\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) +
%w_0 \frac{1}{\gammabar p_0}  \frac{\partial p_0}{\partial r} &=&
% \left ( \Sbar - \frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} \right ) \nonumber \\
\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) &=&
  \Sbar - \frac{1}{\gammabar p_0} \left( 
\frac{\partial p_0}{\partial t} + w_0 \frac{\partial p_0}{\partial r} \right)\enskip. \label{eq:w01}
\end{eqnarray}
We first solve a piece of this equation for $\ow = w_0 - \dw$:
\begin{eqnarray}
\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 \ow \right ) &=& \Sbar \enskip.
\end{eqnarray}
Then we can write
\begin{eqnarray}
\frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 \dw \right ) &=&
  - \frac{1}{\gammabar p_0} \left(
\frac{\partial p_0}{\partial t} + (\ow + \dw)
\frac{\partial p_0}{\partial r} \right)\enskip.\label{eq:w01a}
\end{eqnarray}

Multiplying equation (\ref{eq:w01a}) through by $\gammabar p_0 $,
taking another derivative with respect to $r$, and switching the order
of temporal and spatial derivatives, we get:
\begin{equation}
\label{eq:sphconstraint_2}
\frac{\partial}{\partial r} \left [ \frac{\gammabar p_0 }{r^2} \frac{\partial}{\partial r} (r^2 \dw) \right ]
= -\frac{\partial}{\partial t} \frac{\partial p_0}{\partial r}
  -\frac{\partial}{\partial r} \left ((\ow+\dw) \frac{\partial p_0}{\partial r} \right )\enskip.
\end{equation}

To solve for $\dw$ we will need to substitute for the derivatives of $p_0.$
To do so we start with the equation of hydrostatic equilibrium in a spherical geometry:
\[
\frac{\partial p_0}{\partial r} = -\rho_0 g \, ; \quad
g = \frac{G m_\mathrm{encl}}{r^2}\enskip,
\]
where $m_\mathrm{encl}(r)$ is the mass enclosed at radius $r$ and $G$ is the
gravitational constant.  
Using this, we can then write equation (\ref{eq:sphconstraint_2}) as:
\begin{eqnarray}
\frac{\partial}{\partial r} \left[ \frac{\gammabar p_0}{r^2} \frac{\partial}{\partial r} (r^2 \dw) \right] &=&
 \frac{\partial}{\partial t} \left (\rho_0 g \right )
+\frac{\partial}{\partial r} \left (w_0 \rho_0 g \right) \nonumber \\
&=&
  g \left[ \frac{\partial \rho_0}{\partial t} + \frac{\partial}{\partial r} (w_0 \rho_0) \right]
+ \rho_0 \left( \frac{\partial g}{\partial t} + w_0 \frac{\partial g}{\partial r} \right) \enskip.\nonumber\\
&&
\label{eq:sphconstraint_3}
\end{eqnarray}
The mass enclosed inside any radius, $r$, is $m_\mathrm{encl}(r) = 4 \pi
\int_0^r \rhozero(s) s^2 ds$, or alternately, $\partial m_\mathrm{encl}/\partial r = 4\pi r^2 \rho_0$.  
The Lagrangian derivative of the enclosed mass is then:
\begin{eqnarray}
\frac{D_0 m_\mathrm{encl}}{D t} &=& \frac{\partial m_\mathrm{encl}}{\partial t} + w_0 \frac{\partial m_\mathrm{encl}}{\partial r} \nonumber \\
 &=& 4\pi \left( \frac{\partial}{\partial t} \int_0^r \rhozero(s) s^2 ds + w_0 r^2 \rho_0 \right) \nonumber \\
&=& 4\pi \left( \int_0^r \frac{\partial \rho_0}{\partial t} s^2 ds + w_0 r^2 \rho_0 \right) \nonumber \\
&=& 4\pi \left\{ -\int_0^r \left [ \frac{1}{s^2}\frac{\partial(s^2 \rho_0 w_0)}{\partial s} + \frac{1}{s^2}\frac{\partial (s^2 \etarho)}{\partial s} \right ]s^2 ds + w_0 r^2 \rho_0 \right\} \nonumber \\
&=&  \left . 4\pi \left(-s^2 \rho_0 w_0 \right |_0^r - \left . s^2 \etarho \right |_0^r + w_0 r^2 \rho_0 \right) \nonumber \\
&=& -4\pi r^2 \etarho \label{eq:dmdt}
\end{eqnarray}
where we used the spherical form of equation (29) in paper III, 
\begin{equation}
\label{eq:sph_continuity}
\frac{\partial \rhozero}{\partial t} + \frac{1}{r^2} \frac{\partial (r^2 \rho_0 w_0)}{\partial r} 
+ \frac{1}{r^2} \frac{\partial (r^2 \etarho )}{\partial r}  = 0 \enskip ,
\end{equation}
to eliminate $\partial \rho_0/\partial t$.  We note that in the
absence of any mixing, $\etarho=0$, and  $D_0 m_\mathrm{encl}/Dt = 0.$
%which is another way of saying that the mass inside a fluid element
%does not change during expansion.  
Equation (\ref{eq:dmdt})
allows us to write the Lagrangian change in the gravitational
acceleration as:
\begin{eqnarray}
\frac{D_0 g}{D t} = \frac{\partial g}{\partial t} + w_0 \frac{\partial g}{\partial r} &=& \frac{D_0}{Dt}\left(\frac{G m_\mathrm{encl}}{r^2}\right) \nonumber \\
&=& G m_\mathrm{encl}\frac{D_0}{D t}\left(\frac{1}{r^2}\right) + \frac{G}{r^2}\frac{D_0 m_\mathrm{encl}}{Dt} \nonumber \\
&=& -\frac{2 w_0 G m_\mathrm{encl}}{r^3} - 4 \pi G \etarho \nonumber \\
&=& -\frac{2 w_0 g}{r} - 4 \pi G \etarho \enskip .
\end{eqnarray}

Putting it all together, equation (\ref{eq:sphconstraint_3}) becomes:
\begin{equation}
 \frac{\partial}{\partial r} \left[ \frac{\gammabar p_0}{r^2} \frac{\partial}{\partial r} (r^2 \dw) \right] 
= 
  g \left [ \frac{\partial \rho_0}{\partial t} + \frac{\partial}{\partial r} (w_0 \rho_0) \right ]
+ \rho_0 \left(\frac{-2 w_0 g}{r} - 4 \pi G \etarho \right) \label{eq:B5} \enskip.
\end{equation}
Finally, we can use equation (\ref{eq:sph_continuity})
to write equation (\ref{eq:B5}) as:
\begin{eqnarray}
\frac{\partial}{\partial r} \left[ \frac{\gammabar p_0}{r^2} \frac{\partial}{\partial r} (r^2 \dw) \right] && \nonumber \\
&=&
 g \left [ -\frac{1}{r^2} \frac{\partial}{\partial r} (r^2 w_0 \rhozero)
           -\frac{1}{r^2} \frac{\partial}{\partial r} (r^2 \etarho)
           +              \frac{\partial}{\partial r} (w_0 \rhozero) \right ] + \rho_0 \left(\frac{-2 w_0 g}{r} - 4 \pi G \etarho \right) \nonumber \\
&=& 
- \frac{g}{r^2} \frac{\partial (r^2 \etarho)}{\partial r} - \frac{4 (\ow + \dw) \rho_0 g}{r} 
- 4 \pi G \rhozero \etarho \label{eq:B7} \enskip .
\end{eqnarray}

\noindent We discretize this elliptic equation in the radial dimension as:
\begin{eqnarray}
&& \frac{1}{\Delta r} \left\{
\left[ \frac{\gammabar p_0}{r^2} \frac{\partial (r^2 \dw)}{\partial r} \right]_{i} -
\left[ \frac{\gammabar p_0}{r^2} \frac{\partial (r^2 \dw)}{\partial r} \right]_{i-1} \right\}
+ \left[ \frac{4 (r^2 \dw) \rho_0 g}{r^3} \right]_{i-\half} \nonumber\\
&=& 
- \frac{g_{i-\half}}{r_{i-\half}^2 \Delta r} 
\left[ \left( r^2 \etarho \right)_{i} - \left( r^2 \etarho  \right)_{i-1} \right] 
   - \left[ \frac{4 \ow \rho_0 g}{r} \right]_{i-\half}
   - \left[  4 \pi G \rhozero \etarho   \right]_{i-\half} \enskip , \nonumber
\end{eqnarray}
where we have chosen to solve for $(r^2 \dw)$ rather than $\dw.$
Then, using hydrostatic equilibrium, we expand this to 
\begin{eqnarray}
&& \frac{1}{\Delta r} \left\{
 \left( \frac{\gammabar p_0}{r^2}\right)_{i  } \frac{[ (r^2 \dw)_{i+\half} - (r^2 \dw)_{i-\half} ]}{\Delta r}
-\left( \frac{\gammabar p_0}{r^2}\right)_{i-1} \frac{[ (r^2 \dw)_{i-\half} - (r^2 \dw)_{i-\thalf}]}{\Delta r} \right\} \nonumber \\
&&  - \left\{ \frac{4}{r_{i-\half} ^3} \frac{{p_0}_i - {p_0}_{i-1}}{\dr} \right\} (r^2 \dw)_{i-\half}  \nonumber \\
&=&   \left\{ \frac{4}{r_{i-\half} ^3} \frac{{p_0}_i - {p_0}_{i-1}}{\dr} \right\} (r^2 \ow)_{i-\half}
 - \frac{g_{i-\half}}{r_{i-\half}^2 \Delta r} 
  \left[ \left( r^2 \etarho \right)_{i} - \left( r^2 \etarho  \right)_{i-1} \right] 
- \left[  4 \pi G \rhozero \etarho   \right]_{i-\half} \enskip.
\end{eqnarray}

If we write this in matrix form, so that:
\begin{equation}
A_i (r^2 \dw)_{i-\thalf} + B_i (r^2 \dw)_{i-\half} + C_i (r^2 \dw)_{i+\half} = F_i\enskip,
\end{equation}
then:
\begin{eqnarray}
A_i &=& \frac{1}{\Delta r^2} \left( \frac{\gammabar p_0}{r^2}\right)_{i-1}  \enskip, \nonumber  \\
B_i &=& -\frac{1}{\Delta r^2} \left[ \left( \frac{\gammabar p_0}{r^2}\right)_{i  }  
               +\left( \frac{\gammabar p_0}{r^2}\right)_{i-1} \right] 
              - \left\{ \frac{4}{r_{i-\half} ^3} \frac{{p_0}_i - {p_0}_{i-1}}{\dr} \right\} \nonumber \\
C_i &=& \frac{1}{\Delta r^2} \left( \frac{\gammabar p_0}{r^2}\right)_{i}  \enskip, \nonumber  \\
F_i &=&  \left\{ \frac{4}{r_{i-\half} ^3} \frac{{p_0}_i - {p_0}_{i-1}}{\dr} \right\} (r^2 \ow)_{i-\half}
 - \frac{g_{i-\half}}{r_{i-\half}^2 \Delta r} 
\left[ \left( r^2 \etarho \right)_{i} - \left( r^2 \etarho  \right)_{i-1} \right] 
- \left[  4 \pi G \rhozero \etarho   \right]_{i-\half} \enskip \nonumber .
\end{eqnarray}
Here,
\begin{equation}
g_{j-\half} = \frac{G}{r_{j-\half}^2} \sum_{k=1}^{j} \frac{4}{3} \pi  (r_{k-\half}^3 - r_{k-\thalf}^3) \; {\rho_0}_{k-1} \enskip.
\end{equation}

We define the lower boundary condition, $ \dw = 0$ at $r=0,$ which
corresponds to $i=1,$ by setting:
\begin{eqnarray}
A_1 = C_1 = F_1 &=& 0\enskip, \nonumber \\
B_1 &=& 1\enskip. \nonumber
\end{eqnarray}
We also specify $\partial (r^2 \dw) / \partial r = 0$ at the the upper boundary, which corresponds to $i=N,$
by setting:
\begin{eqnarray}
A_N &=& -1\enskip, \nonumber \\
B_N &=&  1\enskip, \nonumber \\
C_N = F_N &=& 0\enskip. \nonumber
\end{eqnarray}
\subsection{Calculation of $\psi$}

Rewriting Equation (\ref{eq:w01}), we can define
\begin{eqnarray}
\psi \equiv \frac{D_0 p_0}{Dt} &=& \gammabar p_0 \left [ \overline{S} - 
       \frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) \right] \enskip .
\end{eqnarray}
We discretize this locally as:
\begin{eqnarray}
\psi_j^{\nph,\star} &=& \gammabar^{(1)} \frac{\left( p_0^{n} + p_0^{n+1,\star} \right)_j}{2}
\left \{ \overline{S^{\nph,\star}_j} - 
 \frac{1}{r_j^2} \left [ (r^2 {w_0}^{\nph,\star})_{j+\myhalf} -
          (r^2 {w_0}^{\nph,\star})_{j-\myhalf} \right ] \right \} \enskip , \nonumber \\
&& \\
\psi_j^{\nph} &=& \gammabar^{n+1,\star} \frac{\left( p_0^{n} + p_0^{n+1} \right)_j}{2}
\left \{ \overline{S^{\nph}_j} - 
 \frac{1}{r_j^2} \left [ (r^2 {w_0}^{\nph})_{j+\myhalf} -
          (r^2 {w_0}^{\nph})_{j-\myhalf} \right ] \right \} \enskip .
\end{eqnarray}
\MarginPar{Why is $\gammabar$ not time centered in the $\psi_j^{\nph}$ equation?}

\subsection{{\bf Advect Base}}\label{Sec:Advect Base Spherical}

\begin{enumerate}

\item {\bf Density Update:}

The base state density update now includes the area factors in the divergences:
\begin{eqnarray}
\rho_{0,j}^{\outp} &=& \rho_{0,j}^{\inp}
 - \frac{1}{r_j^2} \frac{\dt}{\dr} 
 \left [ \left( {{r^2 \rho}_0}^{\inp,\nph} {w_0}^{\inp}\right)_{j+\myhalf} -  
          \left( {{r^2 \rho}_0}^{\inp,\nph} {w_0}^{\inp}\right)_{j-\myhalf} \right]   \enskip. 
\end{eqnarray}
As before, the interface states are found via the procedure described in
paper II, Appendix A.  

\item {\bf Pressure Update:}
\newline
We use a predictor-corrector formulation for the pressure update 
in order to improve the overall accuracy.  Beginning with equation~(\ref{eq:w01}),
we can write
\begin{eqnarray*}
\frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} = 
 \Sbar - \frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0 \right ) - \frac{1}{\gammabar p_0} w_0 \frac{\partial p_0}{\partial r} \enskip .
\end{eqnarray*}
We time-center the left hand side:
\[
\frac{1}{\gammabar p_0} \frac{\partial p_0}{\partial t} \approx
   \frac{2}{\gammabar^{\inp} (p_0^{\inp} + p_0^{\star})} \frac{p_0^{\star} - p_0^{\inp}}{\dt}\enskip.
\]
We can then solve for the provisional updated pressure, $p_0^{\star}$, giving:
\begin{equation}
p_0^{\star} = p_0^{\inp} \frac{\left(1 + \gammabar^{\inp} f\right)}{\left(1 - \gammabar^{\inp} f\right)}\enskip,
\end{equation}
with:
\begin{equation}
f = \frac{\dt}{2} \left [ \overline{S^{\inp}} -  \frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0^{\inp} \right) - 
                                             \frac{1}{\gammabar^{\inp} p_0^{\inp}} w_0^{\inp} \left ( \frac{\partial p_0^\inp}{\partial r} \right ) \right ] \label{eq:frhs} \enskip ,
\end{equation}
where the $(\partial p_0^\inp / \partial r)$ is computed by
interpolating $p_0^\inp$ from cell-centers to edges and then
differencing.

Now we begin the corrector step.  Using $p_0^\star$, we can compute a more accurate approximation
to equation~(\ref{eq:frhs}),
\begin{equation}
\tilde{f} = \frac{\dt}{2} \left [ \overline{S^{\inp}} -  \frac{1}{r^2} \frac{\partial}{\partial r} \left (r^2 w_0^{\inp} \right) - 
                                             \frac{1}{\gammabar^{\inp} \tilde{p_0}} w_0^{\inp} \left ( \frac{\partial \tilde{p_0}}{\partial r} \right ) \right ] \enskip ,
\end{equation}
where $\tilde{p} = (p_0^\inp + p_0^\star)/2$, and the difference is again computed
by first putting $\tilde{p}$ on edges.

This allows us to complete the corrector for the pressure update:
\begin{equation}
p_0^{\outp} = p_0^{\inp} \frac{\left(1 + \gammabar^{\inp} \tilde{f}\right)}{\left(1 - \gammabar^{\inp} \tilde{f}\right)}\enskip .
\end{equation}
We note that since we do not time-center $\gammabar$, this is not
strictly second-order accurate.  However, as $\gammabar$ varies slowly
in time, we expect the effect to be small.  This is something that we 
defer until simulations indicate it is warranted. \MarginPar{new}

\end{enumerate}

\subsection{\bf{Correct Base}}

The is the process by which we adjust the base state density to account for
large-scale mixing.  It can also be used to adjust the base state enthalpy
to account for large-scale mixing, reactions, and thermal diffusion.
We have simplified the algorithm greatly by simply setting $\nabla\cdot\etarho$
equal to the averaged difference between the base state and full state.

\begin{equation}
\rho_0^{\outp} = \rho_0^{\inp} + \underbrace{{\rm{\bf Avg}}(\rho^{\inp} - \rho_0^{\inp})}_{-\Delta t\nabla\cdot\etarho}.
\end{equation}

\subsection{One-dimensional Results}

To test the spherical base state expansions, we inject heat at a
steady rate into a one-dimensional white dwarf model.  This is similar
to the first test in paper II, except now in spherical coordinates.
As in that test, the compressible method with which we compare the low Mach number method 
is the FLASH code's implementation of the
piecewise-parabolic method (PPM) in a one-dimensional spherical geometry.  
The initial conditions for the white dwarf are those described in
Section 4.1 of paper III for the central region.

%A simple initial model for a white dwarf was constructed by specifying
%a central density of $2.6\times 10^9~\gcc$, a central temperature of
%$7\times 10^8$~K, and a composition of 30\% carbon and 70\% oxygen,
%and integrating the equation of hydrostatic equilibrium outward (using
%spherically symmetric self-gravity) while constraining the entropy to
%be constant.  Once the temperature of the model falls to $10^7$~K, it
%is held constant---this happens only at the very outer region of the
%star.  Together with the equation of state, this completely determines
%the density, temperature, and pressure structure of the star.

In the expansion of a plane-parallel atmosphere, heating at a
height $r$ above the base does not affect the pressure or density 
below that height.  By contrast, in a spherical symmetric
self-gravitating star, heating at a radius $r$ will lead to a pressure
and density decrease at the center in addition to the expansion of the
outer layers (see Schwarzchild \& Harm, 1965, ApJ, 146, 855).


We apply a heating function of the form:
\begin{equation}
\Hext = H_0 \exp \left [-(r-r_0)^2 / W^2 \right ] \enskip ,
\end{equation}
with $r_0 = 4\times 10^7$~cm, $W = 10^7$~cm, and $H_0 = 1\times
10^{16}$~erg~g$^{-1}$~s$^{-1}$. This is the same functional form as used
in the first test of paper II, but with a lower amplitude.  Still, this
heating rate is far higher than what is expected during the convective
phase of Type Ia SNe.  The heating term is added to the enthalpy
equation in the low Mach number equations in the same fashion as
described in paper II.  In this test, we do not consider reactions.
Since this is a one-dimensional test all perturbational quantities,
as well as $\Ubt,$ are zero, so we are directly testing the computation of 
$w_0$ as and the base state update as described in
the {\bf Advect Base} procedure defined above.  
Both the PPM and low Mach calculation use 768 zones in a domain $5\times
10^8$~cm high.

Figure~\ref{fig:spherical768} shows the structure of the star after
heating for 10~s.  The gray line is the initial star before any
heating.  
%The solid black line is the PPM result and the dotted and
%dashed lines are the low Mach number model with advective CFL numbers
%of $0.5$ and $0.1$ respectively (the PPM calculation used a CFL number
%of $0.5$).  
We see that the compressible and low Mach number models
agree extremely well.  Both capture the decrease in the density and
pressure at the center of the star and the considerable expansion in
radius.  Only at the surface of the star do the temperatures differ slightly.
In all calculations, we set the minimum temperature to $5\times
10^6$~K.  The PPM simulation required 13488 steps and the low Mach
(CFL $=0.5$) calculation needed 203.  Over the course of the
simulation, the Mach number of the flow remained less than $0.35$, with the
maximum Mach number occurring at the surface of the star.  This Mach
number pushes the limits of validity of the low Mach number model;  a
smaller perturbation amplitude would result in a smaller Mach number.

Future improvements to the overall spherical base-state adjustment
algorithm will address the expansion in a simulation where the medium
outside the star is not brought down to arbitrarily low densities, but
instead a ``cutoff density'' is applied, as in the case of the
plane-parallel results presented in this paper. However, we expect
the changes to the overall method shown here to be small. \MarginPar{new}

{\color{red} Add a figure showing that we retain the correct solution 
even when we place higher density material outside the star.}


\clearpage

\begin{figure*}
\begin{center}
\epsfxsize=4.0in
\epsffile{\sphericalfigpath/spherical_adjust_768.eps}
\end{center}
\caption{\label{fig:spherical768} Hydrostatic adjustment of a
spherically symmetric white dwarf with self-gravity.  The gray line
represents the initial model;  all other lines are after 10~s of heating.
The solid black line is the fully compressible solution, the dotted line is the
low Mach number solution with a CFL number of 0.5,  and the dashed line is
the low Mach number solution with a CFL number of 0.1.  All
simulations used 768 equally spaced zones.  We see excellent agreement
between the compressible and low Mach number models.  The only
differences appear at the top of the atmosphere, where the outer
boundary condition can influence the results.}
\end{figure*}


\end{document}

