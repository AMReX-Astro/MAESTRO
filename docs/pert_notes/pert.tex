
%-----------------------------------------------------------------------------
% density
%-----------------------------------------------------------------------------
\section{Density Evolution}
The full density evolution equation is
\begin{equation}
\frac{\partial\rho}{\partial t} = -\nabla\cdot(\rho\Ub) = -\Ub\cdot\nabla\rho 
- \rho\nabla\cdot\Ub. \label{rho equation}
\end{equation}
We predict both $\rho'$ and $\rho_0$ to edges and later reconstruct $\rho$.
The base state density evolution equation is
\begin{equation}
\frac{\partial\rho_0}{\partial t} = -\nabla\cdot(\rho_0 w_0 \eb_r) = 
-w_0\frac{\partial\rho_0}{\partial r} 
\underbrace{-\rho_0\frac{\partial w_0}{\partial r}}_{"\rho_0 ~ \text{force}"}.
\label{rho0 equation}
\end{equation}
Subtract (\ref{rho0 equation}) from (\ref{rho equation}) and rearrange
terms, noting that $\Ub = \Ubt + w_o\eb_r$, to obtain the
perturbational density equation,
\begin{equation}
\frac{\partial\rho'}{\partial t} = -\Ub\cdot\nabla\rho' \underbrace{- \rho'\nabla\cdot\Ub 
- \nabla\cdot(\rho_0\Ubt)}_{"\rho' ~ \text{force}"}. 
\label{rhoprime equation}
\end{equation}

\subsection{Predicting $\rho'$ at edges}
We define $\rho' = \rho^n - \rho_0^n$.  Then we predict $\rho'$ to
edges using {\tt make\_edge\_scal} in {\tt scalar\_advance} and the
underbraced term in (\ref{rhoprime equation}) as the forcing.

\subsection{Predicting $\rho_0$ at edges}\label{Predicting rho0 at edges}
There are two ways to predict $\rho_0$ at edges.
\begin{enumerate}
\item We call {\tt make\_edge\_state\_1d} using the underbraced term
in (\ref{rho0 equation}) as the forcing.  This gives us
$\rho_0^{n+\half,{\rm pred}}$.  This term is used to advect $\rho_0$
in {\tt advect\_base} and therefore must also be used to compute
$\eta_\rho$, which will be used in {\tt correct\_base}.
\item We define $\rho_0^{n+\half,{\rm avg}} = (\rho_0^n +
\rho_0^{(2)})/2$.  We compute $\rho_0^{(2)}$ from $\rho_0^n$ using
{\tt advect\_base}, which advances equation (\ref{rho0 equation})
through $\Delta t$ in time.  The $(2)$ in the superscript indicates
that we have not called {\tt correct\_base} yet, which computes
$\rho_0^{n+1}$ from $\rho_0^{(2)}$.  We use $\rho_0^{(2)}$ rather than
$\rho_0^{n+1}$ to construct $\rho_0^{n+\half,{\rm avg}}$ to be
consistent with the fact that we do not include an $\eta_\rho$
contribution to compute $\rho'$ at edges.  $\rho_0^{n+\half,{\rm
avg}}$ is used to construct $\rho$ at edges from $\rho'$ at edges, and
this $\rho$ at edges is used to compute fluxes for $\rho X_k$.
\end{enumerate}

\subsection{Computing $\rho$ at edges}\label{Computing rho at edges}
For the non-radial edges, we directly add $\rho_0^{n+\half,{\rm avg}}$
to $\rho'$ since $\rho_0^{n+\half,{\rm avg}}$ is a cell-centered
quantity.  For the radial edges, we interpolate to obtain
$\rho_0^{n+\half,{\rm avg}}$ at radial edges before adding it to
$\rho'$.

\subsection{Advancing $\rho X_k$}\label{Advancing rhoX_k}
The evolution equation for $\rho X_k$, ignoring the reaction terms
that were already accounted for in {\tt react\_state}, and the
associated discretization is
\begin{equation}
\frac{\partial\rho X_k}{\partial t} = -\nabla\cdot(\rho X_k\Ub) = 
-\nabla\cdot\left\{\left[\left(\rho_0^{n+\half,{\rm avg}} 
+ \rho'\right)X_k\right](\Ubt+w_0\eb_r)\right\}.
\end{equation}


%-----------------------------------------------------------------------------
% energy
%-----------------------------------------------------------------------------
\section{Energy Evolution}
The full enthalpy equation is
\begin{eqnarray}
\frac{\partial(\rho h)}{\partial t} &=& -\nabla\cdot(\rho h \Ub) + \frac{Dp_0}{Dt} 
+ \nabla\cdot \kth \nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext} \nonumber \\
&=& \underbrace{-\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub}_{-\nabla\cdot(\rho h\Ub)} 
+ \underbrace{\psi + (\ut \cdot \er) \frac{\partial p_0}{\partial r}}_{\frac{Dp_0}{Dt}} 
+ \nabla\cdot\kth\nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext}.
\end{eqnarray}
The full temperature equation is
\begin{equation}
\frac{\partial T}{\partial t} = -\Ub\cdot\nabla T
+ \frac{1}{\rho c_p}\left\{(1-\rho h_p)\left[\psi
+ (\ut \cdot \er )\frac{\partial p_0}{\partial r}\right] - \sum_k\rho\xi_k\dot\omega_k 
+ \rho H_{\rm nuc} + \rho H_{\rm ext}\right\}.
\end{equation}

\subsection{Predicting $(\rho h)'$ ({\tt enthalpy\_pred\_type = 1} - default)}
Due to operator splitting, the call to {\tt react\_state} has already
been made.  Hence, the goal is to compute an edge state enthalpy
starting from $(\rho h)^{(1)}$ using an enthalpy equation that does
not include the $\rho H_{\rm nuc}$ and $\rho H_{\rm ext}$ terms, where
were already accounted for in {\tt react\_state}
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub 
+ \psi + (\ut \dot \er) \frac{\partial p_0}{\partial r} + \nabla\cdot\kth\nabla T. \label{rhoh equation}
\end{equation}
We arbitrarily define a base state enthalpy evolution equation
\MarginPar{Does $\psi$ need to be included in the force?  I have
written it in the base state equation for now, even though neither the
base state or perturbational edge state prediction in the code uses
$\psi$.  How about evolving density first, then computing a
time-centered $\psi$ to be used as the energy forcing?}
\begin{eqnarray}
\frac{\partial(\rho h)_0}{\partial t} &=& -\nabla\cdot[(\rho h)_0 w_0\eb_r] 
+ \frac{D_0p_0}{Dt} \nonumber \\
&=& -w_0\frac{\partial(\rho h)_0}{\partial r} 
- \underbrace{(\rho h)_0\frac{\partial w_0}{\partial r}}_{"(\rho h)_0 ~ \text{force}"}
+ \psi.\label{rhoh0 equation}
\end{eqnarray}
Subtracting (\ref{rhoh0 equation}) from (\ref{rhoh equation}) and rearranging terms gives 
the perturbational enthalpy equation
\begin{eqnarray}
\frac{\partial(\rho h)'}{\partial t} &=& -\nabla\cdot[(\rho h)'\Ub] 
- \nabla\cdot[(\rho h)_0\Ubt] + (\ut \cdot \er)\frac{\partial p_0}{\partial r} 
+ \nabla\cdot\kth\nabla T\nonumber \\
&=& -\Ub\cdot\nabla(\rho h)' \underbrace{- (\rho h)'\nabla\cdot\Ub 
- \nabla\cdot[(\rho h)_0\Ubt] + (\ut \cdot \er)\frac{\partial p_0}{\partial r}
+ \nabla\cdot\kth\nabla T}_{"(\rho h)' ~ \text{force}"}. \label{rhohprime equation}
\end{eqnarray}

\subsubsection{Advancing $(\rho h)_0$}
{\bf Using full\_rhoh0\_evolution = F:}  Define 
$(\rho h)_0^{(1)} = \overline{(\rho h)^{(1)}}$  
and $(\rho h)' = (\rho h)^{(1)}-(\rho h)_0^{(1)}$.  Then, $(\rho h)_0^{(1)} \rightarrow$ 
{\tt advect\_base} $\rightarrow (\rho h)_0^{(2)}$.\\ \\
{\bf Using full\_rhoh0\_evolution = T:}
 Instead of defining $(\rho h)_0^{(1)} = \overline{(\rho h)^{(1)}}$, the code carries 
through the complete evolution of $(\rho h)_0$ using $(\rho h)_0^n \rightarrow$ {\tt react\_base}
$\rightarrow (\rho h)_0^{(1)} \rightarrow$ {\tt advect\_base}
$\rightarrow (\rho h)_0^{(2)} \rightarrow$ {\tt react\_base} $\rightarrow (\rho h)_0^{n+1}$.  
There is no {\tt correct\_base} function for $(\rho h)_0$ written yet, nor is any 
adjustment made to sync up $(\rho h)_0$ after the thermal diffusion step.

\subsubsection{Predicting $(\rho h)'$ at edges}\label{Predicting rhohprime at edges}
We predict $(\rho h)'$ to edges using {\tt make\_edge\_scal} in {\tt
scalar\_advance} and the underbraced term in (\ref{rhohprime
equation}) as the forcing, except that we omit the $\psi$ in the
forcing for plane-parallel, and we omit the $\partial w_0/\partial r$
part of $\psi$ in spherical.  Note that we still use full $\psi$ to
update the cell.

\subsubsection{Predicting $(\rho h)_0$ at edges}
We use an analogous procedure described in Section \ref{Predicting
rho0 at edges} to obtain $(\rho h)_0^{n+\half,\rm{pred}}$ and $(\rho
h)_0^{n+\half,\rm{avg}}$.  Note that $(\rho h)_0^{n+\half,{\rm avg}} =
[(\rho h)_0^{(1)} + (\rho h)_0^{(2)}]/2$.

\subsubsection{Computing $\rho h$ at edges}
We use an analogous procedure described in Section \ref{Computing rho
at edges} to compute $\rho h$ at edges.

\subsubsection{Advancing $\rho h$}
{\bf What the did before 8/6/08:}
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\nabla\cdot\left[(\rho h)'\left(\Ubt 
+ w_0\eb_r\right)\right] - \nabla\cdot\left[(\rho h)_0^{n+\half,{\rm avg}}\Ubt\right] 
\underbrace{- \nabla\cdot\left[(\rho h)_0^{n+\half,{\rm pred}}w_0\eb_r\right] + \psi}_{\text{this term used to come in through} ~ (\rho h)_0^{n+1} - (\rho h)_0^n} + (\ut \cdot \er)\frac{\partial p_0}{\partial r} \enskip .
\end{equation}
{\bf What the code does now:} We would like to update the non-forcing
part of the enthalpy equation analogously to Section \ref{Advancing
rhoX_k}
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\nabla\cdot(\rho h\Ub) = 
-\nabla\cdot\left\{\left[(\rho h)_0^{n+\half,{\rm avg}} 
+ (\rho h)'\right]\left(\Ubt + w_0\eb_r\right)\right\} + (\ut \cdot \er)\frac{\partial p_0}{\partial r} + \psi  \enskip .
\end{equation}


\subsection{Predicting $h$ ({\tt enthalpy\_pred\_type = 2})}

\subsection{Predicting $T$ then $(\rho h)'$ ({\tt enthalpy\_pred\_type = 3})}

\subsection{Predicting $T$ then $h$ ({\tt enthalpy\_pred\_type = 4})}

\subsection{Summary of Forcing}

\begin{table*}[h]
\begin{center}
\caption{Forcing term into {\tt make\_edge\_scal} \newline}
\begin{tabular}{c|c}
\hline
\hline
{H PRED TYPE} &   {Force} \\
\hline \\[-3mm]
1  $((\rho h)^\prime)$ &  $(\ut \cdot \er) \frac{\partial p_0}{\partial r} - 
 (\rho h)^\prime \; \nabla \cdot (\ut+w_0 \er) - 
 \nabla \cdot (\ut (\rho h)_0) + \nabla \cdot \kth \nabla T$ \\[2 mm]
2  $(h)$ & $\frac{1}{\rho} \left [\psi + (\ut \cdot \er)
  \frac{\partial p_0}{\partial r} + \nabla \cdot \kth \nabla T \right ]$ \\[2 mm]
3  $(T)$ & $\frac{1}{\rho c_p} \left \{ (1 - \rho h_p) 
   \left [\psi + (\ut \cdot \er) \frac{\partial p_0}{\partial r} \right ] \nabla \cdot \kth \nabla T \right \}$ \\[2 mm]
4  $(T)$ & $\frac{1}{\rho c_p} \left\{ (1 - \rho h_p) \left [\psi + (\ut \cdot \er)
\frac{\partial p_0}{\partial r}\right ] \nabla \cdot \kth \nabla T \right\}$ \\[2 mm]
\hline
\end{tabular}
\end{center}
\end{table*}

\begin{table*}[h]
\begin{center}
\caption{Quantity that goes into and out of {\tt make\_edge\_scal} \newline}
\begin{tabular}{c|c}
\hline
\hline
{h pred type} & {h/T } \\
\hline \\[-3mm]
1 & $(\rho h)^\prime$ \\
2 & $h$  \\
3 & $T$  \\
4 & $T$  \\
\hline
\end{tabular}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{When predicting temp ... (conversion done by {\tt makeRhoHfromT}) \newline}
\begin{tabular}{c|c|c|c}
\hline
\hline
{type} & {Inputs } & {EOS inputs} & {output} \\
\hline
3 & $X$ and $\rho^\prime$ & $\rho = \rho_0 + \rho^\prime$ &  $(\rho h)^\prime = \rho h - (\rho h)_0$ \\
   &                   & $   X = $ given & \\
   &                   &                 & \\
 4 & $X$ and $\rho^\prime$ & $\rho = \rho_0 + \rho^\prime$ & $h$ \\
   &                   & $   X = $ given & \\
   &                   &                 & \\
\hline
\end{tabular}
\end{center}
\end{table*}


\begin{table*}
\begin{center}
\caption{Quantity that goes into {\tt mkflux} on edges \newline}
\begin{tabular}{c|c|c}
\hline
\hline
{h pred type} & {Species } & {h/T } \\
\hline
1 & $X$ and $\rho^\prime$ & $(\rho h)^\prime$ \\
2 & $X$ and $\rho^\prime$ & $h$ \\
3 & $X$ and $\rho^\prime$ & $(\rho h)^\prime$ \\
4 & $X$ and $\rho^\prime$ & $h$ \\
\hline
\end{tabular}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Quantity that is created in {\tt mkflux} and passed into {\tt update\_scal}\newline\
}
\begin{tabular}{c|c|c|c|c}
       &            &              &\multicolumn{2}{c}{Forcing Term} \\
{type} & {Species } & {$(\rho h)$} & {$(\rho X)$} & {$(\rho h)$} \\
\hline 
1 & $(\ut+w_0)(\rho_0+\rho^\prime) X          $ & $(\ut+w_0)\left [(\rho h)_0 + (\rho h)^\prime\right]$ & 0 & $ \psi + (\ut \cdot \er) \frac{\partial p_0}{\partial r} $ \\[2mm]
2 & $(\ut+w_0)(\rho_0+\rho^\prime) X          $ & $(\ut+w_0) (\rho_0+\rho^\prime) h$ & 0 & $ \psi + (\ut \cdot \er) \frac{\partial p_0}{\partial r} $ \\[2mm]
3 & $(\ut+w_0)(\rho_0+\rho^\prime) X          $ & $(\ut+w_0)\left [(\rho h)_0 + (\rho h)^\prime\right]$ & 0 & $ \psi + (\ut \cdot \er) \frac{\partial p_0}{\partial r}$ \\[2mm]
4 & $(\ut+w_0)(\rho_0+\rho^\prime) X          $ & $(\ut+w_0) (\rho_0+\rho^\prime) h$ & 0 & $ \psi + (\ut \cdot \er) \frac{\partial p_0}{\partial r} $ \\[2mm]
\hline
\end{tabular}
\end{center}
\end{table*}

