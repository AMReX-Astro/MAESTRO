
%-----------------------------------------------------------------------------
% density
%-----------------------------------------------------------------------------
\section{Density Evolution}
The full density evolution equation is
\begin{eqnarray}
\frac{\partial\rho}{\partial t} &=& -\nabla\cdot(\rho\Ub) \nonumber \\
&=& -\Ub\cdot\nabla\rho - \rho\nabla\cdot\Ub. \label{rho equation}
\end{eqnarray}
We predict both $\rho'$ and $\rho_0$ to edges separately and later use them to 
reconstruct $\rho$ at edges.  The base state density evolution equation is
\begin{equation}
\frac{\partial\rho_0}{\partial t} = -\nabla\cdot(\rho_0 w_0 \eb_r) = 
-w_0\frac{\partial\rho_0}{\partial r} 
\underbrace{-\rho_0\frac{\partial w_0}{\partial r}}_{"\rho_0 ~ \text{force}"}.
\label{rho0 equation}
\end{equation}
Subtract (\ref{rho0 equation}) from (\ref{rho equation}) and rearrange
terms, noting that $\Ub = \Ubt + w_o\eb_r$, to obtain the
perturbational density equation,
\begin{equation}
\frac{\partial\rho'}{\partial t} = -\Ub\cdot\nabla\rho' \underbrace{- \rho'\nabla\cdot\Ub 
- \nabla\cdot(\rho_0\Ubt)}_{\rho' ~ \text{force}},
\label{rhoprime equation}
\end{equation}
where the underbraced "$\rho'$ force'' is computed in {\tt modify\_scal\_force}.

\subsection{Predicting $\rho'$ at edges}
We define $\rho' = \rho^{(1)} - \rho_0^n$.  Then we predict $\rho'$ to
edges using {\tt make\_edge\_scal} in {\tt scalar\_advance} and the
underbraced term in (\ref{rhoprime equation}) as the forcing.

\subsection{Predicting $\rho_0$ at edges}\label{Predicting rho0 at edges}
There are two ways to predict $\rho_0$ at edges.
\begin{enumerate}

\item We call {\tt make\_edge\_state\_1d} using the underbraced term
in (\ref{rho0 equation}) as the forcing.  This gives us
$\rho_0^{n+\myhalf,{\rm pred}}$.  This term is used to advect $\rho_0$
in {\bf Advect Base Density}.  In plane-parallel geometries, we also use
$\rho_0^{n+\myhalf,{\rm pred}}$ to compute $\etarho$, which will be used 
to compute $\psi$.

\item We define $\rho_0^{n+\myhalf,{\rm avg}} = (\rho_0^n +
\rho_0^{(2)})/2$.  We compute $\rho_0^{(2)}$ from $\rho_0^n$ using
{\bf Advect Base Density}, which advances equation (\ref{rho0 equation})
through $\Delta t$ in time.  The $(2)$ in the superscript indicates
that we have not called {\bf Correct Base} yet, which computes
$\rho_0^{n+1}$ from $\rho_0^{(2)}$.  We use $\rho_0^{(2)}$ rather than
$\rho_0^{n+1}$ to construct $\rho_0^{n+\myhalf,{\rm avg}}$ since $\rho_0^{n+1}$
is not available yet.  $\rho_0^{n+\myhalf,{\rm avg}}$ is used to construct 
$\rho$ at edges from $\rho'$ at edges, and
this $\rho$ at edges is used to compute fluxes for $\rho X_k$.
\end{enumerate}

\subsection{Computing $\rho$ at edges}\label{Computing rho at edges}
For the non-radial edges, we directly add $\rho_0^{n+\myhalf,{\rm avg}}$
to $\rho'$ since $\rho_0^{n+\myhalf,{\rm avg}}$ is a cell-centered
quantity.  For the radial edges, we interpolate to obtain
$\rho_0^{n+\myhalf,{\rm avg}}$ at radial edges before adding it to
$\rho'$.

\subsection{Advancing $\rho X_k$}\label{Advancing rhoX_k}
The evolution equation for $\rho X_k$, ignoring the reaction terms
that were already accounted for in {\tt react\_state}, and the
associated discretization is
\begin{equation}
\frac{\partial\rho X_k}{\partial t} = -\nabla\cdot(\rho X_k\Ub) = 
-\nabla\cdot\left\{\left[\left(\rho_0^{n+\myhalf,{\rm avg}} 
+ \rho'\right)X_k\right](\Ubt+w_0\eb_r)\right\}.
\end{equation}

%-----------------------------------------------------------------------------
% energy
%-----------------------------------------------------------------------------
\section{Energy Evolution}
We use {\tt enthalpy\_pred\_type} = 1, in which we predict $(\rho h)'$ at edges.
The full enthalpy equation is
\begin{eqnarray}
\frac{\partial(\rho h)}{\partial t} &=& -\nabla\cdot(\rho h \Ub) + \frac{Dp_0}{Dt} 
+ \nabla\cdot \kth \nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext} \nonumber \\
&=& \underbrace{-\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub}_{-\nabla\cdot(\rho h\Ub)} 
+ \underbrace{\psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r}}_{\frac{Dp_0}{Dt}} 
+ \nabla\cdot\kth\nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext}.
\end{eqnarray}
%The full temperature equation is
%\begin{equation}
%\frac{\partial T}{\partial t} = -\Ub\cdot\nabla T
%+ \frac{1}{\rho c_p}\left\{(1-\rho h_p)\left[\psi
%+ (\Ubt \cdot \er )\frac{\partial p_0}{\partial r}\right] - \sum_k\rho\xi_k\dot\omega_k 
%+ \rho H_{\rm nuc} + \rho H_{\rm ext}\right\}.
%\end{equation}
Due to operator splitting, the call to {\tt react\_state} has already
been made.  Hence, the goal is to compute an edge state enthalpy
starting from $(\rho h)^{(1)}$ using an enthalpy equation that does
not include the $\rho H_{\rm nuc}$ and $\rho H_{\rm ext}$ terms, where
were already accounted for in {\tt react\_state}, so our equation becomes
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub 
+ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} + \nabla\cdot\kth\nabla T. \label{rhoh equation}
\end{equation}
We define the base state enthalpy evolution equation as
\begin{eqnarray}
\frac{\partial(\rho h)_0}{\partial t} &=& -\nabla\cdot[(\rho h)_0 w_0\eb_r] 
+ \frac{D_0p_0}{Dt} \nonumber \\
&=& -w_0\frac{\partial(\rho h)_0}{\partial r} 
- \underbrace{(\rho h)_0\frac{\partial w_0}{\partial r}+ \psi}_{"(\rho h)_0 ~ \text{force}"}
\enskip .\label{rhoh0 equation}
\end{eqnarray}
Subtracting (\ref{rhoh0 equation}) from (\ref{rhoh equation}) and rearranging terms gives 
the perturbational enthalpy equation
\begin{eqnarray}
\frac{\partial(\rho h)'}{\partial t} &=& -\nabla\cdot[(\rho h)'\Ub] 
- \nabla\cdot[(\rho h)_0\Ubt] + (\Ubt \cdot \er)\frac{\partial p_0}{\partial r} 
+ \nabla\cdot\kth\nabla T\nonumber \\
&=& -\Ub\cdot\nabla(\rho h)' \underbrace{- (\rho h)'\nabla\cdot\Ub 
- \nabla\cdot[(\rho h)_0\Ubt] + (\Ubt \cdot \er)\frac{\partial p_0}{\partial r}
+ \nabla\cdot\kth\nabla T}_{"(\rho h)' ~ \text{force}"}, \label{rhohprime equation}
\end{eqnarray}
where the first two terms in $(\rho h)'$ force are computed in 
{\tt modify\_scal\_force}, and the last two terms are accounted for in
{\tt mkrhohforce}.  For spherical problems, we have found that a different 
representation of the pressure term in the $(\rho h)'$ force gives better
results, namely:
\begin{equation}
(\Ubt \cdot \er)\frac{\partial p_0}{\partial r} \equiv \Ubt\cdot\nabla p_0 = 
\nabla\cdot(\Ubt p_0) - p_0\nabla\cdot\Ubt.
\end{equation}

\subsection{Predicting $(\rho h)'$ at edges}\label{Predicting rhohprime at edges}
We define $(\rho h)' = (\rho h)^{(1)} - (\rho h)_0^n$.  Then we predict 
$(\rho h)'$ to edges using {\tt make\_edge\_scal} in {\tt scalar\_advance} 
and the underbraced term in (\ref{rhohprime equation}) as the forcing.

\subsection{Predicting $(\rho h)_0$ at edges}
We use an analogous procedure described in Section \ref{Predicting
rho0 at edges} for computing $\rho_0^{n+\myhalf,\rm{avg}}$ to obtain 
$(\rho h)_0^{n+\myhalf,\rm{avg}}$, i.e., 
$(\rho h)_0^{n+\myhalf,{\rm avg}} = [(\rho h)_0^{n} + (\rho h)_0^{n+1}]/2$.

\subsection{Computing $\rho h$ at edges}
We use an analogous procedure described in Section \ref{Computing rho
at edges} for computing $\rho$ at edges to compute $\rho h$ at edges.
However, instead of computing $(\rho h)_0$ to edges directly, we compute $\rho$
and $h$ separately, and multiply to get $(\rho h)_0$.

\subsection{Advancing $\rho h$}
We update the enthalpy analogously to the species update in 
Section \ref{Advancing rhoX_k}.  The forcing term does not include reaction
source terms accounted for in {\bf React State}.
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\nabla\cdot(\rho h\Ub) = 
-\nabla\cdot\left\{\left[(\rho h)_0^{n+\myhalf,{\rm avg}} 
+ (\rho h)'\right]\left(\Ubt + w_0\eb_r\right)\right\} + (\Ubt \cdot \er)\frac{\partial p_0}{\partial r} + \psi  \enskip .
\end{equation}

\subsection{Summary of Forcing}

\begin{table*}[h]
\begin{center}
\caption{Forcing term into {\tt make\_edge\_scal} \newline}
\begin{tabular}{c|c}
\hline
\hline
{H PRED TYPE} &   {Force} \\
\hline \\[-3mm]
1  $((\rho h)^\prime)$ &  $(\Ubt \cdot \er) \frac{\partial p_0}{\partial r} - 
 (\rho h)^\prime \; \nabla \cdot (\Ubt+w_0 \er) - 
 \nabla \cdot (\Ubt (\rho h)_0) + \nabla \cdot \kth \nabla T$ \\[2 mm]
2  $(h)$ & $\frac{1}{\rho} \left [\psi + (\Ubt \cdot \er)
  \frac{\partial p_0}{\partial r} + \nabla \cdot \kth \nabla T \right ]$ \\[2 mm]
3  $(T)$ & $\frac{1}{\rho c_p} \left \{ (1 - \rho h_p) 
   \left [\psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} \right ] \nabla \cdot \kth \nabla T \right \}$ \\[2 mm]
4  $(T)$ & $\frac{1}{\rho c_p} \left\{ (1 - \rho h_p) \left [\psi + (\Ubt \cdot \er)
\frac{\partial p_0}{\partial r}\right ] \nabla \cdot \kth \nabla T \right\}$ \\[2 mm]
\hline
\end{tabular}
\end{center}
\end{table*}

\begin{table*}[h]
\begin{center}
\caption{Quantity that goes into and out of {\tt make\_edge\_scal} \newline}
\begin{tabular}{c|c}
\hline
\hline
{h pred type} & {h/T } \\
\hline \\[-3mm]
1 & $(\rho h)^\prime$ \\
2 & $h$  \\
3 & $T$  \\
4 & $T$  \\
\hline
\end{tabular}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{When predicting temp ... (conversion done by {\tt makeRhoHfromT}) \newline}
\begin{tabular}{c|c|c|c}
\hline
\hline
{type} & {Inputs } & {EOS inputs} & {output} \\
\hline
3 & $X$ and $\rho^\prime$ & $\rho = \rho_0 + \rho^\prime$ &  $(\rho h)^\prime = \rho h - (\rho h)_0$ \\
   &                   & $   X = $ given & \\
   &                   &                 & \\
 4 & $X$ and $\rho^\prime$ & $\rho = \rho_0 + \rho^\prime$ & $h$ \\
   &                   & $   X = $ given & \\
   &                   &                 & \\
\hline
\end{tabular}
\end{center}
\end{table*}


\begin{table*}
\begin{center}
\caption{Quantity that goes into {\tt mkflux} on edges \newline}
\begin{tabular}{c|c|c}
\hline
\hline
{h pred type} & {Species } & {h/T } \\
\hline
1 & $X$ and $\rho^\prime$ & $(\rho h)^\prime$ \\
2 & $X$ and $\rho^\prime$ & $h$ \\
3 & $X$ and $\rho^\prime$ & $(\rho h)^\prime$ \\
4 & $X$ and $\rho^\prime$ & $h$ \\
\hline
\end{tabular}
\end{center}
\end{table*}

\begin{table*}
\begin{center}
\caption{Quantity that is created in {\tt mkflux} and passed into {\tt update\_scal}\newline\
}
\begin{tabular}{c|c|c|c|c}
       &            &              &\multicolumn{2}{c}{Forcing Term} \\
{type} & {Species } & {$(\rho h)$} & {$(\rho X)$} & {$(\rho h)$} \\
\hline 
1 & $(\Ubt+w_0)(\rho_0+\rho^\prime) X          $ & $(\Ubt+w_0)\left [(\rho h)_0 + (\rho h)^\prime\right]$ & 0 & $ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} $ \\[2mm]
2 & $(\Ubt+w_0)(\rho_0+\rho^\prime) X          $ & $(\Ubt+w_0) (\rho_0+\rho^\prime) h$ & 0 & $ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} $ \\[2mm]
3 & $(\Ubt+w_0)(\rho_0+\rho^\prime) X          $ & $(\Ubt+w_0)\left [(\rho h)_0 + (\rho h)^\prime\right]$ & 0 & $ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r}$ \\[2mm]
4 & $(\Ubt+w_0)(\rho_0+\rho^\prime) X          $ & $(\Ubt+w_0) (\rho_0+\rho^\prime) h$ & 0 & $ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} $ \\[2mm]
\hline
\end{tabular}
\end{center}
\end{table*}

