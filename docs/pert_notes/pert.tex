
\section{Predicting interface states}

The \maestro\ hyperbolic equations come in two forms: advective and
conservative.  The procedure for predicting interface states differs
slightly depending on which form we are dealing with.

\subsection{Advective form}

Most of the time, we are dealing with equations in advective form.
Here, a scalar, $\phi$, obeys:
\begin{equation}
\frac{\partial \phi}{\partial t} = -\Ub \cdot \nabla \phi + f
\end{equation}
where $f$ is the force.  This is the form that the perturbation
equations take, as well as the equation for $X_k$ itself.

A piecewise linear prediction of $\phi$ to the interface 
would appear as:
\begin{eqnarray}
\phi_{i+1/2,j}^{n+1/2} &=& \phi_{i,j}^n 
    + \left . \frac{\Delta x}{2} \frac{\partial \phi}{\partial x} \right |_{i,j}
    + \left . \frac{\Delta t}{2} \frac{\partial \phi}{\partial t} \right |_{i,j} \\
 &=& \phi_{i,j}^n 
    + \left . \frac{\Delta x}{2} \frac{\partial \phi}{\partial x} \right |_{i,j}
    +  \frac{\Delta t}{2} \left ( -u \frac{\partial \phi}{\partial x} 
                                         -v \frac{\partial \phi}{\partial y} + f \right ) \\
 &=& \phi_{i,j}^n + \frac{\Delta x}{2} \left ( 1 - \frac{\Delta t}{\Delta x} u \right ) 
           \frac{\partial \phi}{\partial x} 
    \underbrace{- \frac{\Delta t}{2} v \frac{\partial \phi}{\partial y}}_{\text{``transverse~term''}} + \frac{\Delta t}{2} f
\end{eqnarray}
(see the Godunov notes section for more details).  Here, the
``transverse term'' is accounted for in {\tt make\_edge\_scal}.  Any
additional forces should be added to $f$.  For the perturbation form
of equations, we add additional advection-like terms to $f$ by calling
{\tt modify\_scal\_force}.  This will be noted below.

\subsection{Conservative form}

A conservative equation takes the form:
\begin{equation}
\frac{\partial \phi}{\partial t} = -\nabla \cdot ( \phi \Ub) + f
\end{equation}
%
Now a piecewise linear prediction of $\phi$ to the interface is 
\begin{eqnarray}
\phi_{i+1/2,j}^{n+1/2} &=& \phi_{i,j}^n 
    + \left . \frac{\Delta x}{2} \frac{\partial \phi}{\partial x} \right |_{i,j}
    + \left . \frac{\Delta t}{2} \frac{\partial \phi}{\partial t} \right |_{i,j} \\
 &=& \phi_{i,j}^n 
    + \left . \frac{\Delta x}{2} \frac{\partial \phi}{\partial x} \right |_{i,j}
    +  \frac{\Delta t}{2} \left ( -\frac{\partial (\phi u)}{\partial x} 
                                  -\frac{\partial (\phi v)}{\partial y} + f \right ) \\
 &=& \phi_{i,j}^n + \frac{\Delta x}{2} \left ( 1 - \frac{\Delta t}{\Delta x} u \right ) 
           \frac{\partial \phi}{\partial x} 
    \underbrace{- \frac{\Delta t}{2} \phi \frac{\partial u}{\partial x} }_{\text{``non-advective~term''}}
                \underbrace{- \frac{\Delta t}{2} \frac{\partial (\phi v)}{\partial y}}_{\text{``transverse~term''}} + \frac{\Delta t}{2} f
\end{eqnarray}
Here the ``transverse term'' is now in conservative form, and an additional
term, the non-advective portion of the
$x$-flux (for the $x$-prediction) appears.  Both of the underbraced terms are
accounted for in {\tt make\_edge\_scal} automatically when we call it
with {\tt is\_conservative = .true.}.


%-----------------------------------------------------------------------------
% density
%-----------------------------------------------------------------------------
\section{Density Evolution}

\label{sec:pred:density}

\subsection{Basic equations}

The full density evolution equation is
\begin{eqnarray}
\frac{\partial\rho}{\partial t} &=& -\nabla\cdot(\rho\Ub) \nonumber \\
&=& -\Ub\cdot\nabla\rho - \rho\nabla\cdot\Ub \, . \label{rho equation}
\end{eqnarray}
The species are evolved according to
\begin{eqnarray}
\frac{\partial(\rho X_k)}{\partial t} &=& -\nabla\cdot(\rho\Ub X_k) + \rho \omegadot_k \nonumber \\
&=& -\Ub\cdot\nabla(\rho X_k) - \rho X_k \nabla\cdot\Ub + \rho \omegadot_k \, . \label{species equation}
\end{eqnarray}
In practice, only the species evolution equation is evolved, and the
total density is set as
\begin{equation}
\rho = \sum_k (\rho X_k)
\end{equation}
To advance $(\rho X_k)$ to the next timestep, we need to predict a
time-centered, interface state.  Algebraically, there are multiple
paths to get this interface state---we can predict $(\rho X)$ to the
edges as a single quantity, or predict $\rho$ and $X$ separately
(either in full or perturbation form).  In the notes below, we use the
subscript `{\tt edge}' to indicate what quantity was {\em predicted} to the
edges.  In \maestro, the different methods of computing $(\rho X)$ on
edges are controlled by the {\tt species\_pred\_type} parameter.  The
quantities predicted to edges and the 
resulting edge state are shown in the table~\ref{table:pred:species}

\begin{table}[h]
\centering
\caption{Summary of species edge state construction}
\label{table:pred:species}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{l|c|c}
\hline
\hline
{\tt species\_pred\_type} &   {quantities predicted} & {$(\rho X_k)$ edge state} \\[-5pt]
 & {in {\tt make\_edge\_scal}} & \\
\hline 
1 / {\tt predict\_rhoprime\_and\_X}  &  
  $\rho'_\mathrm{edge}$, $(X_k)_\mathrm{edge}$ &
  $\left(\rho_0^{n+\myhalf,{\rm avg}}  
  + \rho'_\mathrm{edge} \right)(X_k)_\mathrm{edge}$ \\
2 / {\tt predict\_rhoprime\_and\_rhoX}  &  
  $\rho'_\mathrm{edge}$, $(\rho X_k)_\mathrm{edge}$ &
  $(\rho X_k)_\mathrm{edge}$ \\
3 / {\tt predict\_rho\_and\_X}  &  
  $\rho_\mathrm{edge}$, $(X_k)_\mathrm{edge}$ &
  $\rho_\mathrm{edge} (X_k)_\mathrm{edge}$ \\
\hline
\end{tabular}
\end{table}
We note the labels {\tt predict\_rhoprime\_and\_X}, {\tt predict\_rhoprime\_and\_rhoX}, and
{\tt predict\_rho\_and\_X} are provided by the {\tt pred\_parameters}
module.




\subsection{Method 1: {\tt species\_pred\_type} = {\tt predict\_rhoprime\_and\_X}}

Here we wish to construct $(\rho_0^{n+\myhalf,{\rm avg}}        
+ \rho'_\mathrm{edge})(X_k)_\mathrm{edge}$.

We predict both $\rho'$ and $\rho_0$ to edges separately and later use them to 
reconstruct $\rho$ at edges.  The base state density evolution equation is
\begin{equation}
\frac{\partial\rho_0}{\partial t} = -\nabla\cdot(\rho_0 w_0 \eb_r) = 
-w_0\frac{\partial\rho_0}{\partial r} 
\underbrace{-\rho_0\frac{\partial w_0}{\partial r}}_{``\rho_0 ~ \text{force"}}.
\label{rho0 equation}
\end{equation}
Subtract (\ref{rho0 equation}) from (\ref{rho equation}) and rearrange
terms, noting that $\Ub = \Ubt + w_o\eb_r$, to obtain the
perturbational density equation,
\begin{equation}
\frac{\partial\rho'}{\partial t} = -\Ub\cdot\nabla\rho' \underbrace{- \rho'\nabla\cdot\Ub 
- \nabla\cdot(\rho_0\Ubt)}_{\rho' ~ \text{force}} \, .
\label{rhoprime equation}
\end{equation}

We also need $X_k$ at the edges.  Here, we subtract $X_k \times$
Eq.~\ref{rho equation} from Eq.~\ref{species equation} to obtain
\begin{equation}
\frac{\partial X_k}{\partial t} = -\Ub \cdot \nabla X_k + \omegadot_k
\end{equation}
When using Strang-splitting, we ignore the $\omegadot_k$ source terms, and
then the species equation is a pure advection equation with no force.

\subsubsection{Predicting $\rho'$ at edges}
We define $\rho' = \rho^{(1)} - \rho_0^n$.  Then we predict $\rho'$ to
edges using {\tt make\_edge\_scal} in {\tt density\_advance} and the
underbraced term in Eq.~\ref{rhoprime equation} as the forcing.  This
force is computed in {\tt modify\_scal\_force}.

\subsubsection{Predicting $\rho_0$ at edges}\label{Predicting rho0 at edges}
There are two ways to predict $\rho_0$ at edges.
\begin{enumerate}

\item We call {\tt make\_edge\_state\_1d} using the underbraced term
in (\ref{rho0 equation}) as the forcing.  This gives us
$\rho_0^{n+\myhalf,{\rm pred}}$.  This term is used to advect $\rho_0$
in {\bf Advect Base Density}.  In plane-parallel geometries, we also use
$\rho_0^{n+\myhalf,{\rm pred}}$ to compute $\etarho$, which will be used 
to compute $\psi$.

\item We define $\rho_0^{n+\myhalf,{\rm avg}} = (\rho_0^n +
\rho_0^{(2)})/2$.  We compute $\rho_0^{(2)}$ from $\rho_0^n$ using
{\bf Advect Base Density}, which advances equation (\ref{rho0 equation})
through $\Delta t$ in time.  The $(2)$ in the superscript indicates
that we have not called {\bf Correct Base} yet, which computes
$\rho_0^{n+1}$ from $\rho_0^{(2)}$.  We use $\rho_0^{(2)}$ rather than
$\rho_0^{n+1}$ to construct $\rho_0^{n+\myhalf,{\rm avg}}$ since $\rho_0^{n+1}$
is not available yet.  $\rho_0^{n+\myhalf,{\rm avg}}$ is used to construct 
$\rho$ at edges from $\rho'$ at edges, and
this $\rho$ at edges is used to compute fluxes for $\rho X_k$.
\end{enumerate}

We note that in essence these choices reflect a hyperbolic (1)
vs.\ elliptic (2) approach.  In \maestro, if we setup a problem with
$\rho = \rho_0$ initially, and enforce a constraint $\nabla \cdot
(\rho_0 \Ub) = 0$ (i.e.\ the anelastic constraint), then analytically,
we should never generate a $\rho'$.  To realize this behavior
numerically, we use $\rho_0^{n+\myhalf,{\rm avg}}$ in the prediction
of $(\rho X_k)$ on the edges to be consistent with the use of the
average of $\rho$ to the interfaces in the projection step at the end
of the algorithm.

\subsubsection{Computing $\rho$ at edges}\label{Computing rho at edges}
For the non-radial edges, we directly add $\rho_0^{n+\myhalf,{\rm avg}}$
to $\rho'$ since $\rho_0^{n+\myhalf,{\rm avg}}$ is a cell-centered
quantity.  For the radial edges, we interpolate to obtain
$\rho_0^{n+\myhalf,{\rm avg}}$ at radial edges before adding it to
$\rho'$.

\subsubsection{Predicting $X_k$ at edges}
\label{sec:pert:predict_X}
Predicting $X_k$ is straightforward.  We convert the cell-centered
$(\rho X_k)$ to $X_k$ by dividing by $\rho$ in each zone and then we
just call {\tt make\_edge\_scal} in {\tt density\_advance} on $X_k$.
The force seen by {\tt make\_edge\_scal} is 0.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Method 2: {\tt species\_pred\_type} = {\tt predict\_rhoprime\_and\_rhoX}}

Here we wish to construct $(\rho X_k)_\mathrm{edge}$ by predicting
$(\rho X_k)$ to the edges as a single quantity.  We recall
Eq.~\ref{species equation}:
\begin{equation}
\frac{\partial(\rho X_k)}{\partial t} =
  -\nabla \cdot (\rho \Ub X_k) + \rho \omegadot_k \, . \nonumber
\end{equation}
The edge state is created by calling {\tt make\_edge\_scal} in {\tt
  density\_advance} with {\tt is\_conservative = .true.}.
We do not consider the $\rho \omegadot_k$ term in the forcing when
Strang-splitting.


We note that even though it is not needed here, we still predict
$\rho'$ to the edges since certain enthalpy formulations need it.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Method 3: {\tt species\_pred\_type} = {\tt predict\_rho\_and\_X}}

Here we wish to construct $\rho_\mathrm{edge} (X_k)_\mathrm{edge}$
by predicting $\rho$ and $X_k$ to the edges separately.

Predicting $X_k$ to the edges proceeds exactly as described in
\S~\ref{sec:pert:predict_X}.  

Predicting the full $\rho$ begins with Eq.~\ref{rho equation}:
\begin{equation}
\frac{\partial\rho}{\partial t} 
= -\Ub\cdot\nabla\rho \, \underbrace{- \rho\nabla\cdot\Ub}_{``\rho~\text{force''}} \, . \label{rho equation labeled}
\end{equation}
Using this, $\rho$ is predicted to the edges using {\tt
  make\_edge\_scal} in {\tt density\_advance}, with the underbraced
force computed in {\tt modify\_scal\_force} with {\tt fullform =
  .true.}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Advancing $\rho X_k$}\label{Advancing rhoX_k}
The evolution equation for $\rho X_k$, ignoring the reaction terms
that were already accounted for in {\tt react\_state}, and the
associated discretization is \\

\noindent {\tt species\_pred\_type = predict\_rhoprime\_and\_X}:
\begin{equation}
\frac{\partial\rho X_k}{\partial t} = 
-\nabla\cdot\left\{\left[\left({\rho_0}^{n+\myhalf,{\rm avg}}
+ \rho'_\mathrm{edge} \right)(X_k)_\mathrm{edge} \right](\Ubt+w_0\eb_r)\right\}.
\end{equation} \\


\noindent {\tt species\_pred\_type = predict\_rhoprime\_and\_rhoX}:
\begin{equation}
\frac{\partial\rho X_k}{\partial t} = 
-\nabla\cdot\left\{\left[\left(\rho X_k \right)_\mathrm{edge} \right](\Ubt+w_0\eb_r)\right\}.
\end{equation} \\


\noindent {\tt species\_pred\_type = predict\_rho\_and\_X}:
\begin{equation}
\frac{\partial\rho X_k}{\partial t} = 
-\nabla\cdot\left\{\left[\rho_\mathrm{edge} (X_k)_\mathrm{edge} \right](\Ubt+w_0\eb_r)\right\}.
\end{equation}


%-----------------------------------------------------------------------------
% energy
%-----------------------------------------------------------------------------
\section{Energy Evolution}

\label{sec:pred:enthalpy}

\subsection{Basic equations}

\maestro\ solves an enthalpy equation.  
The full enthalpy equation is
\begin{eqnarray}
\frac{\partial(\rho h)}{\partial t} &=& -\nabla\cdot(\rho h \Ub) + \frac{Dp_0}{Dt} 
+ \nabla\cdot \kth \nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext} \nonumber \\
&=& \underbrace{-\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub}_{-\nabla\cdot(\rho h\Ub)} 
+ \underbrace{\psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r}}_{\frac{Dp_0}{Dt}} 
+ \nabla\cdot\kth\nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext}.
\end{eqnarray}
%The full temperature equation is
%\begin{equation}
%\frac{\partial T}{\partial t} = -\Ub\cdot\nabla T
%+ \frac{1}{\rho c_p}\left\{(1-\rho h_p)\left[\psi
%+ (\Ubt \cdot \er )\frac{\partial p_0}{\partial r}\right] - \sum_k\rho\xi_k\dot\omega_k 
%+ \rho H_{\rm nuc} + \rho H_{\rm ext}\right\}.
%\end{equation}
Due to Strang-splitting of the reactions,the call to {\tt
  react\_state} has already been made.  Hence, the goal is to compute
an edge state enthalpy starting from $(\rho h)^{(1)}$ using an
enthalpy equation that does not include the $\rho H_{\rm nuc}$ and
$\rho H_{\rm ext}$ terms, where were already accounted for in {\tt
  react\_state}, so our equation becomes
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub 
+ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} + \nabla\cdot\kth\nabla T. \label{rhoh equation}
\end{equation}
We define the base state enthalpy evolution equation as
\begin{eqnarray}
\frac{\partial(\rho h)_0}{\partial t} &=& -\nabla\cdot[(\rho h)_0 w_0\eb_r] 
+ \frac{D_0p_0}{Dt} \nonumber \\
&=& -w_0\frac{\partial(\rho h)_0}{\partial r} 
- \underbrace{(\rho h)_0\frac{\partial w_0}{\partial r}+ \psi}_{``(\rho h)_0 ~ \text{force}"}
\enskip .\label{rhoh0 equation}
\end{eqnarray}

\subsubsection{Perturbational enthalpy formulation}

Subtracting (\ref{rhoh0 equation}) from (\ref{rhoh equation}) and
rearranging terms gives the perturbational enthalpy equation
\begin{eqnarray}
\frac{\partial(\rho h)'}{\partial t} &=& -\nabla\cdot[(\rho h)'\Ub] 
- \nabla\cdot[(\rho h)_0\Ubt] + (\Ubt \cdot \er)\frac{\partial p_0}{\partial r} 
+ \nabla\cdot\kth\nabla T\nonumber \\
&=& -\Ub\cdot\nabla(\rho h)' \underbrace{- (\rho h)'\nabla\cdot\Ub 
- \nabla\cdot[(\rho h)_0\Ubt] + (\Ubt \cdot \er)\frac{\partial p_0}{\partial r}
+ \nabla\cdot\kth\nabla T}_{``(\rho h)' ~ \text{force}"}, \label{rhohprime equation}
\end{eqnarray}

\subsubsection{Temperature formulation}

Alternately, we can consider an temperature evolution equation, derived
from enthalpy, as:
\begin{equation}
\frac{\partial T}{\partial t} = -\Ub\cdot\nabla T
+ \frac{1}{\rho c_p}\left\{(1-\rho h_p)\left[\psi
+ (\Ubt \cdot \er )\frac{\partial p_0}{\partial r}\right] 
+ \nabla \cdot \kth \nabla T
- \sum_k\rho\xi_k\omegadot_k 
+ \rho H_{\rm nuc} + \rho H_{\rm ext}\right\}.
\end{equation}
Again, we neglect the reaction terms, since that will be handled during
the reaction step, so we can write this as:
\begin{equation}
\frac{\partial T}{\partial t} = -\Ub\cdot\nabla T
\underbrace{
+ \frac{1}{\rho c_p}\left\{(1-\rho h_p)\left[\psi
+ (\Ubt \cdot \er )\frac{\partial p_0}{\partial r}\right] 
+ \nabla \cdot \kth \nabla T \right \} }_{``T~\text{force''}} \, .
\label{T equation labeled}
\end{equation}

\subsubsection{Pure enthalpy formulation}

A final alternative is to consider an evolution equation for $h$
alone.  This can be derived by expanding the derivative of $(\rho h)$
in Eq.~\ref{rhoh equation} and subtracting off $h \times$ the
continuity equation (Eq.~\ref{rho equation}):
\begin{equation}
\frac{\partial h}{\partial t} = -\Ub \cdot \nabla h 
\underbrace{+ \frac{1}{\rho}
\left \{ \psi + (\Ubt \cdot \er )\frac{\partial p_0}{\partial r}
+ \nabla \cdot \kth \nabla T \right \} }_{``h~\text{force''}} \, .
\label{h equation labeled}
\end{equation}

\subsubsection{Prediction requirements}

To update the enthalpy, we need to compute an interface state for
$(\rho h)$.  As with the species evolution, there are multiple
quantities we can predict to the interfaces to form this state,
controlled by {\tt enthalpy\_pred\_type}.  A complexity of the
enthalpy evolution is that the formation of this edge state will
depend on {\tt species\_pred\_type}.  

The general procedure for making the $(\rho h)$ edge state is as follows:
\begin{enumerate}
\item predict $(\rho h)'$, $h$, or $T$ to the edges (depending on {\tt
  enthalpy\_pred\_type} ) using {\tt make\_edge\_scal} and the forces
  identified in the appropriate evolution equation
  (Eqs.~\ref{rhohprime equation}, \ref{T equation labeled}, or \ref{h
    equation labeled} respectively).

  The appropriate forces are summaried in table~\ref{table:pred:hforce}.

\item if we predicted $T$, convert this predicted
  edge state to an intermediate ``enthalpy'' state (the quotes
  indicate that it may be perturbational or full enthalpy) by calling
  the EOS.
 
\item construct the final enthalpy edge state in {\tt mkflux}.  The
  precise construction depends on what species and enthalpy quantities
  are input to {\tt mkflux}.

\end{enumerate}

\noindent Note that the various {\tt enthalpy\_pred\_type}s have only been
extensively tested with {\tt species\_pred\_type = 1}.  

Finally, when \maestro\ is run with {\tt use\_tfromp = T}, the
temperature is derived from the density, basestate pressure ($p_0$),
and $X_k$.  When run with reactions or external heating, {\tt
  react\_state} updates the temperature after the reaction/heating
term is computed.  In {\tt use\_tfromp = T} mode, the temperature will
not see the heat release, since the enthalpy does not feed in.  Only
after the hydro update does the temperature gain the effects of the
heat release due to the adjustment of the density (which in turn sees
it through the velocity field and $S$).  As a result, the {\tt
  enthalpy\_pred\_type}s that predict temperature to the interface
({\tt predict\_T\_then\_rhoprime} and {\tt predict\_T\_then\_h}) will
not work.  \maestro\ will abort if the code is run with this
combination of parameters.

Table~\ref{table:pred:hoverview}
gives a summary
of the {\tt enthalpy\_pred\_type} behavior.


\begin{table*}[h]
\centering
\caption{Forcing term into {\tt make\_edge\_scal}}
\label{table:pred:hforce}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{l|c}
\hline
\hline
{\tt enthalpy\_pred\_type} &   {advective force} \\
\hline
1 / {\tt predict\_rhohprime} $((\rho h)^\prime)$ &  
 $-(\rho h)^\prime \; \nabla \cdot (\Ubt+w_0 \er) - 
 \nabla \cdot (\Ubt (\rho h)_0) + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} + \nabla \cdot \kth \nabla T$ \\
2 / {\tt predict\_h}  $(h)$ & $\frac{1}{\rho} \left [\psi + (\Ubt \cdot \er)
  \frac{\partial p_0}{\partial r} + \nabla \cdot \kth \nabla T \right ]$ \\
3 / {\tt predict\_T\_then\_rhohprime} $(T)$ & $\frac{1}{\rho c_p} \left \{ (1 - \rho h_p) 
   \left [\psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} \right ] + \nabla \cdot \kth \nabla T \right \}$ \\
4 / {\tt predict\_T\_then\_h}  $(T)$ & $\frac{1}{\rho c_p} \left\{ (1 - \rho h_p) \left [\psi + (\Ubt \cdot \er)
\frac{\partial p_0}{\partial r}\right ] +  \nabla \cdot \kth \nabla T \right\}$ \\
\hline
\end{tabular}
\end{table*}


\begin{landscape}
\begin{table}[t]
\caption{Summary of enthalpy edge state construction}
\label{table:pred:hoverview}
\renewcommand{\arraystretch}{1.5}
{\small
\centering
\begin{tabular}{l|l|c|c|c|c}
\hline
\hline
{\tt species\_pred\_type} &   
{\tt enthalpy\_pred\_type} &
{cell-centered} &
{intermediate} &
{species quantity} &
{final $(\rho h)$} \\[-5pt]
 &
 &
{quantity predicted} &
{``enthalpy''} &
{available in} &
{edge state} \\[-5pt]
 &
 &
{in {\tt make\_edge\_scal}} &
{edge state} &
{\tt mkflux} &
 \\
\hline 
1 / {\tt predict\_rhoprime\_and\_X}  & 1 / {\tt predict\_rhohprime} &
  $(\rho h)'$ & $(\rho h)'_\mathrm{edge}$ & 
  $X_\mathrm{edge}$, $\rho'_\mathrm{edge}$ & 
  $\left [ (\rho h)_0^{n+\myhalf,{\rm avg}} + (\rho h)'_\mathrm{edge} \right ]$ \\
1 / {\tt predict\_rhoprime\_and\_X}  & 2 / {\tt predict\_h} &
  $h$ & $h_\mathrm{edge}$ & 
  $X_\mathrm{edge}$, $\rho'_\mathrm{edge}$ & 
  $\left ( \rho_0^{n+\myhalf,{\rm avg}} + \rho'_\mathrm{edge} \right ) h_\mathrm{edge}$ \\
1 / {\tt predict\_rhoprime\_and\_X}  & 3 / {\tt predict\_T\_then\_rhohprime} &
  $T$ & $(\rho h)'_\mathrm{edge}$ & 
  $X_\mathrm{edge}$, $\rho'_\mathrm{edge}$ & 
  $\left [ (\rho h)_0^{n+\myhalf,{\rm avg}} + (\rho h)'_\mathrm{edge} \right ]$ \\
1 / {\tt predict\_rhoprime\_and\_X}  & 4 / {\tt predict\_T\_then\_h} &
  $T$ & $h_\mathrm{edge}$ & 
  $X_\mathrm{edge}$, $\rho'_\mathrm{edge}$ & 
  $\left ( \rho_0^{n+\myhalf,{\rm avg}} + \rho'_\mathrm{edge} \right ) h_\mathrm{edge}$ \\
\hline
\hline
2 / {\tt predict\_rhoprime\_and\_rhoX}  & 1 / {\tt predict\_rhohprime} &
  $(\rho h)'$ & $(\rho h)'_\mathrm{edge}$ & 
  $(\rho X)_\mathrm{edge}$, $\rho'_\mathrm{edge}$ & 
  $\left [ (\rho h)_0^{n+\myhalf,{\rm avg}} + (\rho h)'_\mathrm{edge} \right ]$ \\
2 / {\tt predict\_rhoprime\_and\_rhoX}  & 2 / {\tt predict\_h} &
  $h$ & $h_\mathrm{edge}$ & 
  $(\rho X)_\mathrm{edge}$, $\rho'_\mathrm{edge}$ & 
  $\left ( \rho_0^{n+\myhalf,{\rm avg}} + \rho'_\mathrm{edge} \right ) h_\mathrm{edge}$ \\
2 / {\tt predict\_rhoprime\_and\_rhoX}  & 3 / {\tt predict\_T\_then\_rhohprime} &
  $T$ & $(\rho h)'_\mathrm{edge}$ & 
  $(\rho X)_\mathrm{edge}$, $\rho'_\mathrm{edge}$ & 
  $\left [ (\rho h)_0^{n+\myhalf,{\rm avg}} + (\rho h)'_\mathrm{edge} \right ]$ \\
2 / {\tt predict\_rhoprime\_and\_rhoX}  & 4 / {\tt predict\_T\_then\_h} &
  $T$ & $h_\mathrm{edge}$ & 
  $(\rho X)_\mathrm{edge}$, $\rho'_\mathrm{edge}$ & 
  $\left ( \rho_0^{n+\myhalf,{\rm avg}} + \rho'_\mathrm{edge} \right ) h_\mathrm{edge}$ \\
\hline
\hline
3 / {\tt predict\_rho\_and\_X}  & 1 / {\tt predict\_rhohprime} &
  $(\rho h)'$ & $(\rho h)'_\mathrm{edge}$ & 
  $X_\mathrm{edge}$, $\rho_\mathrm{edge}$ & 
  $\left [ (\rho h)_0^{n+\myhalf,{\rm avg}} + (\rho h)'_\mathrm{edge} \right ]$ \\
3 / {\tt predict\_rho\_and\_X}  & 2 / {\tt predict\_h} &
  $h$ & $h_\mathrm{edge}$ & 
  $X_\mathrm{edge}$, $\rho_\mathrm{edge}$ & 
  $\rho_\mathrm{edge} h_\mathrm{edge}$ \\
3 / {\tt predict\_rho\_and\_X}  & 3 / {\tt predict\_T\_then\_rhohprime} &
  $T$ & $(\rho h)'_\mathrm{edge}$ & 
  $X_\mathrm{edge}$, $\rho_\mathrm{edge}$ & 
  $\left [ (\rho h)_0^{n+\myhalf,{\rm avg}} + (\rho h)'_\mathrm{edge} \right ]$ \\
3 / {\tt predict\_rho\_and\_X}  & 4 / {\tt predict\_T\_then\_h} &
  $T$ & $h_\mathrm{edge}$ & 
  $X_\mathrm{edge}$, $\rho_\mathrm{edge}$ & 
  $\rho_\mathrm{edge} h_\mathrm{edge}$ \\
\hline
\end{tabular}
} % end \small
\end{table}
\end{landscape}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Method 1: {\tt enthalpy\_pred\_type} = {\tt predict\_rhohprime}}

Here we wish to construct $\left [ (\rho h)_0^{n+\myhalf,{\rm avg}} + (\rho
  h)'_\mathrm{edge} \right ]$ by predicting $(\rho h)'$ to the edges.

\subsubsection{Predicting $(\rho h)'$ at edges}\label{Predicting rhohprime at edges}

We define $(\rho h)' = (\rho h)^{(1)} - (\rho h)_0^n$.  Then we predict 
$(\rho h)'$ to edges using {\tt make\_edge\_scal} in {\tt enthalpy\_advance} 
and the underbraced term in (\ref{rhohprime equation}) as the forcing (see
also table~\ref{table:pred:hforce} for the forcing term).
The first two terms in $(\rho h)'$ force are computed in 
{\tt modify\_scal\_force}, and the last two terms are accounted for in
{\tt mkrhohforce}.  For spherical problems, we have found that a different 
representation of the pressure term in the $(\rho h)'$ force gives better
results, namely:
\begin{equation}
(\Ubt \cdot \er)\frac{\partial p_0}{\partial r} \equiv \Ubt\cdot\nabla p_0 = 
\nabla\cdot(\Ubt p_0) - p_0\nabla\cdot\Ubt.
\end{equation}



\subsubsection{Predicting $(\rho h)_0$ at edges}
We use an analogous procedure described in Section \ref{Predicting
rho0 at edges} for computing $\rho_0^{n+\myhalf,\rm{avg}}$ to obtain 
$(\rho h)_0^{n+\myhalf,\rm{avg}}$, i.e., 
$(\rho h)_0^{n+\myhalf,{\rm avg}} = [(\rho h)_0^{n} + (\rho h)_0^{n+1}]/2$.

For spherical, however, instead of computing $(\rho h)_0$ on edges
directly, we compute $\rho_0$ and $h_0$ separately at the edges, and
multiply to get $(\rho h)_0$.


\subsubsection{Computing $\rho h$ at edges}
We use an analogous procedure described in Section \ref{Computing rho
  at edges} for computing $\rho$ at edges to compute $\rho h$ at
edges.  


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Method 2: {\tt enthalpy\_pred\_type} = {\tt predict\_h}}

Here, the construction of the interface state depends on what species 
quantities are present.  In all cases, the enthalpy state is found
by predicting $h$ to the edges.


For {\tt species\_pred\_types}: {\tt predict\_rhoprime\_and\_X} or
{\tt predict\_rhoprime\_and\_rhoX}, we wish to construct $(\rho_0 +
\rho'_\mathrm{edge} ) h_\mathrm{edge}$.

For {\tt species\_pred\_types}: {\tt predict\_rho\_and\_X}, we wish to
construct $\rho_\mathrm{edge} h_\mathrm{edge}$.

\subsubsection{Predicting $h$ at edges}

We define $h = (\rho h)^{(1)}/\rho^{(1)}$.  Then we predict $h$ to edges
using {\tt make\_edge\_scal} in {\tt enthalpy\_advance} and the
underbraced term in Eq.~\ref{h equation labeled} as the forcing (see
also table~\ref{table:pred:hforce}).  This force is computed by
{\tt mkrhohforce} and then divided by $\rho$.  Note: {\tt mkrhoforce}
knows about the different {\tt enthalpy\_pred\_type}s and computes
the correct force for this type.

\subsubsection{Computing $\rho h$ at edges}

{\tt species\_pred\_types}: {\tt predict\_rhoprime\_and\_X} or
{\tt predict\_rhoprime\_and\_rhoX}:\\[1mm]
%
We use the same procedure described in Section \ref{Computing rho at
  edges} for computing $\rho_\mathrm{edge}$ from $\rho_0$ and
$\rho'_\mathrm{edge}$ and then multiply by $h_\mathrm{edge}$.

\ \\
{\tt species\_pred\_types}: {\tt predict\_rho\_and\_X}:\\[1mm]
%
We already have $\rho_\mathrm{edge}$ and simply multiply by
$h_\mathrm{edge}$.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Method 3: {\tt enthalpy\_pred\_type} = {\tt predict\_T\_then\_rhohprime}}

Here we wish to construct $\left [ (\rho h)_0 + (\rho
  h)'_\mathrm{edge} \right ]$ by predicting $T$ to the edges and then
converting this to $(\rho h)'_\mathrm{edge}$ via the EOS.

\subsubsection{Predicting $T$ at edges}

We predict $T$ to edges using {\tt make\_edge\_scal} in {\tt
  enthalpy\_advance} and the underbraced term in Eq.~\ref{T equation
  labeled} as the forcing (see also table~\ref{table:pred:hforce}).
This force is computed by {\tt mktempforce}.

\subsubsection{Converting $T_\mathrm{edge}$ to $(\rho h)'_\mathrm{edge}$}

We call the EOS in {\tt makeHfromRhoT\_edge} (called from {\tt
  enthalpy\_advance}) to convert from $T_\mathrm{edge}$ to $(\rho
h)'_\mathrm{edge}$.  For the EOS call, we need $X_\mathrm{edge}$ and
$\rho_\mathrm{edge}$.  This construction depends on {\tt
  species\_pred\_type}, since the species edge states may differ
between the various prediction types (see the ``species quantity''
column in table~\ref{table:pred:hoverview}).  The EOS inputs are
constructed as:

\begin{table*}[h]
\centering
\caption{EOS states in {\tt makeHfromRhoT\_edge}}
\label{table:pred:EOSinputs}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{l|c|c}
\hline
\hline
{\tt species\_pred\_type} & {$\rho$ edge state} &   {$X_k$ edge state}  \\
\hline
{\tt predict\_rhoprime\_and\_X} & 
  $\rho_0^{n+\myhalf,\rm{avg}} + \rho'_\mathrm{edge}$ & 
  $(X_k)_\mathrm{edge}$ \\
{\tt predict\_rhoprime\_and\_rhoX} & 
  $\sum_k (\rho X_k)_\mathrm{edge}$ & 
  $(\rho X_k)_\mathrm{edge}/\sum_k (\rho X_k)_\mathrm{edge}$ \\
{\tt predict\_rho\_and\_X} & 
  $\rho_\mathrm{edge}$ & 
  $(X_k)_\mathrm{edge}$ \\
\hline
\end{tabular}
\end{table*}

After calling the EOS, the output of {\tt makeHfromRhoT\_edge} is
$(\rho h)'_\mathrm{edge}$.

\subsubsection{Computing $\rho h$ at edges}

The computation of the final $(\rho h)$ edge state is done identically
as the {\tt predict\_rhohprime} version.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Method 4: {\tt enthalpy\_pred\_type} = {\tt predict\_T\_then\_h}}

Here, the construction of the interface state depends on what species
quantities are present.  In all cases, the enthalpy state is found by
predicting $T$ to the edges and then converting this to
$h_\mathrm{edge}$ via the EOS.

For {\tt species\_pred\_types}: {\tt predict\_rhoprime\_and\_X} or
{\tt predict\_rhoprime\_and\_rhoX}, we wish to construct $(\rho_0 +                                             \rho'_\mathrm{edge} ) h_\mathrm{edge}$.

For {\tt species\_pred\_types}: {\tt predict\_rho\_and\_X}, we wish to
construct $\rho_\mathrm{edge} h_\mathrm{edge}$.



\subsubsection{Predicting $T$ at edges}

The prediction of $T$ to the edges is done identically as the
{\tt predict\_T\_then\_rhohprime} version.


\subsubsection{Converting $T_\mathrm{edge}$ to $h_\mathrm{edge}$}

This is identical to the {\tt predict\_T\_then\_rhohprime} version,
except that on output, we compute $h_\mathrm{edge}$.

\subsubsection{Computing $\rho h$ at edges}

The computation of the final $(\rho h)$ edge state is done identically
as the {\tt predict\_h} version.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Advancing $\rho h$}
We update the enthalpy analogously to the species update in 
Section \ref{Advancing rhoX_k}.  The forcing term does not include reaction
source terms accounted for in {\bf React State}, and is the same
for all {\tt enthalpy\_pred\_type}s.
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = 
-\nabla\cdot\left\{\left \langle (\rho h) \right \rangle_\mathrm{edge}
 \left(\Ubt + w_0\eb_r\right)\right\} + (\Ubt \cdot \er)\frac{\partial p_0}{\partial r} + \psi  \enskip .
\end{equation}
where $\left \langle (\rho h) \right \rangle_\mathrm{edge}$ is the
edge state for $(\rho h)$ computed as listed in the final column of
table~\ref{table:pred:hoverview} for the given {\tt enthalpy\_pred\_type}
and {\tt species\_pred\_type}.




%% \begin{table*}[h]
%% \begin{center}
%% \caption{When predicting temp ... (conversion done by {\tt makeRhoHfromT}) \newline}
%% \begin{tabular}{c|c|c|c}
%% \hline
%% \hline
%% {type} & {Inputs } & {EOS inputs} & {output} \\
%% \hline
%% 3 & $X$ and $\rho^\prime$ & $\rho = \rho_0 + \rho^\prime$ &  $(\rho h)^\prime = \rho h - (\rho h)_0$ \\
%%    &                   & $   X = $ given & \\
%%    &                   &                 & \\
%%  4 & $X$ and $\rho^\prime$ & $\rho = \rho_0 + \rho^\prime$ & $h$ \\
%%    &                   & $   X = $ given & \\
%%    &                   &                 & \\
%% \hline
%% \end{tabular}
%% \end{center}
%% \end{table*}



%% \begin{table*}[h]
%% \begin{center}
%% \caption{Quantity that is created in {\tt mkflux} and passed into {\tt update\_scal}\newline\
%% }
%% \begin{tabular}{c|c|c|c|c}
%%        &            &              &\multicolumn{2}{c}{Forcing Term} \\
%% {type} & {Species } & {$(\rho h)$} & {$(\rho X)$} & {$(\rho h)$} \\
%% \hline 
%% 1 & $(\Ubt+w_0)(\rho_0+\rho^\prime) X          $ & $(\Ubt+w_0)\left [(\rho h)_0 + (\rho h)^\prime\right]$ & 0 & $ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} $ \\[2mm]
%% 2 & $(\Ubt+w_0)(\rho_0+\rho^\prime) X          $ & $(\Ubt+w_0) (\rho_0+\rho^\prime) h$ & 0 & $ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} $ \\[2mm]
%% 3 & $(\Ubt+w_0)(\rho_0+\rho^\prime) X          $ & $(\Ubt+w_0)\left [(\rho h)_0 + (\rho h)^\prime\right]$ & 0 & $ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r}$ \\[2mm]
%% 4 & $(\Ubt+w_0)(\rho_0+\rho^\prime) X          $ & $(\Ubt+w_0) (\rho_0+\rho^\prime) h$ & 0 & $ \psi + (\Ubt \cdot \er) \frac{\partial p_0}{\partial r} $ \\[2mm]
%% \hline
%% \end{tabular}
%% \end{center}
%% \end{table*}



%% \begin{table*}[h]
%% \begin{center}
%% \caption{Quantity that goes into and out of {\tt make\_edge\_scal} \newline}
%% \begin{tabular}{c|c}
%% \hline
%% \hline
%% {h pred type} & {h/T } \\
%% \hline \\[-3mm]
%% 1 & $(\rho h)^\prime$ \\
%% 2 & $h$  \\
%% 3 & $T$  \\
%% 4 & $T$  \\
%% \hline
%% \end{tabular}
%% \end{center}
%% \end{table*}


%% \begin{table*}
%% \begin{center}
%% \caption{Quantity that goes into {\tt mkflux} on edges \newline}
%% \begin{tabular}{c|c|c}
%% \hline
%% \hline
%% {h pred type} & {Species } & {h/T } \\
%% \hline
%% 1 & $X$ and $\rho^\prime$ & $(\rho h)^\prime$ \\
%% 2 & $X$ and $\rho^\prime$ & $h$ \\
%% 3 & $X$ and $\rho^\prime$ & $(\rho h)^\prime$ \\
%% 4 & $X$ and $\rho^\prime$ & $h$ \\
%% \hline
%% \end{tabular}
%% \end{center}
%% \end{table*}
