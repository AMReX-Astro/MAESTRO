\documentclass[11pt]{article} 

\tolerance=600

\usepackage{amsmath,color}

% Margins
\usepackage[lmargin=0.5in,rmargin=1.5in,tmargin=1.0in,bmargin=1.0in]{geometry}

\def\half  {\frac{1}{2}}

\def\eb    {{\bf e}}
\def\Ub    {{\bf U}}
\def\Ubt   {\widetilde{\bf U}}
\def\wt    {\widetilde{w}}

\title{Notes on Perturbational Quantities}

\setlength{\marginparwidth}{1.0in}
\newcommand{\MarginPar}[1]{\marginpar{%
\vskip-\baselineskip %raise the marginpar a bit
\raggedright\tiny\sffamily
\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}

\maketitle
\tableofcontents
\cleardoublepage

\section{Density Evolution}
The full density evolution equation is
\begin{equation}
\frac{\partial\rho}{\partial t} = -\nabla\cdot(\rho\Ub) = -\Ub\cdot\nabla\rho 
- \rho\nabla\cdot\Ub. \label{rho equation}
\end{equation}
\subsection{Predicting $\rho'$ (predict\_rho = F - default)}
The base state density evolution equation is
\begin{equation}
\frac{\partial\rho_0}{\partial t} = -\nabla\cdot(\rho_0 w_0 \eb_r) = 
-w_0\frac{\partial\rho_0}{\partial r} - \rho_0\frac{\partial w_0}{\partial r}.
\label{rho0 equation}
\end{equation}
Subtract (\ref{rho0 equation}) from (\ref{rho equation}) and rearrange, noting that 
$\Ub = \Ubt + w_o\eb_r$, to obtain the perturbational density equation,
\begin{equation}
\frac{\partial\rho'}{\partial t} = -\Ub\cdot\nabla\rho' \underbrace{- \rho'\nabla\cdot\Ub 
- \nabla\cdot(\rho_0\Ubt)}_{"\rho' ~ \text{force}"}. 
\label{rhoprime equation}
\end{equation}
\subsubsection{Predicting $\rho'$ at edges}
We define $\rho'^n = \rho^n - \rho_0^n$.  Then we predict $\rho'$ to edges using 
make\_edge\_scal in scalar\_advance and the underbraced term in (\ref{rhoprime equation}) 
as the forcing.
\subsubsection{Computing $\rho$ at edges}\label{Computing rho at edges}
We first compute $\rho_0^{(2)}$ from $\rho^n$ using advect\_base, which evolves 
(\ref{rho0 equation}) through $\Delta t$ in time.  The $(2)$ in the 
superscript indicates that we have not called correct\_base yet (correct\_base takes 
$\rho_0^{(2)}$ as an input and computes $\rho^{n+1}$ as the output).  We compute $\rho$ on 
edges by adding $\rho_0^{n+\half} = (\rho_0^n + \rho_0^{(2)}) / 2$ to $\rho'$ at edges.  We 
use $\rho^{(2)}$ rather than $\rho^{n+1}$ to be consistent with the fact that we did not 
include an $\eta_\rho$ contribution to compute $\rho'$ at edges.  For the non-radial edges, 
we can directly add $\rho_0^{n+\half}$ to $\rho'$ since $\rho_0^{n+\half}$ is a cell-centered 
quantity.  For the radial edges, we interpolate to obtain $\rho_0^{n+\half}$ at radial edges 
before adding it to $\rho'$.
\subsection{Predicting $\rho$ (predict\_rho = T)}
\subsubsection{Predicting $\rho$ at edges}
We predict $\rho$ to edges using make\_edge\_scal in scalar\_advance.  The forcing term 
is set to zero, but then we set is\_conservative = T to use the conservative 
discretization in make\_edge\_scal.
\subsection{Predicting $\rho_0$ (predict\_rho = T or F)}
To advect $\rho_0$ in advect\_base and to compute $\eta_\rho$ that will be used in 
correct\_base, we need $\rho_0$ at edge-centered, time-centered locations.  However, we do 
not use the same edge-centered, time-centered $\rho_0^{n+\half}$ referred to in Section 
\ref{Computing rho at edges}.  Instead, we use a $\rho_0$ computed with a Godunov method in 
make\_edge\_state\_1d.  We call make\_edge\_state\_1d using the term proportional to 
$\rho_0$ in (\ref{rho0 equation}) as the forcing.  This gives us $\rho_0^{n+\half,{\rm pred}}$.
\MarginPar{You could argue that including a time-lagged $\eta_\rho$ source term would
increase the order of accuracy, but Ann has convinced me that this term isn't necessary.}
\section{Energy Evolution}
The full enthalpy equation is
\begin{eqnarray}
\frac{\partial(\rho h)}{\partial t} &=& -\nabla\cdot(\rho h \Ub) + \frac{Dp_0}{Dt} 
+ \nabla\cdot\kappa\nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext} \nonumber \\
&=& \underbrace{-\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub}_{-\nabla\cdot(\rho h\Ub)} 
+ \underbrace{\psi + \wt\frac{\partial p_0}{\partial r}}_{\frac{Dp_0}{Dt}} 
+ \nabla\cdot\kappa\nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext}.
\end{eqnarray}
The full temperature equation is:
\begin{equation}
\frac{\partial T}{\partial t} = -\Ub\cdot\nabla T
+ \frac{1}{\rho c_p}\left\{(1-\rho h_p)\left[\psi
+ \wt\frac{\partial p_0}{\partial r}\right] - \sum_k\rho\xi_k\dot\omega_k 
+ \rho H_{\rm nuc} + \rho H_{\rm ext}\right\}.
\end{equation}
\subsection{Predicting $(\rho h)'$ (enthalpy\_pred\_type = 1 - default)}
These are working notes for how we are going to handle the energy evolution.  Due to the 
operator splitting, the call to react\_state has already been made.  Hence, the goal is to 
compute an edge state energy starting from $(\rho h)^{(1)}$ using an energy evolution 
equation that does not include terms already accounted for in react\_state
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub 
+ \psi + \wt\frac{\partial p_0}{\partial r} + \nabla\cdot\kappa\nabla T. \label{rhoh equation}
\end{equation}
We can arbitrarily define a base state enthalpy evolution equation:
\begin{eqnarray}
\frac{\partial(\rho h)_0}{\partial t} &=& -\nabla\cdot[(\rho h)_0 w_0\eb_r] 
+ \frac{D_0p_0}{Dt} \nonumber \\
&=& -w_0\frac{\partial(\rho h)_0}{\partial r} - (\rho h)_0\frac{\partial w_0}{\partial r} 
+ \psi.\label{rhoh0 equation}
\end{eqnarray}
Subtracting (\ref{rhoh0 equation}) from (\ref{rhoh equation}) gives the perturbational 
enthalpy equation:
\begin{eqnarray}
\frac{\partial(\rho h)'}{\partial t} &=& -\nabla\cdot[(\rho h)'\Ub] 
- \nabla\cdot[(\rho h)_0\Ubt] + \wt\frac{\partial p_0}{\partial r} 
+ \nabla\cdot\kappa\nabla T\nonumber \\
&=& -\Ub\cdot\nabla(\rho h)' \underbrace{- (\rho h)'\nabla\cdot\Ub 
- \nabla\cdot[(\rho h)_0\Ubt] + \wt\frac{\partial p_0}{\partial r}
+ \nabla\cdot\kappa\nabla T}_{"(\rho h)' ~ \text{force}"} \label{rhohprime equation}
\end{eqnarray}
\subsubsection{Predicting $(\rho h)'$ at edges}\label{Predicting rhohprime at edges}
We define $(\rho h)_0^{(1)} = \overline{(\rho h)^{(1)}}$  and 
$(\rho h)'^{(1)} = (\rho h)^{(1)}-(\rho h)_0^{(1)}$.  Then we predict $(\rho h)'^{(1)}$ to 
edges using make\_edge\_scal in scalar\_advance and the underbraced term in 
(\ref{rhohprime equation}) as the 
forcing.
\subsubsection{Computing $\rho h$ at edges}
We first compute $(\rho h)_0^{(2)}$ from $(\rho h)_0^{(1)}$ using advect\_base, which evolves 
(\ref{rhoh equation}) through $\Delta t$ in time.  Then we follow an analogous procedure 
used in Section \ref{Computing rho at edges} to obtain $\rho h$ at edges.
\subsection{Predicting $h$ (enthalpy\_pred\_type = 2)}
\subsection{Predicting $T$ into $(\rho h)'$ (enthalpy\_pred\_type = 3)}
\subsection{Predicting $T$ into $h$ (enthalpy\_pred\_type = 4)}
\end{document}
