\documentclass[11pt]{article} 

\tolerance=600

\usepackage{amsmath,color}

% Margins
\usepackage[lmargin=0.5in,rmargin=1.5in,tmargin=1.0in,bmargin=1.0in]{geometry}

\def\half  {\frac{1}{2}}

\def\eb    {{\bf e}}
\def\Ub    {{\bf U}}
\def\Ubt   {\widetilde{\bf U}}

\title{Notes on Perturbational Quantities}

\setlength{\marginparwidth}{1.0in}
\newcommand{\MarginPar}[1]{\marginpar{%
\vskip-\baselineskip %raise the marginpar a bit
\raggedright\tiny\sffamily
\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}

\maketitle
\tableofcontents
\cleardoublepage

\section{Density Evolution}
Full density evolution equation:
\begin{equation}
\frac{\partial\rho}{\partial t} = -\nabla\cdot(\rho\Ub). \label{rho equation}
\end{equation}
\subsection{Predict $\rho'$ (false - default)}
Base state density evolution equation:
\begin{eqnarray}
\frac{\partial\rho_0}{\partial t} &=& -\nabla\cdot(\rho_0 w_0 \eb_r) - \nabla\cdot(\eta_\rho \eb_r) \nonumber \\
&=& -w_0\frac{\partial\rho_0}{\partial r} \underbrace{- \rho_0\frac{\partial w_0}{\partial r}} - \nabla\cdot(\eta_\rho \eb_r). \label{rho0 equation}
\end{eqnarray}
Note that $\Ub = \Ubt + w_o\eb_r$.  Subtract (\ref{rho0 equation}) from (\ref{rho equation}) to give perturbational density equation:
\begin{eqnarray}
\frac{\partial\rho'}{\partial t} &=& -\nabla\cdot(\rho'\Ub) - \nabla\cdot(\rho_0\Ubt) + \nabla\cdot(\eta_\rho \eb_r) \nonumber \\
&=& -\Ub\cdot\nabla\rho' \underbrace{- \rho'\nabla\cdot\Ub - \nabla\cdot(\rho_0\Ubt)} + \nabla\cdot(\eta_\rho \eb_r).\label{rho' equation}
\end{eqnarray}
\subsubsection{Predicing $\rho'$ at edges}
We predict $\rho'$ to edges using make\_edge\_scal in scalar\_advance.  The underbraced term in (\ref{rho' equation}) is computed in modify\_scal\_force.  The $\eta_\rho$ term is not included, but this is correct because the procedure to compute $\rho$ at edges described in Section \ref{Computing rho at edges} makes use of an edge-centered, time-centered $\rho_0^{n+\half}$ that does not include an $\eta_\rho$ contribution either.
\subsubsection{Computing $\rho$ at edges}\label{Computing rho at edges}
We first compute $\rho_0^{(2)}$ using advect\_base (but not correct\_base).  We compute $\rho$ on edges by adding $\rho_0^{n+\half} = (\rho_0^n + \rho_0^{(2)}) / 2$ to $\rho'$ at edges. For the non-radial faces, we can directly add $\rho_0^{n+\half}$ since it is a cell-centered quantity.  For the radial faces, we interpolate to obtain $\rho_0^{n+\half}$ at radial faces.
\subsection{Predict $\rho$ (true)}
\subsection{$\rho_0^{n+\half,{\rm pred}}$}
To compute $\eta_\rho$, we need $\rho_0$ at edge-centered, time-centered locations.  However, we do NOT use the same edge-centered, time-centered $\rho_0^{n+\half}$ that was referred to in Section \ref{Computing rho at edges}.  Instead, we use a $\rho_0$ computed with a Godunov method in make\_edge\_state\_1d.  We call make\_edge\_state\_1d using the underbraced term in (\ref{rho0 equation}) as the forcing.  The $\eta_\rho$ term is not included.\MarginPar{I think the $\eta_\rho$ term needs to be included here.}  This gives us the so-called $\rho_0^{n+\half,{\rm pred}}$.
\section{Energy Evolution}
\subsection{Predict $(\rho h)'$ (option 1 - default)}
\subsection{Predict $h$ (option 2)}
\subsection{Predict $T$ into $(\rho h)'$ (option 3)}
\subsection{Predict $T$ into $h$ (option 4)}
\end{document}
