\documentclass[11pt]{article} 

\tolerance=600

\usepackage{amsmath,color}

% Margins
\usepackage[lmargin=0.5in,rmargin=1.5in,tmargin=1.0in,bmargin=1.0in]{geometry}

\def\half  {\frac{1}{2}}

\def\eb    {{\bf e}}
\def\Ub    {{\bf U}}
\def\Ubt   {\widetilde{\bf U}}
\def\wt    {\widetilde{w}}

\title{Notes on Perturbational Quantities}

\setlength{\marginparwidth}{1.0in}
\newcommand{\MarginPar}[1]{\marginpar{%
\vskip-\baselineskip %raise the marginpar a bit
\raggedright\tiny\sffamily
\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}

\maketitle
\tableofcontents
\cleardoublepage

\section{Density Evolution}
The full density evolution equation is
\begin{equation}
\frac{\partial\rho}{\partial t} = -\nabla\cdot(\rho\Ub) = -\Ub\cdot\nabla\rho 
- \rho\nabla\cdot\Ub. \label{rho equation}
\end{equation}
\subsection{Predicting $\rho'$ (predict\_rho = F - default)}
The base state density evolution equation is
\begin{equation}
\frac{\partial\rho_0}{\partial t} = -\nabla\cdot(\rho_0 w_0 \eb_r) = 
-w_0\frac{\partial\rho_0}{\partial r} 
\underbrace{-\rho_0\frac{\partial w_0}{\partial r}}_{"\rho_0 ~ \text{force}"}.
\label{rho0 equation}
\end{equation}
Subtract (\ref{rho0 equation}) from (\ref{rho equation}) and rearrange terms, noting that 
$\Ub = \Ubt + w_o\eb_r$, to obtain the perturbational density equation,
\begin{equation}
\frac{\partial\rho'}{\partial t} = -\Ub\cdot\nabla\rho' \underbrace{- \rho'\nabla\cdot\Ub 
- \nabla\cdot(\rho_0\Ubt)}_{"\rho' ~ \text{force}"}. 
\label{rhoprime equation}
\end{equation}
\subsubsection{Predicting $\rho'$ at edges}
We define $\rho' = \rho^n - \rho_0^n$.  Then we predict $\rho'$ to edges using 
make\_edge\_scal in scalar\_advance and the underbraced term in (\ref{rhoprime equation}) 
as the forcing.
\subsubsection{Predicting $\rho_0$ at edges}\label{Predicting rho0 at edges}
There are two ways to predict $\rho_0$ at edges.
\begin{enumerate}
\item We call make\_edge\_state\_1d using the underbraced term in 
(\ref{rho0 equation}) as the forcing.  This gives us $\rho_0^{n+\half,{\rm pred}}$.
This term is used to advect $\rho_0$ in advect\_base and therefore must also be used 
to compute $\eta_\rho$, which will be used in correct\_base.
\item We define $\rho_0^{n+\half,{\rm avg}} = (\rho_0^n + \rho_0^{(2)})/2$.  We 
compute $\rho_0^{(2)}$ from $\rho_0^n$ using advect\_base, which advances equation 
(\ref{rho0 equation}) through $\Delta t$ in time.  The $(2)$ in the superscript indicates 
that we have not called correct\_base yet, which computes  $\rho_0^{n+1}$ from $\rho_0^{(2)}$. 
We use $\rho_0^{(2)}$ rather than $\rho_0^{n+1}$ to construct $\rho_0^{n+\half,{\rm avg}}$ to be 
consistent with the fact that we do not include an $\eta_\rho$ contribution to compute 
$\rho'$ at edges.  $\rho_0^{n+\half,{\rm avg}}$ is used to construct $\rho$ at edges from 
$\rho'$ at edges, and this $\rho$ at edges is used to compute fluxes for $\rho X_k$.  
\end{enumerate}
\subsubsection{Computing $\rho$ at edges}\label{Computing rho at edges}
For the non-radial edges, we directly add $\rho_0^{n+\half,{\rm avg}}$ to $\rho'$ since 
$\rho_0^{n+\half,{\rm avg}}$ is a cell-centered quantity.  For the radial edges, we 
interpolate to obtain $\rho_0^{n+\half,{\rm avg}}$ at radial edges before adding it to $\rho'$.
\subsubsection{Advancing $\rho X_k$}\label{Advancing rhoX_k}
The evolution equation for $\rho X_k$, ignoring the reaction terms that were already 
accounted for in react\_state, and the associated discretization is
\begin{equation}
\frac{\partial\rho X_k}{\partial t} = -\nabla\cdot(\rho X_k\Ub) = 
-\nabla\cdot\left\{\left[\left(\rho_0^{n+\half,{\rm avg}} 
+ \rho'\right)X_k\right](\Ubt+w_0\eb_r)\right\}.
\end{equation}
\section{Energy Evolution}
The full enthalpy equation is
\begin{eqnarray}
\frac{\partial(\rho h)}{\partial t} &=& -\nabla\cdot(\rho h \Ub) + \frac{Dp_0}{Dt} 
+ \nabla\cdot\kappa\nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext} \nonumber \\
&=& \underbrace{-\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub}_{-\nabla\cdot(\rho h\Ub)} 
+ \underbrace{\psi + \wt\frac{\partial p_0}{\partial r}}_{\frac{Dp_0}{Dt}} 
+ \nabla\cdot\kappa\nabla T + \rho H_{\rm nuc} + \rho H_{\rm ext}.
\end{eqnarray}
The full temperature equation is
\begin{equation}
\frac{\partial T}{\partial t} = -\Ub\cdot\nabla T
+ \frac{1}{\rho c_p}\left\{(1-\rho h_p)\left[\psi
+ \wt\frac{\partial p_0}{\partial r}\right] - \sum_k\rho\xi_k\dot\omega_k 
+ \rho H_{\rm nuc} + \rho H_{\rm ext}\right\}.
\end{equation}
\subsection{Predicting $(\rho h)'$ (enthalpy\_pred\_type = 1 - default)}
Due to operator splitting, the call to react\_state has already been made.  Hence, the goal 
is to compute an edge state enthalpy starting from $(\rho h)^{(1)}$ using an enthalpy
equation that does not include the $\rho H_{\rm nuc}$ and $\rho H_{\rm ext}$ terms, where were 
already accounted for in react\_state
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\Ub\cdot\nabla(\rho h) - \rho h\nabla\cdot\Ub 
+ \psi + \wt\frac{\partial p_0}{\partial r} + \nabla\cdot\kappa\nabla T. \label{rhoh equation}
\end{equation}
We arbitrarily define a base state enthalpy evolution equation
\MarginPar{Does $\psi$ need to be included in the force?  I have written it in the base state equation for now, even though neither the base state or perturbational edge state prediction in the code uses $\psi$.  How about evolving density first,  then computing a time-centered $\psi$ to be used as the energy forcing?}
\begin{eqnarray}
\frac{\partial(\rho h)_0}{\partial t} &=& -\nabla\cdot[(\rho h)_0 w_0\eb_r] 
+ \frac{D_0p_0}{Dt} \nonumber \\
&=& -w_0\frac{\partial(\rho h)_0}{\partial r} 
- \underbrace{(\rho h)_0\frac{\partial w_0}{\partial r}}_{"(\rho h)_0 ~ \text{force}"}
+ \psi.\label{rhoh0 equation}
\end{eqnarray}
Subtracting (\ref{rhoh0 equation}) from (\ref{rhoh equation}) and rearranging terms gives 
the perturbational enthalpy equation
\begin{eqnarray}
\frac{\partial(\rho h)'}{\partial t} &=& -\nabla\cdot[(\rho h)'\Ub] 
- \nabla\cdot[(\rho h)_0\Ubt] + \wt\frac{\partial p_0}{\partial r} 
+ \nabla\cdot\kappa\nabla T\nonumber \\
&=& -\Ub\cdot\nabla(\rho h)' \underbrace{- (\rho h)'\nabla\cdot\Ub 
- \nabla\cdot[(\rho h)_0\Ubt] + \wt\frac{\partial p_0}{\partial r}
+ \nabla\cdot\kappa\nabla T}_{"(\rho h)' ~ \text{force}"}. \label{rhohprime equation}
\end{eqnarray}
\subsubsection{Predicting $(\rho h)'$ at edges}\label{Predicting rhohprime at edges}
{\bf What the code is currently doing:}\MarginPar{Do we need to change this?}
 Instead of defining $(\rho h)_0^{(1)} = \overline{(\rho h)^{(1)}}$, the code carries 
through the complete evolution of $(\rho h)_0$ using $(\rho h)_0^n \rightarrow$ react\_base 
$\rightarrow (\rho h)_0^{(1)} \rightarrow$ advect\_base 
$\rightarrow (\rho h)_0^{(2)} \rightarrow$ react\_base $\rightarrow (\rho h)_0^{n+1}$.  
There is no correct\_base function for $(\rho h)_0$ written yet, nor is any adjustment made 
to sync up $(\rho h)_0$ after the thermal diffusion step.\\ \\
{\bf What I'd like to do:}  Define $(\rho h)_0^{(1)} = \overline{(\rho h)^{(1)}}$  and 
$(\rho h)' = (\rho h)^{(1)}-(\rho h)_0^{(1)}$.  Then we predict $(\rho h)'$ to 
edges using make\_edge\_scal in scalar\_advance and the underbraced term in 
(\ref{rhohprime equation}) as the forcing.
\subsubsection{Predicting $(\rho h)_0$ at edges}
We use an analogous procedure described in Section \ref{Predicting rho0 at edges} to 
obtain $(\rho h)_0^{n+\half,\rm{pred}}$ and $(\rho h)_0^{n+\half,\rm{avg}}$.  Note that 
$(\rho h)_0^{n+\half,{\rm avg}} = [(\rho h)_0^{(1)} + (\rho h)_0^{(2)}]/2$.
\subsubsection{Computing $\rho h$ at edges}
We use an analogous procedure described in Section \ref{Computing rho at edges} to compute
$\rho h$ at edges.
\subsubsection{Advancing $\rho h$}
{\bf What the code is currently doing:}\MarginPar{Do we need to change this?}
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\nabla\cdot\left[(\rho h)'\left(\Ubt 
+ w_0\eb_r\right)\right] - \nabla\cdot\left[(\rho h)_0^{n+\half,{\rm avg}}\Ubt\right] 
- \nabla\cdot\left[(\rho h)_0^{n+\half,{\rm pred}}w_0\eb_r\right].
\end{equation}
{\bf What we would do to be consistent with density:} We would like to update the 
non-forcing part of the enthalpy equation analogously to Section \ref{Advancing rhoX_k}
\begin{equation}
\frac{\partial(\rho h)}{\partial t} = -\nabla\cdot(\rho h\Ub) = 
-\nabla\cdot\left\{\left[(\rho h)_0^{n+\half,{\rm avg}} 
+ (\rho h)'\right]\left(\Ubt + w_0\eb_r\right)\right\}.
\end{equation}

\end{document}
