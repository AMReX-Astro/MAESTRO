\documentclass[11pt]{article} 

\tolerance=600

\usepackage{amsmath,color}

% Margins
\usepackage[lmargin=0.5in,rmargin=1.5in,tmargin=0.5in,bmargin=0.5in]{geometry}

\def\half   {\frac{1}{2}}

\def\eb         {{\bf e}}
\def\ib         {{\bf i}}
\def\Ub         {{\bf U}}

\newcommand{\Ubt}{\widetilde{\Ub}}

\def\etarho     {\eta_\rho}
\def\etarhocc   {\etarho^{\rm cc}}
\def\etarhoflux {\etarho^{\rm flux}}
\def\divetarho  {\nabla\cdot(\etarho\eb_r)}



\title{Notes on $\etarho$}

\setlength{\marginparwidth}{1.0in}
\newcommand{\MarginPar}[1]{\marginpar{%
\vskip-\baselineskip %raise the marginpar a bit
\raggedright\tiny\sffamily
\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}

\maketitle
\tableofcontents
\clearpage

We carry around three different 1D radial quantities: $\etarho$ (edge-centered), $\etarhocc$ (cell-centered), and $\divetarho$ (edge-centered).  These notes discuss when each of these is used, and how they are computed, in both plane-parallel and spherical.

\section{Flow Chart}
\begin{enumerate}
\item Enter {\tt advance} with $[\etarho, \etarhocc, \divetarho]^{n-\half}$.
\item Call {\tt make\_w0}.  The spherical version uses uses $\etarho$ and $\etarhocc$.
\item Call {\tt density\_advance}.  The plane-parallel version computes $\etarhoflux$.
\item Call {\tt correct\_base}, which uses $\divetarho$.
\item Compute $[\etarho, \etarhocc, \divetarho]^{n+\half,*}$.
\item Call {\tt make\_psi}.  The plane-parallel version uses $\etarhocc$.
\item Call {\tt make\_w0}.  The spherical version uses uses $\etarho$ and $\etarhocc$.
\item Call {\tt density\_advance}.  The plane-parallel version computes $\etarhoflux$.
\item Call {\tt correct\_base}, which uses $\divetarho$.
\item Compute $[\etarho, \etarhocc, \divetarho]^{n+\half}$.
\item Call {\tt make\_psi}.  The plane-parallel version uses $\etarhocc$.
\end{enumerate}

\section{Computing $\etarho, \etarhocc$, and $\divetarho$}
This is done in {\tt make\_eta.f90}.
\subsection{Plane-Parallel}
We first compute a radial edge-centered multifab, $\eta_{\rho}^{\rm flux}$, using
\begin{equation}
\eta_{\rho,\ib+\half\eb_r}^{\rm flux} = \left[\left(\Ub_{\ib+\half\eb_r}^{n+\half}\cdot\eb_r\right) + w_{0,r+\half}^{n+\half}\right] \rho_{\ib+\half\eb_r}^{n+\half} - w_{0,r+\half}^{n+\half}\rho_{0,r+\half}^{n+\half, {\rm pred}}
\end{equation}
$\etarho$ is the edge-centered ``average'' value of $\eta_{\rho}^{\rm flux}$,
\begin{equation}
\eta_{\rho,r+\half} = \overline{\eta_{\rho,\ib+\half\eb_r}^{\rm flux}}
\end{equation}
$\etarhocc$ is a cell-centered average of $\etarho$,
\begin{equation}
\eta_{\rho,r}^{\rm cc} = \frac{\eta_{\rho,r+\half} + \eta_{\rho,r-\half}}{2}.
\end{equation}
$\divetarho$ is the cell-centered divergence of $\etarho$,
\begin{equation}
\left[\divetarho\right]_r = \frac{\eta_{\rho,r+\half} - \eta_{\rho,r-\half}}{\Delta r}.
\end{equation}
\subsection{Spherical}
First, construct $\eta_{\rho}^{\rm cart} = [\rho'(\Ubt\cdot\eb_r)]^{n+\half}$.  Then, $\etarhocc$ is the cell-centered average of $\eta_{\rho}^{\rm cart}$,
\begin{equation}
\etarhocc = \overline{\eta_{\rho}^{\rm cart}}.
\end{equation}
On interior faces, $\etarho$ is the average of $\etarhocc$,
\begin{equation}
\eta_{\rho,r+\half} = \frac{\eta_{\rho,r}^{\rm cc} + \eta_{\rho,r+1}^{\rm cc}}{2}.
\end{equation}
At the upper and lower boundaries, we use
\begin{eqnarray}
\eta_{\rho,0} &=& 0, \\
\eta_{\rho,{\rm nr}} &=& \eta_{\rho,{\rm nr}-1}^{\rm cc}.
\end{eqnarray}
$\divetarho$ is the cell-centered average of $\rho'^{n+1}$,
\begin{equation}
\divetarho = \overline{\rho'^{n+1}}
\end{equation}
\section{Using $\etarho$}
\subsection{Plane-Parallel}
NOT USED.
\subsection{Spherical}
In {\tt make\_w0}
\section{Using $\etarhocc$}
\subsection{Plane-Parallel}
In {\tt make\_psi}
\subsection{Spherical}
In {\tt make\_w0}
\section{Using $\divetarho$}
\subsection{Plane-Parallel}
In {\tt correct\_base}
\subsection{Spherical}
In {\tt correct\_base}

\end{document}
